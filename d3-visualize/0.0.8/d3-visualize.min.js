// d3-visualize Version 0.0.8. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-canvas-transition"),require("object-assign"),require("d3-array"),require("d3-random"),require("d3-collection"),require("d3-let"),require("d3-view"),require("d3-dsv"),require("d3-dispatch"),require("crossfilter"),require("d3-format"),require("d3-time-format"),require("d3-selection"),require("d3-shape")):"function"==typeof define&&define.amd?define(["exports","d3-canvas-transition","object-assign","d3-array","d3-random","d3-collection","d3-let","d3-view","d3-dsv","d3-dispatch","crossfilter","d3-format","d3-time-format","d3-selection","d3-shape"],e):e(t.d3={},t.d3,t.assign,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.crossfilter,t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,i,n,r,a,o,s,l,u,d,c,h,f,p){"use strict";function m(t){var e=(t.headers.get("content-type")||"").split(";")[0];return"text/plain"===e||"text/csv"===e?t.text().then(l.csvParse):"application/json"===e?t.json():(W("Cannot load content type '"+e+"'"),[])}function g(t,e,i,n){var r=n.dataName(o.pop(i,"name")),a=d();Object.defineProperties(t,{cf:{get:function(){return a}},name:{get:function(){return r}},store:{get:function(){return n}},type:{get:function(){return e}},config:{get:function(){return i}}}),t.initialise(i),n.sources.set(r,t),G.call("init",void 0,t)}function v(t,e){var i=void 0;return e?(e.forEach(function(e){i=e(t),t=i||t}),t):t}function w(t){var e=a.map();Object.defineProperties(this,{sources:{get:function(){return e}}}),this.transforms=i({},Z),this.dataCount=0,this.model=t}function y(t,e){return"string"==typeof t&&t.indexOf("%")===t.length-1?ut(.01*parseFloat(t)*e):+t}function b(t,e){var i={width:e.width,height:e.height};return i.width||(i.width=C(t),i.width?i.widthElement=x(t):i.width=dt),i.height||(i.height=P(t),i.height?i.heightElement=D(t):i.height=ct),"string"==typeof i.height&&i.height.indexOf("%")===i.height.length-1&&(i.heightPercentage=.01*parseFloat(i.height),i.height=ut(i.heightPercentage*i.width)),i}function C(t){var e=S(t,"width");if(e)return O(e)}function P(t){var e=S(t,"width");if(e)return j(e)}function x(t){return S(t,"width")}function D(t){return S(t,"height")}function O(t){var e=t.getBoundingClientRect().width,i=f.select(t);return e-E(i.style("padding-left"))-E(i.style("padding-right"))}function j(t){var e=t.getBoundingClientRect().height,i=f.select(t);return e-E(i.style("padding-top"))-E(i.style("padding-bottom"))}function S(t,e){for(var i=t.node?t.node():t;i&&"BODY"!==i.tagName;){if(i.getBoundingClientRect()[e])return i;i=i.parentNode}}function E(t){return t&&"px"==t.substring(t.length-2)?+t.substring(0,t.length-2):0}function z(t){var e,i=t.widthElement?C(t.widthElement):t.width;return e=t.heightPercentage?ut(i*t.heightPercentage,0):t.heightElement?P(t.heightElement):t.height,t.minHeight&&(e=Math.max(e,t.minHeight)),[ut(i),ut(e)]}function k(t,e){function n(t){var e=this.initialise(t);Object.defineProperties(this,{element:{get:function(){return e}},sel:{get:function(){return f.select(e)}}})}return n.prototype=i({},gt,e),nt.papers[t]=n,n}function q(t){return t}function A(t){var e=t.model.dataStore,i=o.pop(t.options,"data");e||(e=new w(t.model),t.model.dataStore=e),e.addSources(i)}function F(t){var e=t.model.dataStore,i=o.pop(t,"data");i&&(o.isString(i)&&(i={source:i}),i.name||(i.name=t.model.uid),i=e.addSources(i),i?t.model.$set("data",i.name):lt("Could not create data source "+i.name))}function M(t,e){var i=e.options[t];if(void 0!==i&&!o.isObject(i)){var n=i||0;e.options[t]={left:n,right:n,top:n,bottom:n}}}function R(t,e,i){return Ot.reduce(function(n,r){return n[r]=y(t[r],jt.indexOf(r)>-1?e:i),n},{})}function T(t){return new t}function $(t,e){var n=t.records,r=t.data,a=t.model,o=e,s=void 0,l=void 0;e=o.splice(0,100),e.forEach(function(t){t.id?(s=t.id?n[t.id]:null,s?t=i(s,t):(r.push(t),n[t.id]=t)):r.push(t),a.columns.forEach(function(e){t[e.name]=e.$parse(t[e.name])})}),t.sel.select("tbody").selectAll("tr").data(r).enter().append("tr").attr("scope","row").selectAll("td").data(a.columns).enter().append("td").style("display",function(t){return t.hidden?"none":null}).html(function(t){return s=this.parentNode.__data__,l=s[t.name],t.$html(void 0===l?"":l)})}function _(t,e){var i=p[B(e)];return i||(lt('Could not locate curve type "'+e+'"'),e=B(t.defaults().curveName),i=p[e]),i}function B(t){return"curve"!==t.substring(0,5)&&(t="curve"+t[0].toUpperCase()+t.substring(1)),t}i=i&&i.hasOwnProperty("default")?i.default:i,d=d&&d.hasOwnProperty("default")?d.default:d;var N={sigma:.1,drift:0},V=function(t,e){e=i({},N,e);for(var a,o=n.range(0,+t,1),s=e.sigma,l=e.drift,u=[{x:0,y:0}],d=r.randomNormal(0,1),c=1;c<o.length;c++)a=l+s*d(),u[c]={x:c,y:u[c-1].y+a};return u},L={initialise:function(t){this._data=t.data},getConfig:function(t){return o.isArray(t)?{data:t}:o.isObject(t)&&o.isArray(t.data)?t:void 0},getData:function(){return s.resolvedPromise(this.asFrame(this._data))}},W=function(t){s.viewProviders.logger.warn("[d3-data-source] "+t)},H=["http","https","ws","wss"],U=function(t){return o.isString(t)&&H.indexOf(t.split("://")[0])>-1},Y={getConfig:function(t){return U(t)?{url:t}:o.isObject(t)&&t.url?t:void 0},getData:function(){var t=s.viewProviders.fetch;return t?t(this.url).then(m):void W("fetch provider not available, cannot submit")}},I={getConfig:function(t){if(o.isObject(t)&&t.source)return o.isArray(t.source)||(t.source=[t.source]),t},getData:function(){var t=this.store;return Promise.all(this.source.map(function(e){return t.getData(e)})).then(function(t){return t.length,t[0]})}},X={initialise:function(t){this.expression=s.viewExpression(t.expression)},getConfig:function(t){if(o.isObject(t)&&t.expression)return t},getData:function(){var t=this,e=this.store.model;return s.resolvedPromise(this.expression.eval(e)).then(function(e){return t.asFrame(e)})}},G=u.dispatch("init","data"),J={getConfig:function(){},initialise:function(t){i(this,t)},getData:function(){},asFrame:function(t){return t=t.map(function(t){return t.constructor!==Object&&(t={data:t}),t}),d(t)}},K=i(a.map(),{events:G,add:function(t,e){function n(e,i){g(this,t,e,i)}return n.prototype=i({},J,e),this.set(t,n),n},create:function(t,e){for(var i,n=this.values(),r=0;r<n.length;++r)if(i=n[r].prototype.getConfig(t))return new n[r](i,e)}}),Q=function(t){function e(e){return e.groupby(t.field)}return e},Z={groupby:Q};K.add("array",L),K.add("remote",Y),K.add("composite",I),K.add("expression",X),w.prototype={size:function(){return this.sources.size()},addSources:function(t){if(o.isString(t)&&(t={source:t}),o.isArray(t)){var e=this;return t.map(function(t){return K.create(t,e)})}if(t)return K.create(t,this)},addTransforms:function(t){i(this.transforms,t)},source:function(t,e){if(1===arguments.length)return this.sources.get(t);if(null===e){var i=this.sources.get(t);return this.sources.remove(t),i}return this.sources.set(t,e),this},clearCache:function(){this.sources.each(function(t){delete t.cachedFrame})},getData:function(t){var e=this.sources.get(t);if(!e)throw new Error("Data source "+t+" not available");return e.cachedFrame?s.resolvedPromise(e.cachedFrame):e.getData().then(function(t){return e.cachedFrame=t,t})},dataName:function(t){return this.dataCount++,t?""+t:this.source("default")?"source"+this.dataCount:"default"}};var tt={formatDate:h.timeFormat("%d/%m/%Y"),formatDateTime:h.timeFormat("%a %e %b %X %Y"),load:function(t){var e=this,i=K.create("https://unpkg.com/d3-format/locale/"+t+".json"),n=K.create("https://unpkg.com/d3-time-format/locale/"+t+".json");return Promise.all([i.load().then(function(i){e.symbol=t,e.number=i,c.formatDefaultLocale(i)}),n.load().then(function(t){e.time=t,e.formatDate=h.timeFormat(t.date),e.formatDateTime=h.timeFormat(t.dateTime),h.timeFormatDefaultLocale(t)})])}},et={dataSource:null,size:{width:null,height:"70%"}},it=["visual","container"],nt={live:[],types:{},papers:{},events:u.dispatch("before-init","after-init","before-draw","after-draw")},rt=i({},{initialise:function(){},draw:function(){},select:function(t){return f.select(t)},destroy:function(){},getModel:function(t){var e=this.model[t];if(!e&&t in et){var i=o.pop(this.options,t);this.visualParent?e=this.visualParent.getModel(t).$child(i):(e=this.model.$new(et[t]),e.$update(i)),this.model[t]=e}return e}},s.viewBase),at=function(t,e){function n(e,i,n){Object.defineProperties(this,{visualType:{get:function(){return t}},isViz:{get:function(){return-1===it.indexOf(t)}}}),this.options=i||{},nt.events.call("before-init",void 0,this),this.initialise(e,n),nt.events.call("after-init",void 0,this)}var r=o.pop(e,"options");return r&&(et[t]=r),n.prototype=i({},rt,e),nt.types[t]=n,n},ot={initialise:function(t,e){e||(e=s.viewModel()),this.model=e,this.visualParent=e.visualParent}},st=at("container",ot),lt=function(t){s.viewProviders.logger.warn("[d3-visualize] "+t)},ut=function(t,e){return e?Math.round(t*(e=Math.pow(10,e)))/e:Math.round(t)},dt=400,ct="75%",ht=at("visual",i({},ot,{options:{render:"svg",width:null,height:"70%"},initialise:function(t,e){if(!t)throw new Error("HTMLElement required by visual group");this.select(t).classed("d3-visual",!0),ot.initialise.call(this,t,e),this.layers=[],this.drawCount=0,nt.live.push(this),Object.defineProperties(this,{element:{get:function(){return t}},sel:{get:function(){return f.select(t)}},size:{get:function(){return[this.width,this.height]}}})},draw:function(){this.drawCount?(this.drawCount++,this.clear()):(this.drawCount=1,this.fit()),nt.events.call("before-draw",void 0,this),this.layers.forEach(function(t){t.draw()}),nt.events.call("after-draw",void 0,this)},clear:function(){},addVisual:function(t){var e=o.pop(t,"type"),i=nt.types[e];if(i)return this.model.visualParent=this,new i(this.element,this.model);lt("Cannot add visual "+t.type)},fit:function(){var t=b(this.element.parentNode,this.getModel("visual"));this.width=t.width,this.height=t.height,this.sel.style("width",this.width+"px").style("height",this.height+"px")},resize:function(t){t||(t=z(this));var e=this.size;e[0]===t[0]&&e[1]===t[1]||(s.viewDebug('Resizing visual "'+this.model.uid+'"'),this.width=t[0],this.height=t[1],this.draw())},destroy:function(){var t=nt.live.indexOf(this);t>-1&&(nt.live.splice(t,1),this.visuals.forEach(function(t){return t.destroy()}))}})),ft=function(t,e){return at(t,i({},pt,mt,e))},pt={initialise:function(t,e){var i=e?e.visualParent:null;i&&"visual"===i.visuatlType||(i=new ht(t,this.options,e),this.options={}),this.visualParent=i,this.model=i.model.$child(),i.layers.push(this)},paper:function(){var t=this.getModel("visual"),e=this._paper;if(e&&e.type===t.render)return e;var i=nt.papers[t.render];if(!i)throw new Error("Unknown paper "+t.render);return e=new i(this),this._paper=e,e},translate:function(t,e){return o.isFunction(t)?function(i){return"translate("+(t(i)||0)+", "+(e(i)||0)+")"}:"translate("+t+", "+e+")"}},mt={draw:function(){var t=this;nt.events.call("before-draw",void 0,this);var e=this;this.getData().then(function(i){i&&(i=v(i,e.transforms),t.doDraw(i),nt.events.call("after-draw",void 0,t))})}},gt={initialise:function(){},transition:function(){},dim:function(t){return t}},vt=k("svg",{initialise:function(t){return t.visualParent.sel.append("svg").attr("id",t.model.uid).classed(t.visualType,!0).node()}}),wt={props:["schema","datasource","plugins"],render:function(t,e,i){var n=this,r=this.select(i).html();return this.getSchema(t.schema,function(t){return o.isObject(t)||(t={}),n.build(t,r,e)})},getSchema:function(t,e){var i=this.model.visualParent;if(i&&i!==this.model&&o.isString(t)){var n=i.options.visuals[t];n&&(t=n)}return o.isString(t)?this.json(t).then(e):e(t)},build:function(){}},yt=i({},wt,{build:function(t,e,i){var n=this.model,r=this.createElement("div");return i.class&&r.attr("class",i.class),t.visuals||(t.visuals={}),n.visualParent=new st(r.node(),t,n),this.mountInner(r,e)}}),bt=i({},wt,{build:function(t){var e=this.model,i=this.createElement("div"),n=o.pop(t,"type")||"visual",r=nt.types[n];if(r){var a=new r(i.node(),t,e);e.visualParent=a.isViz?a.visualParent:a}else lt("Unknown visual "+n);return i},mounted:function(){this.model.visualParent&&this.model.visualParent.draw()}}),Ct={date:h.isoParse,string:function(t){return""+t}},Pt={number:function(t){return t},date:function(t){return tt.formatDate(t)},boolean:function(t){return t}},xt=function(t){var e=[],i=void 0;if(!t)return e;if(o.isArray(t)&&(t={properties:t}),o.isObject(t.properties))for(var n in t.properties)i=t.properties[n],o.isObject(i)&&(i.name||(i.name=n),e.push(i));else Array.prototype.push.apply(e,t.properties);return e.map(function(t){return o.isObject(t)||(t={name:t}),t.label||(t.label=t.name),t.hidden||(t.hidden=!1),t.$parse||(t.$parse=Ct[t.type]||Ct.string),t.$html||(t.$html=Pt[t.type]||q),t})};if(pt.getData=function(){var t=this.model.data;return t?this.model.dataStore.getData(t):(lt("Visual without data name, cannot get data"),s.resolvedPromise())},nt.events.on("before-init.data",function(t){t.isViz&&(t.data=o.pop(t.options,"data"))}),nt.events.on("after-init.data",function(t){t.isViz?F(t):A(t)}),et.resizeDelay||(et.resizeDelay=200),o.inBrowser){var Dt=s.viewDebounce(function(){nt.live.forEach(function(t){return t.resize()})},et.resizeDelay);f.select(window).on("resize.visuals",Dt)}et.title={text:null,fontSize:"10px"},nt.events.on("after-init.title",function(t){var e=t.options.title;o.isString(e)&&(t.options.title={text:e})});var Ot=["top","bottom","left","right"],jt=["left","right"];et.margin={top:20,bottom:20,left:20,right:20},et.padding={top:0,bottom:0,left:0,right:0},pt.boundingBox=function(){var t=this.visualParent.width,e=this.visualParent.height,i=R(this.getModel("margin"),t,e),n=R(this.getModel("padding"),t,e),r=Ot.reduce(function(t,e){return t[e]=i[e]+n[e],t},{});return{width:t,height:e,margin:i,padding:i,total:r,innerWidth:t-r.left-r.right,innerHeight:t-r.top-r.bottom}},nt.events.on("after-init.margin",function(t){t.margin=M("margin",t),t.padding=M("padding",t)}),et.color={scale:"cool"},pt.colorScale=function(){return this.getModel("color")};var St=function(t,e){return t.require("clusterize.js@0.17.6").then(function(t){return T(t)})},Et=function(t){return t},zt={over:!0,small:!0,bordered:!0,loadingClass:"table-info",loadingTextClass:"text-center"},kt=function(t,e){var n=t.model.style;n.$update(i({},zt,e)),n.tableClass="table table-responsive",n.striped&&(n.tableClass+=" table-striped"),n.over&&(n.tableClass+=" table-hover"),n.bordered&&(n.tableClass+=" table-bordered"),n.small&&(n.tableClass+=" table-sm")},qt={bootstrap:kt,clusterize:St,paginate:Et},At=i({},wt,{model:function(){return{header:!0,columns:[],loadingData:!1,style:{tableClass:null,headerClass:null,headerRowClass:null,loadingClass:"loading",loadingTextClass:null}}},build:function(t){var e=this,i=this.model,n=t.plugins||[];if(this.records={},this.data=[],this.template='<table d3-class="[style.tableClass, loadingData ? \'loading\' : null]">\n<thead d3-class="style.headerClass">\n<tr d3-class="style.headerRowClass">\n  <th d3-for="col in columns"\n        d3-html="col.label"\n        d3-if="!col.hidden">\n  </th>\n</tr>\n<tr d3-if="loadingData" d3-class="style.loadingClass">\n    <td d3-attr-colspan="columns.length">\n        <p d3-class="style.loadingTextClass">loading data</p>\n    </td>\n</tr>\n</thead>\n<tbody></tbody>\n</table>',i.columns=xt(t),o.isArray(n)){var r=[],a=void 0;if(n.forEach(function(t){o.isString(t)&&(t={name:t}),qt[t.name]?(a=qt[t.name](e,t),o.isPromise(a)&&r.push(a)):lt("Unknown table plugin "+t.name)}),r.length)return Promise.all(r).then(function(){return e.viewElement(e.template)})}else lt("plugins should be an array");return this.viewElement(this.template)},mounted:function(){var t=this,e=this.model;if(e.dataLoader){var i=e.dataLoader.load(e.columns);i&&(e.loadingData=!0,i.then(function(i){e.loadingData=!1,$(t,i)},function(t){return e.loadingData=!1,t}))}}}),Ft={tabularPlugins:qt,install:function(t){t.addComponent("dashboard",yt),t.addComponent("visual",bt),t.addComponent("tabular",At)}},Mt=ft("barchart",{options:{orientation:"vertical",stack:!1},doDraw:function(){}}),Rt=ft("linechart",{options:{lineWidth:1,colorOpacity:1,curve:"cardinalOpen"},doDraw:function(){var t=this.series,e=this.aesthetics,i=this.plot.path(this).data([t]),n=this.scaled(this.mapping.x,this.plot,t),r=this.scaled(this.mapping.y,this.plot,t),a=p.line().x(n).y(r).curve(_(this,e.curve)),o=this.plot.dim(e.lineWidth),s=this.plot.transition("update");i.enter().append("path").attr("class","line").attr("fill","none").attr("stroke",e.color).attr("stroke-opacity",0).attr("stroke-width",o).merge(i).transition(s).attr("stroke",e.color).attr("stroke-opacity",e.colorOpacity).attr("stroke-width",o).attr("d",a),i.exit().remove()}}),Tt=Math.PI,$t=Tt/180,_t=ft("piechart",{options:{field:null,startAngle:0,endAngle:360,sort:!1,innerRadius:0,padAngle:0,cornerRadius:0,color:null,lineWidth:1,colorOpacity:1,fillOpacity:1},doDraw:function(t){var e=this.model,i=e.colorScale,n=this.boundingBox(),r=n.innerWidth/2,a=e.innerRadius*r,o=p.pie().padAngle($t*e.padAngle).startAngle($t*e.startAngle),s=p.arc().innerRadius(a).outerRadius(r).cornerRadius(e.cornerRadius),l=this.paper(),u=l.transition("update"),d=this.scaled(this.accessor(e.field),i),c=l.sel.attr("transforms",this.translate(n.shift.left+r,n.shift.top+r)).selectAll(".slice").data(o(t));c.enter().append("path").attr("class","slice").attr("stroke",e.color).attr("stroke-opacity",0).attr("fill-opacity",0).attr("fill",d).attr("stroke-width",l.dim(e.lineWidth)).merge(c).transition(u).attr("stroke",e.color).attr("stroke-opacity",e.colorOpacity).attr("d",s).attr("fill",d).attr("fill-opacity",e.fillOpacity),c.exit().remove()}}),Bt=ft("treemap",{requires:["d3-treemap"]});t.visualizeVersion="0.0.8",t.randomPath=V,t.DataStore=w,t.dataSources=K,t.dataLocale=tt,t.Visual=ht,t.crateChart=ft,t.cratePaper=k,t.Svg=vt,t.visualComponents=Ft,t.BarChart=Mt,t.LineChart=Rt,t.PieChart=_t,t.Treemap=Bt,Object.defineProperty(t,"__esModule",{value:!0})});