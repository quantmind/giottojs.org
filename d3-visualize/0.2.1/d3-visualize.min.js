// d3-visualize Version 0.2.1. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("object-assign"),require("d3-array"),require("d3-random"),require("d3-collection"),require("d3-let"),require("d3-view"),require("d3-dsv"),require("d3-dispatch"),require("crossfilter"),require("d3-time-format"),require("d3-selection"),require("d3-transition"),require("d3-scale"),require("d3-format"),require("d3-axis"),require("d3-shape"),require("d3-color"),require("d3-svg-legend")):"function"==typeof define&&define.amd?define(["exports","object-assign","d3-array","d3-random","d3-collection","d3-let","d3-view","d3-dsv","d3-dispatch","crossfilter","d3-time-format","d3-selection","d3-transition","d3-scale","d3-format","d3-axis","d3-shape","d3-color","d3-svg-legend"],e):e(t.d3=t.d3||{},t.assign,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.crossfilter,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,i,n,r,a,o,s,l,u,d,c,h,f,p,g,m,v,y){"use strict";function x(t){var e=(t.headers.get("content-type")||"").split(";")[0];return yt.has(e)?t.text().then(s.csvParse):"application/json"===e?t.json():(gt("Cannot load content type '"+e+"'"),[])}function w(t,e,i){a.isArray(t)&&(t={store:i,data:t,dimensions:{},series:r.map()}),Object.defineProperties(this,{_inner:{get:function(){return t}},store:{get:function(){return t.store}},data:{get:function(){return t.data}},dimensions:{get:function(){return t.dimensions}},series:{get:function(){return t.series}}}),this.serie=e}function b(t,e){return t.reduce(function(t,i){return void 0!==e(i)&&(t+=1),t},0)}function k(t,e){var i=void 0;return e?(e.forEach(function(e){e&&(i=e(t),a.isArray(i)?t=t.new(i):i&&(t=i))}),t):t}function z(t,e,i,n){var r=n.dataName(a.pop(i,"name")),o=[];Object.defineProperties(t,{name:{get:function(){return r}},store:{get:function(){return n}},type:{get:function(){return e}},transforms:{get:function(){return o}},config:{get:function(){return i}}}),t.initialise(i),t.addTransforms(a.pop(i,"transforms")),n.sources.set(r,t),Yt.call("init",void 0,t)}function _(t){var i=r.map();Object.defineProperties(this,{sources:{get:function(){return i}}}),this.transforms=e({},Bt),this.dataCount=0,this.model=t}function S(t,e){return"string"==typeof t&&t.indexOf("%")===t.length-1?Lt(.01*parseFloat(t)*e):+t}function M(t,e){var i={width:e.width,height:e.height};return i.width||(i.width=A(t),i.width?i.widthElement=O(t):i.width=Vt),i.height||(i.height=P(t),i.height?i.heightElement=T(t):i.height=Gt),i.height=S(i.height,i.width),i}function A(t){var e=E(t,"width");if(e)return W(e)}function P(t){var e=E(t,"width");if(e)return C(e)}function O(t){return E(t,"width")}function T(t){return E(t,"height")}function W(t){var e=t.getBoundingClientRect().width,i=c.select(t);return e-q(i.style("padding-left"))-q(i.style("padding-right"))}function C(t){var e=t.getBoundingClientRect().height,i=c.select(t);return e-q(i.style("padding-top"))-q(i.style("padding-bottom"))}function E(t,e){for(var i=t.node?t.node():t;i&&"BODY"!==i.tagName;){if(i.getBoundingClientRect()[e])return i;i=i.parentNode}}function q(t){return t&&"px"==t.substring(t.length-2)?+t.substring(0,t.length-2):0}function H(t){if(a.isArray(t))return t.map(H);if(a.isObject(t)){var e={};for(var i in t)e[i]=H(t[i]);return e}return t}function j(t){t.forEach(function(t){var e=t.removedNodes;e&&e.length&&e.forEach(function(t){"#text"!==t.nodeName&&(t.__visual__?D.call(t):c.select(t).selectAll(".d3-visual").each(D))})})}function D(){var t=this.__visual__;t?(t.destroy(),o.viewDebug('Removed "'+t.toString()+'" from DOM, '+Nt.live.length+" live visuals left")):Mt("d3-visual without __visual__ object")}function F(t,i){function n(e){var i=this.initialise(e);Object.defineProperties(this,{element:{get:function(){return i}},sel:{get:function(){return c.select(i)}},paperType:{get:function(){return t}}})}return n.prototype=e({},ie,i),Nt.papers[t]=n,n}function B(t){var e=t.getModel("menu"),i=t.dim(e.height,t.height,e.minHeight,e.maxHeight);t.menu.style("height",i+"px")}function Y(t){var e=t.dataStore,i=a.pop(t.options,"data");e||(e=new _(t.getModel("dataContext")),t.model.root.dataStore=e),e.addSources(i)}function X(t){var e=t.dataStore,i=a.pop(t,"data");i&&(a.isString(i)&&(i={source:i}),i.name||(i.name=t.model.uid),i=e.addSources(i),i?t.model.$set("data",i.name):Mt("Could not create data source "+i.name))}function R(t,e){var i=L(t.menu.style("height")),n=e.maxSize?Math.min(i-4,e.maxSize):i-4,r=t.dim(e.size,t.width,e.minSize,n);t.menu.select(".title").html(e.text).style("font-size",r+"px").style("line-height",i+"px")}function L(t){return+t.substring(0,t.length-2)}function V(t,e){var i=e.options[t];void 0===i||a.isObject(i)||(e.options[t]=K(i||0))}function G(t,e,i){return de.reduce(function(n,r){return n[r]=S(t[r],ce.indexOf(r)>-1?e:i),n},{})}function $(t){delete t.__boundingBox,a.isArray(t.layers)&&t.layers.forEach($)}function N(){return{width:this.innerWidth,height:this.innerHeight,margin:K(0),padding:K(0),total:K(0),innerWidth:this.innerWidth,innerHeight:this.innerHeight,$nomargins:this.$nomargins}}function K(t){return{left:t,right:t,top:t,bottom:t}}function I(t,e,i,n){var r=he.get(t)(e).tickSize(i.tickSize);return null!==i.tickSizeOuter&&r.tickSizeOuter(i.tickSizeOuter),a.isDate(n)?r.tickFormat(d.timeFormat(i.timeFormat)):null!==i.format&&r.tickFormat(p.format(i.format)),r.ticks(i.ticks)}function U(t,e,i){t.select("path.domain").attr("stroke",e.stroke);var n=t.selectAll("text").attr("fill",e.stroke);if(e.hide){var r=i.range();Math.abs(r[0]-r[r.length-1])<e.hide?t.style("opacity",0):t.style("opacity",1)}e.rotate&&n.attr("transform","rotate("+e.rotate+")").style("text-anchor",e.ancor)}function Z(t,e,i){var n=this.dim(i.offset[1],e.vizHeight);return{x:e.margin.left+(e.innerWidth-t.width)/2,y:n}}function J(t,e,i){var n=this.dim(i.offset[1],e.vizHeight);return{x:e.margin.left+(e.innerWidth-t.width)/2,y:e.vizHeight-t.height-n}}function Q(t,e,i){var n=this.dim(i.offset[0],e.vizWidth);return{x:e.vizWidth-t.width-n,y:e.margin.top+(e.innerHeight-t.height)/2}}function tt(t,e,i){var n=this.dim(i.offset[0],e.vizWidth);return{x:e.margin.left-n,y:e.margin.top+(e.innerHeight-t.height)/2}}function et(t,e,i){var n=this.dim(i.offset[0],e.vizWidth),r=this.dim(i.offset[1],e.vizHeight);return{x:e.margin.left+(e.innerWidth-t.width)/2+n,y:r}}function it(t,e,i){var n=this.dim(i.offset[0],e.vizWidth),r=this.dim(i.offset[1],e.vizHeight);return{x:e.vizWidth-t.width-n,y:r}}function nt(t,e,i){var n=this.dim(i.offset[0],e.vizWidth),r=this.dim(i.offset[1],e.vizHeight);return{x:t.width+n,y:e.vizHeight-t.height-r}}function rt(t,e,i){var n=this.dim(i.offset[0],e.vizWidth),r=this.dim(i.offset[1],e.vizHeight);return{x:e.vizWidth-t.width-n,y:e.vizHeight-t.height-r}}function at(t,e,i,n){this.data=t,this.stacked=n,this.x=e,this.y=i}function ot(t){return t}function st(t){this.vertical=!0,this.init(t),this.sx.rangeRound([0,this.box.innerWidth]),this.sy.rangeRound([this.box.innerHeight,0])}function lt(t){this.init(t),this.sx.rangeRound([0,this.box.innerHeight]),this.sy.rangeRound([0,this.box.innerWidth])}function ut(){function t(t){var d=this;t.each(function(c,h){c=c.map(o).sort(i.ascending);var p=c.length,g=c[0],m=c[p-1],v=c.quartiles=l(c),y=s&&s(c),x=y&&y.map(function(t){return c[t]}),w=y?i.range(0,y[0]).concat(i.range(y[1]+1,p)):i.range(p),b=f.scaleLinear().domain(a&&a.call(d,c,h)||[g,m]).range([n,0]),k=d.__chart__||f.scaleLinear().domain([0,1/0]).range(b.range());d.__chart__=b;var z=t.selectAll("line.center").data(x?[x]:[]);z.enter().insert("line","rect").attr("class","center").attr("x1",e/2).attr("y1",function(t){return k(t[0])}).attr("x2",e/2).attr("y2",function(t){return k(t[1])}).style("opacity",1e-6).transition().duration(r).style("opacity",1).attr("y1",function(t){return b(t[0])}).attr("y2",function(t){return b(t[1])}),z.transition().duration(r).style("opacity",1).attr("y1",function(t){return b(t[0])}).attr("y2",function(t){return b(t[1])}),z.exit().transition().duration(r).style("opacity",1e-6).attr("y1",function(t){return b(t[0])}).attr("y2",function(t){return b(t[1])}).remove();var _=t.selectAll("rect.box").data([v]);_.enter().append("rect").attr("class","box").attr("x",0).attr("y",function(t){return k(t[2])}).attr("width",e).attr("height",function(t){return k(t[0])-k(t[2])}).transition().duration(r).attr("y",function(t){return b(t[2])}).attr("height",function(t){return b(t[0])-b(t[2])}),_.transition().duration(r).attr("y",function(t){return b(t[2])}).attr("height",function(t){return b(t[0])-b(t[2])});var S=t.selectAll("line.median").data([v[1]]);S.enter().append("line").attr("class","median").attr("x1",0).attr("y1",k).attr("x2",e).attr("y2",k).transition().duration(r).attr("y1",b).attr("y2",b),S.transition().duration(r).attr("y1",b).attr("y2",b);var M=t.selectAll("line.whisker").data(x||[]);M.enter().insert("line","circle, text").attr("class","whisker").attr("x1",0).attr("y1",k).attr("x2",e).attr("y2",k).style("opacity",1e-6).transition().duration(r).attr("y1",b).attr("y2",b).style("opacity",1),M.transition().duration(r).attr("y1",b).attr("y2",b).style("opacity",1),M.exit().transition().duration(r).attr("y1",b).attr("y2",b).style("opacity",1e-6).remove();var A=t.selectAll("circle.outlier").data(w,Number);A.enter().insert("circle","text").attr("class","outlier").attr("r",5).attr("cx",e/2).attr("cy",function(t){return k(c[t])}).style("opacity",1e-6).transition().duration(r).attr("cy",function(t){return b(c[t])}).style("opacity",1),A.transition().duration(r).attr("cy",function(t){return b(c[t])}).style("opacity",1),A.exit().transition().duration(r).attr("cy",function(t){return b(c[t])}).style("opacity",1e-6).remove();var P=u||b.tickFormat(8),O=t.selectAll("text.box").data(v);O.enter().append("text").attr("class","box").attr("dy",".3em").attr("dx",function(t,e){return 1&e?6:-6}).attr("x",function(t,i){return 1&i?e:0}).attr("y",k).attr("text-anchor",function(t,e){return 1&e?"start":"end"}).text(P).transition().duration(r).attr("y",b),O.transition().duration(r).text(P).attr("y",b);var T=t.selectAll("text.whisker").data(x||[]);T.enter().append("text").attr("class","whisker").attr("dy",".3em").attr("dx",6).attr("x",e).attr("y",k).text(P).style("opacity",1e-6).transition().duration(r).attr("y",b).style("opacity",1),T.transition().duration(r).text(P).attr("y",b).style("opacity",1),T.exit().transition().duration(r).attr("y",b).style("opacity",1e-6).remove()})}var e=1,n=1,r=0,a=null,o=Number,s=dt,l=ct,u=null;return t.width=function(i){return arguments.length?(e=i,t):e},t.height=function(e){return arguments.length?(n=e,t):n},t.tickFormat=function(e){return arguments.length?(u=e,t):u},t.duration=function(e){return arguments.length?(r=e,t):r},t.domain=function(e){return arguments.length?(a=null===e?e:ye(e),t):a},t.value=function(e){return arguments.length?(o=e,t):o},t.whiskers=function(e){return arguments.length?(s=e,t):s},t.quartiles=function(e){return arguments.length?(l=e,t):l},t}function dt(t){return[0,t.length-1]}function ct(t){return[i.quantile(t,.25),i.quantile(t,.5),i.quantile(t,.75)]}e=e&&e.hasOwnProperty("default")?e.default:e,u=u&&u.hasOwnProperty("default")?u.default:u;var ht={sigma:.1,drift:0},ft=function(t,r){r=e({},ht,r);for(var a,o=i.range(0,+t,1),s=r.sigma,l=r.drift,u=[{x:0,y:0}],d=n.randomNormal(0,1),c=1;c<o.length;c++)a=l+s*d(),u[c]={x:c,y:u[c-1].y+a};return u},pt={initialise:function(t){this._data=t.data},getConfig:function(t){return a.isArray(t)?{data:t}:a.isObject(t)&&a.isArray(t.data)?t:void 0},getData:function(){return o.resolvedPromise(this.asFrame(this._data))}},gt=function(t){o.viewProviders.logger.warn("[d3-data-source] "+t)},mt=["http","https","ws","wss"],vt=function(t){return a.isString(t)&&mt.indexOf(t.split("://")[0])>-1},yt=r.set(["text/plain","text/csv","application/vnd.ms-excel"]),xt={getConfig:function(t){return vt(t)?{url:t}:a.isObject(t)&&t.url?t:void 0},initialise:function(t){this.url=t.url},getData:function(){var t=o.viewProviders.fetch,e=this;return t?t(this.url).then(x).then(function(t){return e.asFrame(t)}):(gt("fetch provider not available, cannot submit"),[])}},wt={initialise:function(t){this.source=t.source},getConfig:function(t){if(a.isObject(t)&&t.source)return a.isArray(t.source)||(t.source=[t.source]),t},getData:function(){var t=this.store,e=this.source,i=this;return Promise.all(e.map(function(e){return t.getData(e)})).then(function(t){return 1===t.length?t[0]:i.config.merge?i.mergeFrames(t):t.reduce(function(t,i,n){return t[e[n]]=i,t},{type:"frameCollection"})})},mergeFrames:function(t){return t[0]}},bt={initialise:function(t){this.expression=o.viewExpression(t.expression)},getConfig:function(t){if(a.isObject(t)&&t.expression)return t},getData:function(){var t=this,e=this.store.model,i=this.expression.eval(e);return a.isPromise(i)?i.then(function(e){return t.asFrame(e)}):t.asFrame(i)}},kt=function(t){return function(e){return e[t]}};w.prototype={size:function(){return this.data.length},new:function(t){return a.isArray(t)?new w(t,null,this.store):new w(this._inner,t)},cf:function(){return this._inner.cf||(this._inner.cf=u(this.data)),this._inner.cf},dimension:function(t,e,i){1===arguments.length&&(i=!0);var n=this.dimensions[t];if(n){if(i)return n;n.dispose()}return e||(e=kt(t)),this.dimensions[t]=this.cf().dimension(e),this.dimensions[t]},sortby:function(t,e){return this.new(this.dimension(t).top(e||1/0))},pivot:function(t,e,i,n){function r(r){var a=void 0,o=void 0;return function(s,l){return a=""+l[e],o=r*l[i],s[t]=l[t],a in s?s[a]+=o:s[a]=o,n in s?s[n]+=o:s[n]=o,s}}var a=this.dimension(t).group();return n||(n="total"),this.new(a.reduce(r(1),r(-1),Object).all().map(function(t){return t.value}))},add:function(){},map:function(t){return this.new(this.data.map(t))}};var zt=function(t){function e(t){function e(e){return i(e,t)}return r.validate(t)?e:r.logError()}var i=t.transform,n=t.schema||{},r=o.viewProviders.jsonValidator?o.viewProviders.jsonValidator(t.schema):_t;return n.type||(n.type="object"),e.schema=n,e},_t={validate:function(){return!0}},St=zt({schema:{description:"The filter transform removes objects from a data frame based on a provided filter expression",properties:{expr:{type:"string"}},required:["expr"]},transform:function(t,e){var i=o.viewExpression(e.expr);return t.data.reduce(function(e,n,r){return i.safeEval({d:n,index:r,frame:t})&&e.push(n),e},[])}}),Mt=function(t){o.viewProviders.logger.warn("[d3-visualize] "+t)},At=function(t,e){var i=new Array(t);return i.fill(e),i},Pt=r.map({count:b,max:i.max,min:i.min,sum:i.sum,mean:i.mean,median:i.median,variance:i.variance,deviation:i.deviation}),Ot=r.map({count:function(t){return t+1},sum:function(t,e){return t+e},max:Math.max,min:Math.min}),Tt=function(t){function e(t){var e=void 0;return t.data.reduce(function(t,i){for(e in i)e in t?t[e]+=1:t[e]=1;return t},{})}function i(t){var e,i,a=[];return l?n(t):(r.forEach(function(n,r){e=o[r],i=b,e&&((i=Pt.get(e))||(i=b,Mt("Operation "+o[r]+" is not supported, use count"))),a.push({label:s[r]||n,data:i(t.data,function(t){return t[n]})})}),a)}function n(t){var e=void 0,i=void 0,n=void 0,a=r.map(function(t,e){return i=o[e],n=Ot.get("count"),i&&((n=Ot.get(i))||(n=Ot.get("count"),Mt("Operation "+i+" is not supported, use count"))),{field:t,as:s[e]||t,op:n}});return t.dimension(l).group().reduce(function(t,i){return a.reduce(function(t,n){return e=0,n.as in t&&(e=t[n.as]),t[n.as]=n.op(e,i[n.field]),t},t)},null,Object).all().map(function(t){return t.value[l]=t.key,t.value})}var r=t.fields,o=t.ops,s=t.as,l=t.groupby;return r||o?a.isArray(r)?(o||(o="count"),a.isString(o)&&(o=At(r.length,o)),a.isArray(o)?(o.length<r.length&&Mt("Aggregate transforms expects an ops array with same length as fields"),s||(s=[]),a.isArray(s)?i:Mt("Aggregate transform expects an array of as fields")):Mt("Aggregate transform expects an array of ops")):Mt("Aggregate transforms expect an array of fields"):e},Wt=function(t){function e(t){var e=void 0,r=void 0;return i.forEach(function(i,o){r=n[o],a.isString(r)&&(r=t.store.eval(r)),e=t.dimension(i).filterAll(),r&&e.filter(r)}),e?t.new(e.top(1/0)):t}var i=t.fields,n=t.query;return a.isArray(i)?a.isArray(n)?n.length!=i.length?Mt("crossfilter transform expects an query array with same length as fields"):e:Mt("crossfilter transform expects an array of query"):Mt("crossfilter transform expects an array of fields")},Ct=function(t){function e(t){if(i){if(n){var e,r=t.dimension(n),a=r.group().top(1/0),o=t.new([]);return a.forEach(function(n){e=t.new(r.filterExact(n.key).top(1/0)).dimension(i).group().top(1/0),o.series.set(n.key,t.new(e).dimension("key").top(1/0))}),o}return t.new(t.dimension(i).top(1/0))}return t}var i=t.sortby,n=t.groupby;return i||Mt('timeseries transform requires a "sortby" entry'),e},Et={dataSource:null,size:{width:null,height:"70%"}};Et.dateFormat="%d-%b-%y";var qt={date:function(t){return d.utcParse(t.dateFormat||Et.dateFormat)},number:function(){return parseFloat}},Ht=zt({shema:{description:"map a field values into another type",properties:{fields:{type:"object"},dateFormat:{type:"string"}},required:["fields"]},transform:function(t,e){var i=r.map(e.fields),n=[],o=void 0,s=void 0;return i.each(function(t,e){a.isString(t)&&(t={type:t}),s=qt[t.type],s?n.push([e,s(t)]):Mt("Cannot convert field "+e+" to type "+t.type)}),n.length&&(t=t.map(function(t){for(o=0;o<n.length;++o)t[n[o][0]]=n[o][1](t[n[o][0]]);return t})),t}}),jt=function(t,e,i){return void 0!==i&&(t=Math.min(t,i)),void 0===e?t:Math.max(t,e)},Dt=zt({shema:{description:"Create moving average series from existing one. The new series override the existing one unless the as array is provided",properties:{method:{type:"string"},alpha:{type:"number"},period:{type:"number"},fields:{type:"array",items:{type:"string"}},as:{type:"array",items:{type:"string"}}},required:["fields"]},transform:function(t,e){var i=e.as||[],n=e.method||"ema",r=void 0,a=void 0,o=void 0;e.fields.forEach(function(s,l){if(r=i[l]||s,"sma"===n){var u=Math.max(e.period||10,1),d=[],c=[];t.data.forEach(function(t,e){a=t[s],d.length===u&&(a-=c.splice(0,1)[0]),c.push(a),e&&(a+=d[d.length-1]),d.push(a),t[r]=a/d.length})}else{var h=jt(e.alpha||.5,1-.999999,.999999);t.data.forEach(function(t,e){a=t[s],o=e?h*o+(1-h)*a:a,t[r]=o})}})}}),Ft=zt({schema:{description:"Group entries which are below a given aggregate cutoff",properties:{field:{type:"string"},cutoff:{type:"number"}},required:["field","cutoff"]},transform:function(t,e){var n=kt(e.field),r=i.sum(t.data,n),a=[],o=0;return t.dimension(e.field).bottom(1/0).reduce(function(t,i){return o+=n(i),o/r<e.cutoff?a.push(i):a?(a.push(i),i={label:"other",children:a},i[e.field]=o,a=null,t.push(i)):t.push(i),t},[])}}),Bt=r.map({filter:St,aggregate:Tt,mapfields:Ht,timeseries:Ct,crossfilter:Wt,movingaverage:Dt,groupsmall:Ft}),Yt=l.dispatch("init","data"),Xt={getConfig:function(){},initialise:function(){},getData:function(){},addTransforms:function(t){var e=this,i=void 0;t&&(a.isArray(t)||(t=[t]),t.forEach(function(t){i=Bt.get(t.type),i?e.transforms.push(i(t)):Mt('Transform type "'+t.type+'" not known')}))},asFrame:function(t){return a.isArray(t)&&(t=t.map(function(t){return t.constructor!==Object&&(t={data:t}),t}),t=new w(t,null,this.store)),k(t,this.transforms)}},Rt=e(r.map(),{events:Yt,add:function(t,i){function n(e,i){z(this,t,e,i)}return n.prototype=e({},Xt,i),this.set(t,n),n},create:function(t,e){for(var i,n=this.values(),r=0;r<n.length;++r)if(i=n[r].prototype.getConfig(t))return new n[r](i,e)}});Rt.add("array",pt),Rt.add("remote",xt),Rt.add("composite",wt),Rt.add("expression",bt),_.prototype={size:function(){return this.sources.size()},addSources:function(t){if(a.isString(t)&&(t={source:t}),a.isArray(t)){var e=this;return t.map(function(t){return Rt.create(t,e)})}if(t)return Rt.create(t,this)},addTransforms:function(t){e(this.transforms,t)},source:function(t,e){if(1===arguments.length)return this.sources.get(t);if(null===e){var i=this.sources.get(t);return this.sources.remove(t),i}return this.sources.set(t,e),this},clearCache:function(){this.sources.each(function(t){delete t.cachedFrame})},getData:function(t){var e=this.sources.get(t);if(!e)throw new Error("Data source "+t+" not available");if(e.cachedFrame)return o.resolvedPromise(e.cachedFrame);var i=e.getData();return a.isPromise(i)||(i=o.resolvedPromise(i)),i.then(function(t){return e.config.cache&&(e.cachedFrame=t),t})},eval:function(t,e){var i=this.model;return e&&(i=i.$child(e)),o.viewExpression(t).safeEval(i)},dataName:function(t){return this.dataCount++,t?""+t:this.source("default")?"source"+this.dataCount:"default"}};var Lt=function(t,e){return e?Math.round(t*(e=Math.pow(10,e)))/e:Math.round(t)},Vt=400,Gt="75%",$t=["visual","container"],Nt={live:[],types:{},papers:{},options:Et,events:l.dispatch("before-init","after-init","before-draw","after-draw")},Kt=e({},{initialise:function(){},draw:function(){},redraw:function(t){if(this.drawing){var e=this,i="after-draw."+this.toString();Nt.events.on(i,function(){Nt.events.on(i,null),e.redraw(t)})}else this.drawing=this.draw(t);return this.drawing},select:function(t){return c.select(t)},destroy:function(){},toString:function(){return this.visualType+"-"+this.model.uid},getModel:function(t){t||(t=this.visualType);var e=this.model[t];if(!e&&t in Et){var i=a.pop(this.options,t),n=this;this.visualParent?e=this.visualParent.getModel(t).$child(i):(e=this.model.$new(Et[t]),e.$update(i)),this.model[t]=e,e.$on(function(){return n.redraw(!1)})}return e},idname:function(t){return t||(t=this.visualType),t+"-"+this.model.uid},modelProperty:function(t,e){var i=this.getModel(),n=i[t];return void 0===n?e[t]:n},dim:function(t,e,i,n){return jt(S(t,e),i,n)},pop:function(t){if(t){var e=t.live.indexOf(this);e>-1&&t.live.splice(e,1)}},getVisualSchema:function(t){var e=this.options.visuals?this.options.visuals[t]:null,i=this.visualParent;if(i&&a.isString(e)?(t=e,e=i.getVisualSchema(t)):i&&!e&&(e=i.getVisualSchema(t)),a.isObject(e))return H(e)}},o.viewBase),It=function(t,i){function n(e,i,n,r){Object.defineProperties(this,{visualType:{get:function(){return t}},isViz:{get:function(){return-1===$t.indexOf(t)}},visualRoot:{get:function(){return this.visualParent?this.visualParent.visualRoot:this}}}),this.visualParent=n,this.model=n?n.model.$new():r||o.viewModel(),this.options=i||{},this.drawing=!1,Nt.events.call("before-init",void 0,this),this.initialise(e),Nt.events.call("after-init",void 0,this)}var r=a.pop(i,"options");return r&&(Et[t]=r),n.prototype=e({},Kt,i),Nt.types[t]=n,n},Ut=It("visual",{options:{render:"svg",width:null,height:"70%",heightElement:null},initialise:function(t){if(!t)throw new Error("HTMLElement required by visual group");if(this.visualParent&&"container"!==this.visualParent.visualType)throw new Error("Visual parent can be a container only");this.select(t).select(".paper").node()||this.select(t).append("div").classed("paper",!0),Object.defineProperties(this,{element:{get:function(){return t}},paperElement:{get:function(){return this.sel.select(".paper")}},sel:{get:function(){return c.select(t)}},size:{get:function(){return[this.width,this.height]}}}),this.sel.classed("d3-visual",!0),this.layers=[],this.drawCount=0,Nt.live.push(this),t.__visual__=this,this.visualParent&&this.visualParent.live.push(this)},activate:function(){this.layers.forEach(function(t){return t.activate()})},deactivate:function(){this.layers.forEach(function(t){return t.deactivate()})},draw:function(t){if(this.drawing)return Mt(this.toString()+" already drawing"),this.drawing;this.drawCount?(this.drawCount++,this.clear()):(this.drawCount=1,this.fit());var e=this;return Nt.events.call("before-draw",void 0,this),Promise.all(this.layers.map(function(e){if(e.active)return e.paper().size(e.boundingBox(!0)),e.redraw(t)})).then(function(){delete e.drawing,Nt.events.call("after-draw",void 0,e)},function(t){delete e.drawing,Mt("Could not draw "+e.toString()+": "+t)})},clear:function(){},addVisual:function(t){var e=a.pop(t,"type"),i=Nt.types[e];if(i)return new i(this.element,t,this);Mt('Cannot add visual "'+e+'", not available')},fit:function(){this.resize(null,!0)},resize:function(t,e){t||(t=M(this.element.parentNode||this.element,this.getModel()));var i=this.size;(e||i[0]!==t.width||i[1]!==t.height)&&(e||o.viewDebug('Resizing "'+this.toString()+'"'),this.width=t.width,this.height=t.height,this.paperElement.style("height",this.height+"px"),e||this.draw(!1))},paper:function(){var t=this.__paper,e=this.getModel().render;if(t&&t.paperType===e)return t;var i=Nt.papers[e];if(!i)throw new Error("Unknown paper "+e);return t=new i(this),this.__paper=t,t},getPaperGroup:function(t){return this.paper().group(t)},destroy:function(){this.pop(this.visualParent),this.pop(Nt)}});if(a.inBrowser){new MutationObserver(j).observe(document.documentElement,{childList:!0,subtree:!0})}var Zt=function(t,e,i,n){return i.substring(0,e.length)!==e&&(i=""+e+i[0].toUpperCase()+i.substring(1)),n?t[i]:t[i]()},Jt=function(t,e){var i=void 0;return i=e.$events?e.$events.keys():Object.keys(e),i.forEach(function(i){a.isFunction(t[i])&&t[i](e[i])}),t},Qt=function(t){for(var i=[{},te,ee],n=1;n<arguments.length;++n)i.push(arguments[n]);return It(t,e.apply(void 0,i))},te={initialise:function(t){var e=this.visualParent;if(e){if(!e.layers)throw new Error("visual parent of "+this.visualType+" does not have layers")}else this.visualParent=e=new Ut(t,this.options,null,this.model),this.model=e.model.$new(),this.options={};this.active=!0,e.layers.push(this)},paper:function(){return this.visualParent.paper()},activate:function(){this.active||(this.active=!0,this.group().transition(this.model.uid).style("opacity",1))},deactivate:function(){this.active&&(this.active=!1,this.group().style("opacity",1).transition(this.model.uid).style("opacity",0))},group:function(t){var e=this.visualType+"-"+this.model.uid,i=this.visualParent.getPaperGroup(e);return t&&t!==this.visualType?this.paper().childGroup(i,t):i},translate:function(t,e){return a.isFunction(t)?function(i){return"translate("+(t(i)||0)+", "+(e(i)||0)+")"}:"translate("+t+", "+e+")"},getScale:function(t){return a.isString(t)&&(t={type:t}),Jt(Zt(f,"scale",t.type),t)},displayError:function(){}},ee={draw:function(t){var e=this;if(this.drawing)return Mt(this.toString()+" already drawing"),this.drawing;var i=this,n=this.doDraw;if(Nt.events.call("before-draw",void 0,this),!1!==t||!this._drawArgs)return Promise.all([this.requires?o.require.apply(void 0,this.requires):[],this.getData()]).then(function(t){delete i.drawing;var r=t[1];r&&(t=a.isArray(t[0])?t[0]:[t[0]],t.unshift(r),e._drawArgs=t,n.apply(i,t),Nt.events.call("after-draw",void 0,i))},function(t){delete i.drawing,Mt("Could not draw "+i.toString()+": "+t),e.displayError(t)});delete i.drawing,n.apply(i,this._drawArgs),Nt.events.call("after-draw",void 0,i)}},ie={initialise:function(){},transition:function(){},size:function(t){return this.sel.attr("width",t.width).attr("height",t.height),this},group:function(t,e){return this.childGroup(this.sel,t,e)},childGroup:function(t,e,i){e||(e="main");var n=t.selectAll("."+e).data([0]).enter().append("g").classed(e,!0);return i&&n.attr("transform",i).merge().attr("transform",i),t.select("."+e)},dim:function(t){return t}},ne=F("svg",{initialise:function(t){var e=t.paperElement.select("svg#"+t.model.uid);return e.size()||(e=t.paperElement.append("svg").attr("id",t.model.uid).classed(t.visualType,!0).style("position","absolute")),e.node()}}),re=F("div",{initialise:function(t){var e=t.paperElement.select("div#"+t.model.uid);return e.size()||(e=t.paperElement.append("div").attr("id",t.model.uid).classed(t.visualType,!0)),e.node()},childGroup:function(t,e){return e||(e="main"),t.selectAll("."+e).data([0]).enter().append("div").classed(e,!0),t.select("."+e)}});Et.menu={display:!1,height:"8%",maxHeight:50,minHeight:20},Nt.events.on("after-init.menu",function(t){if("visual"===t.visualType){t.getModel("menu").display&&(t.menu=t.sel.insert("nav",":first-child").classed("d3-nav navbar p-1",!0),t.menu.append("h4").classed("title",!0))}}),Nt.events.on("before-draw.menu",function(t){t&&t.menu&&B(t)});var ae=r.map(),oe=function(t,e){var i=ae.get(t);return i||(i=p.format(t),ae.set(t,i)),i(e)},se=r.map(),le=function(t,e){var i=se.get(t);return i||(i=d.timeFormat(t),se.set(t,i)),i(e)};if(Nt.options.dataContext={$format:oe,$formatTime:le},te.getData=function(){var t=this.model.data;return t?this.dataStore.getData(t):(Mt("Visual "+this.visualType+" without data name, cannot get data"),o.resolvedPromise())},te.getContext=function(t){return this.dataStore.model.$child(t)},Nt.events.on("before-init.data",function(t){t.isViz&&(t.data=a.pop(t.options,"data"))}),Nt.events.on("after-init.data",function(t){Object.defineProperties(t,{dataStore:{get:function(){return t.model.root.dataStore}}}),t.isViz?X(t):Y(t)}),Nt.options.font={size:"3%",minSize:10,maxSize:20,stroke:"#333",family:null},te.font=function(t,e){e=e||this.getModel("font");var i=this.getModel(),n=this.dim(e.size,t.height,e.minSize,e.maxSize);return i.fontSizeMultiplier&&(n*=i.fontSizeMultiplier),n},Et.resizeDelay||(Et.resizeDelay=200),a.inBrowser){var ue=o.viewDebounce(function(){Nt.live.forEach(function(t){return t.resize()})},Et.resizeDelay);c.select(window).on("resize.visuals",ue)}Et.title={text:null,size:"3%",minSize:15,maxSize:25,offset:["10%",0]},Nt.events.on("before-init.title",function(t){var e=t.options.title;a.isString(e)&&(t.options.title={text:e})}),Nt.events.on("after-draw.title",function(t){var e=t.getModel("title"),i=t;if("visual"===i.visualType)delete i.__title;else{if(!t.isViz)return;i=t.visualParent}if(e.text)if(i.menu&&!i.__title)i.__title=e,R(i,e);else if(t.isViz){var n=t.boundingBox(!0),r=t.getModel("font"),a=e.stroke||r.stroke,o=t.font(n,e),s=t.group().selectAll("text.chartitle").data([e.text]),l=t.dim(e.offset[0],n.vizHeight),u=t.dim(e.offset[1],n.vizWidth),d=t.translate(n.margin.left+n.innerWidth/2+u,l);s.enter().append("text").classed("chartitle",!0).attr("transform",d).style("text-anchor","middle").style("font-size",o).style("fill",a).text(function(t){return t}).merge(s).transition().attr("transform",d).style("font-size",o).style("fill",a).text(function(t){return t})}});var de=["top","bottom","left","right"],ce=["left","right"];Et.margin={top:20,bottom:20,left:20,right:20},Et.padding={top:0,bottom:0,left:0,right:0},te.boundingBox=function(t){if(t&&$(this),!this.__boundingBox){var e=this.visualParent.width,i=this.visualParent.height,n=G(this.getModel("padding"),e,i),r=e-n.left-n.right,a=i-n.top-n.bottom,o=G(this.getModel("margin"),r,a),s=de.reduce(function(t,e){return t[e]=o[e]+n[e],t},{});this.__boundingBox={margin:o,padding:n,total:s,width:e,height:i,vizWidth:r,vizHeight:a,innerWidth:e-s.left-s.right,innerHeight:i-s.top-s.bottom,$nomargins:N}}return this.__boundingBox},Nt.events.on("after-init.margin",function(t){t.margin=V("margin",t),t.padding=V("padding",t)}),Nt.events.on("before-draw.margin",function(t){t.isViz&&$(t)});var he=r.map({top:g.axisTop,bottom:g.axisBottom,left:g.axisLeft,right:g.axisRight}),fe={ticks:5,tickSize:6,tickSizeOuter:null,rotate:null,ancor:"end",format:null,timeFormat:"%Y-%m-%d",stroke:"#333",hide:null,title:null,titleRotate:null,titleOffset:.7};Nt.options.xAxis=e({location:"bottom"},fe),Nt.options.yAxis=e({location:"left"},fe),te.xAxis1=function(t,e,i,n){var r=this.getModel("xAxis"),a=I(t,e,r,n),o=this.group("x-axis");this.applyTransform(o,this.translateAxis(t,i)),U(o.transition(this.transition("x-axis")).call(a),r,e),r.title&&this.axisTitle(o,t,e,i,r)},te.yAxis1=function(t,e,i,n){var r=this.getModel("yAxis"),a=I(t,e,r,n),o=this.group("y-axis");this.applyTransform(o,this.translateAxis(t,i)),U(o.transition(this.transition("x-axis")).call(a),r,e),r.title&&this.axisTitle(o,t,e,i,r)},te.axis=function(t,e){return he.get(t)(e)},te.axisTitle=function(t,e,i,n,r){var a=t.selectAll("text.title").data([r.title]),o=r.titleRotate||0,s=0,l=0;o||"right"!==e&&"left"!==e||(o=-90),"left"==e&&(s=-r.titleOffset*n.margin.left,l=n.innerHeight/2);var u="translate("+s+","+l+") rotate("+o+")",d=this.font(n)
;a.enter().append("text").classed("title",!0).attr("transform",u).style("text-anchor","middle").style("font-size",d).style("fill",r.stroke).text(function(t){return t}).merge(a).transition().attr("transform",u).style("font-size",d).style("fill",r.stroke).text(function(t){return t})},te.translateAxis=function(t,e){return"top"===t||"left"===t?this.translate(e.margin.left,e.margin.top):"bottom"===t?this.translate(e.margin.left,e.margin.top+e.innerHeight):this.translate(e.margin.left+e.innerWidth,e.margin.top)};var pe=r.map({circle:m.symbolCircle,square:m.symbolSquare,star:m.symbolStar});te.getSymbol=function(t){var e=pe.get(t);return m.symbol().type(e)};var ge=r.map();Et.color={scale:"cool",scaleMinPoints:6,scaleOffset:0,stroke:"#333",strokeOpacity:1,fillOpacity:1},ge.set("viridis",function(){return f.scaleSequential(f.interpolateViridis)}),ge.set("inferno",function(){return f.scaleSequential(f.interpolateInferno)}),ge.set("magma",function(){return f.scaleSequential(f.interpolateMagma)}),ge.set("plasma",function(){return f.scaleSequential(f.interpolatePlasma)}),ge.set("warm",function(){return f.scaleSequential(f.interpolateWarm)}),ge.set("cool",function(){return f.scaleSequential(f.interpolateCool)}),ge.set("rainbow",function(){return f.scaleSequential(f.interpolateRainbow)}),ge.set("cubehelix",function(){return f.scaleSequential(f.interpolateCubehelixDefault)}),te.colors=function(t,e){var n=this.getModel("color"),r=ge.get(n.scale);if(!r)throw new Error("Unknown scale "+n.scale);a.isObject(r)||(r={scale:r}),void 0===r.minPoints&&(r.minPoints=n.scaleMinPoints);var o=n.scaleOffset,s=t+o,l=Math.max(s,r.minPoints),u=r.reversed?[l-1,0]:[0,l-1],d=r.scale().domain(u),c=void 0;return i.range(o,Math.min(s,l)).map(function(t){return c=v.color(d(t)),c.opacity=e,c})},te.fill=function(t){function e(t,e){return r[e]}var i=this.getModel("color"),n=this.modelProperty("fillOpacity",i),r=this.colors(t.length,n);return e.colors=r,e},te.stroke=function(t){function e(t,e){return r[e]}var i=this.getModel("color"),n=this.modelProperty("strokeOpacity",i),r=this.colors(t.length,n);return e.colors=r,e},te.linearGradient=function(t,e,i,n){var r=this.paper().sel,a=r.select("defs");a.node()||(a=r.append("defs"));var o=a.selectAll("#"+n).data([0]),s=v.color(t);s.opacity=.1,o.enter().append("linearGradient").attr("id",n).attr("x1","0%").attr("y1","0%").attr("x2","vertical"===i?"0%":"100%").attr("y2","vertical"===i?"100%":"0%");var l=a.select("#"+n).selectAll("stop").data([{offset:"0%",color:t},{offset:"100%",color:s}]);return l.enter().append("stop").merge(l).attr("offset",function(t){return t.offset}).attr("stop-color",function(t){return t.color}),"url(#"+n+")"},Et.legend={location:"top-right",orient:"vertical",fontSize:"3%",title:"",titleWidth:"20%",labelFormat:null,titleMinWidth:30,titleMaxWidth:60,minFontSize:10,maxFontSize:20,offset:[10,10],shapeWidth:15,shapeHeight:15,hide:300};var me={color:y.legendColor,size:y.legendSize,symbol:y.legendSymbol};te.legend=function(t,e){var i=this.getModel(),n=this.getModel("legend"),r=this.getModel("font"),o=a.pop(t,"type")||i.legendType,s=Math.max(e.vizHeight,e.vizWidth),l=this.dim(n.fontSize,s,n.minFontSize,n.maxFontSize),u=me[o];if(!u)return Mt("Could not load legend "+o);if(u=u().orient(n.orient),n.title&&(u.title(n.title),n.titleWidth)){var d=this.dim(n.titleWidth,s,n.titleMinWidth,n.titleMaxWidth);u.titleWidth(d)}n.labelFormat&&u.labelFormat(n.labelFormat),u.shapeWidth(n.shapeWidth).shapeHeight(n.shapeHeight);for(var c in t)u[c](t[c]);var h=this.group("legend").style("font-size",l+"px").html("").call(u),f=h.node().getBBox(),p=ve.get(n.location).call(this,f,e,n),g=this.translate(p.x,p.y);h.selectAll("text").style("fill",n.stroke||r.stroke),this.applyTransform(h,g),n.hide&&(s<n.hide?h.style("opacity",0):h.style("opacity",1))};var ve=r.map({top:Z,bottom:J,right:Q,left:tt,"top-left":et,"top-right":it,"bottom-left":nt,"bottom-right":rt}),ye=function(t){return function(){return t}},xe=function(t){return a.isFunction(t)?t:ye(t)},we=function(t){return t},be=r.map({darker:function(){function t(t,e){var i=t.getModel("mouse"),n=v.color(e.style("fill")),r=n.darker(i.darkerFactor);e.node().__mouse_over__.fill=n,e.style("fill",r)}return t.out=function(t,e){var i=e.node(),n=i.__mouse_over__.fill;n&&e.style("fill",n)},t}(),fill:function(){function t(t,e){var i=t.getModel("mouse"),n=v.color(e.style("fill"));e.node().__mouse_over__.fill=n,e.transition().style("fill",i.fillColor)}return t.out=function(t,e){var i=e.node(),n=i.__mouse_over__.fill;n&&e.transition().style("fill",n)},t}()});Nt.options.mouse={over:["darker"],darkerFactor:.5,fillColor:"#addd8e"},te.mouseOver=function(){var t=this,e=this.getModel("mouse");return function(i,n){this.__mouse_over__||(this.__mouse_over__={});var r=t.select(this),a=void 0;e.over.forEach(function(e){a=be.get(e),a?a(t,r,i,n):Mt("Unknown mouse strategy "+e)})}},te.mouseOut=function(){var t=this,e=this.getModel("mouse");return function(i,n){this.__mouse_over__||(this.__mouse_over__={});var r=t.select(this),a=void 0;e.over.forEach(function(e){a=be.get(e),a?a.out(t,r,i,n):Mt("Unknown mouse strategy "+e)})}},Nt.options.tooltip={location:"top",offset:[0,0],html:""},a.inBrowser?te.tooltip=function(){function t(){return null===m&&(m=c.select(document.body).append("div").classed("d3-tooltip",!0).style("position","absolute").style("top",0).style("opacity",0).style("pointer-events","none").style("box-sizing","border-box").node(),v=c.select(document.body).append("svg").style("opacity",0).style("pointer-events","none").node().createSVGPoint()),c.select(m)}function e(){}function i(t){var e=h(t);return{top:e.n.y-m.offsetHeight,left:e.n.x-m.offsetWidth/2}}function n(t,e,i){return{x:e.total.left+(e.innerWidth-t.width)/2,y:e.height-t.height-i.offsetY}}function a(t){var e=h(t);return{top:e.e.y-m.offsetHeight/2,left:e.e.x}}function o(t,e,i){return{x:e.total.left+(e.innerWidth-t.width)/2,y:i.offsetY}}function s(t,e,i){return{x:e.total.left+(e.innerWidth-t.width)/2,y:i.offsetY}}function l(t,e,i){return{x:e.width-t.width-i.offsetX,y:i.offsetY}}function u(t,e,i){return{x:e.total.left+(e.innerWidth-t.width)/2,y:e.height-t.height-i.offsetY}}function d(t,e,i){return{x:e.total.left+(e.innerWidth-t.width)/2,y:e.height-t.height-i.offsetY}}function h(t){for(;null==t.getScreenCTM&&null==t.parentNode;)t=t.parentNode;var e={},i=t.getScreenCTM(),n=t.getBBox(),r=n.width,a=n.height,o=n.x,s=n.y;return v.x=o,v.y=s,e.nw=v.matrixTransform(i),v.x+=r,e.ne=v.matrixTransform(i),v.y+=a,e.se=v.matrixTransform(i),v.x-=r,e.sw=v.matrixTransform(i),v.y-=a/2,e.w=v.matrixTransform(i),v.x+=r,e.e=v.matrixTransform(i),v.x-=r/2,v.y-=a/2,e.n=v.matrixTransform(i),v.y+=a,e.s=v.matrixTransform(i),e}var f=xe("top"),p=xe([0,0]),g=xe(" "),m=null,v=null,y=r.map({top:i,bottom:n,right:a,left:o,"top-left":s,"top-right":l,"bottom-left":u,"bottom-right":d}),x=y.keys();return e.show=function(i){var n,r=Array.prototype.slice.call(arguments),a=t(),o=g.apply(this,r)||"",s=p.apply(this,r),l=f.apply(this,r),u=document.documentElement.scrollTop||document.body.scrollTop,d=document.documentElement.scrollLeft||document.body.scrollLeft;a.html(o).style("opacity",1).style("pointer-events","all");for(var c=x.length;c--;)a.classed(x[c],!1);return n=y.get(l).call(this,i),a.classed(l,!0).style("top",n.top+s[0]+u+"px").style("left",n.left+s[1]+d+"px"),e},e.hide=function(){return t().style("opacity",0).style("pointer-events","none"),e},e.location=function(t){return arguments.length?(f=null===t?t:xe(t),e):f},e.html=function(t){return arguments.length?(g=null===t?t:xe(t),e):g},e.offset=function(t){return arguments.length?(p=null==t?t:xe(t),e):p},e}():te.tooltip=we,be.set("tooltip",function(){function t(t,e,i,n){var r=t.tooltipHtml(e,i,n);if(r){var a=t.getModel("tooltip");t.tooltip.location(a.location).offset(a.offset).html(r).show(e.node())}}return t.out=function(t){t.tooltip.hide()},t}()),te.tooltipHtml=function(t,e,i){var n=this.getModel("tooltip");if(n.html)return this.dataStore.eval(n.html,{d:e,index:i,model:this.getModel()})},Nt.options.expand={location:"top-right",expandText:"expand",collapseText:"collapse",height:15,width:15,radius:3,offset:[0,0],stroke:"#adadad",fill:"#fff",fillOver:"#e6e6e6",textColor:"#111"},Nt.events.on("after-draw.expand",function(t){function e(){t.select(this).select("rect.button").attr("fill",a.fillOver)}function i(){t.select(this).select("rect.button").attr("fill",a.fill)}function n(){var e=t.getModel("padding");if(i.call(this),t.__expanded){var n=t.__expanded.padding;delete t.__expanded,r.activate(),de.forEach(function(t){n[t]&&(e[t]=n[t])})}else t.__expanded={padding:de.reduce(function(t,i){return e[i]&&(t[i]=e[i],e[i]=0),t},{})},r.deactivate(),t.activate();r.redraw(!1)}var r=t.visualParent;if(t.isViz&&!(r.layers.length<=1)){var a=t.getModel("expand");if(a.location){var o=t.getModel("font"),s=t.boundingBox(),l=t.group("expand"),u=l.node(),d=Math.floor(.8*Math.min(a.width,a.height)),c=t.__expanded?a.collapseText:a.expandText,h=!1;l.select("rect").size()||(h=!0,l.attr("cursor","pointer").on("mouseover",e).on("mouseout",i),l.append("rect").classed("button",!0).attr("x",0).attr("y",0).attr("rx",a.radius).attr("ry",a.radius).attr("width",a.width).attr("height",a.height).attr("stroke",a.stroke).attr("fill",a.fill).attr("cursor","pointer"),l.append("text").attr("x",a.width/2).attr("y",a.height/2).attr("fill",a.textColor).attr("font-family",a.fontFamily||o.family).attr("text-anchor","middle").attr("alignment-baseline","middle").attr("font-size",d),l.append("rect").classed("placeholder",!0).attr("x",0).attr("y",0).attr("rx",a.radius).attr("ry",a.radius).attr("width",a.width).attr("height",a.height).attr("stroke","none").attr("fill","transparent").on("click",n)),l.select("text").text(function(){return c});var f=ve.get(a.location).call(t,u.getBBox(),s,a);h||(l=l.transition(t.transition("expand"))),l.attr("transform",t.translate(f.x,f.y))}}}),Nt.options.transition={duration:250,delay:0,ease:null},te.transition=function(t){var e=this.idname(t),i=this.getModel("transition");return h.transition(e).duration(i.duration)},te.applyTransform=function(t,e){t.attr("transform")||t.attr("transform",e),t.transition().attr("transform",e)};var ke=It("container",{initialise:function(){this.live=[],this.visualParent&&this.visualParent.live.push(this)},draw:function(t){if(this.drawing)return Mt(this.toString()+" already drawing"),this.drawing;var e=this;return Nt.events.call("before-draw",void 0,e),Promise.all(this.live.map(function(e){return e.redraw(t)})).then(function(){delete e.drawing,Nt.events.call("after-draw",void 0,e)})},destroy:function(){this.pop(this.visualParent)}}),ze={props:["schema","datasource","plugins"],render:function(t,e,i){var n=this,r=this.select(i).html();return this.getSchema(t.schema,function(t){return a.isObject(t)||(t={}),n.build(t,r,e)})},getSchema:function(t,e){var i=this.model.visual;if(i&&i!==this.model&&a.isString(t)){var n=i.getVisualSchema(t);n&&(t=n)}return a.isString(t)?this.json(t).then(e).catch(function(e){Mt("Could not reach "+t+": "+e)}):e(t)},build:function(){}},_e=e({},ze,{build:function(t,e,i){var n=this.model,r=this.createElement("div"),a=n.root;return i.class&&r.attr("class",i.class),t.visuals||(t.visuals={}),n.visual=new ke(r.node(),t,n.visual,n.visual?null:n.$new()),a.visualDashboard||(a.visualDashboard=n.visual),this.mountInner(r,e)}}),Se=e({},ze,{build:function(t){var e,i=this.createElement("div"),n=t.type||"visual",r=this.model,o={};return"visual"===n?(e=a.pop(t,"layers"),o=t):o.visual=a.pop(t,"visual")||{},r.visual=new Ut(i.node(),o,r.visual,r.visual?null:r.$new()),"visual"!==n?r.visual.addVisual(t):e&&e.forEach(function(t){return r.visual.addVisual(t)}),i},mounted:function(){!1!==this.model.visualDrawOnMount&&this.model.visual.redraw()}}),Me={install:function(t){t.addComponent("dashboard",_e),t.addComponent("visual",Se)}},Ae=function(t,e){return e<t?-1:e>t?1:e>=t?0:NaN},Pe=function(){function t(t){var a=void 0,o=void 0,s=void 0,l=void 0,u=void 0,d=void 0,c=void 0,h=void 0,f=void 0,p=void 0,g=void 0,m=t.length,v=.5*r/n,y=new Array(m),x=new Array(m);for(a=0;a<m;++a)y[x[a]=a]=+e(t[a],a,t);for(x.sort(function(t,e){return Ae(y[t],y[e])}),f=y[x[0]],d=null,a=m-1;a>=0;--a)l=[],null===d?l.push([0,0]):(h=d+p,c=h*v,l.push([c,h]),l.push([-c,h])),o=x[a],s=m-a-1,u=y[o]/f,g=Math.sqrt(u),d=n*g,p=a?i(g,s):0,h=d-p,c=h*v,l.push([-c,h]),l.push([c,h]),y[o]={index:s,value:y[o],fraction:u,points:l,data:t[o]};return y}var e=we,i=ye(0),n=1,r=1;return t.value=function(i){return arguments.length?(e="function"==typeof i?i:ye(+i),t):e},t.base=function(e){return arguments.length?(r=e,t):r},t.height=function(e){return arguments.length?(n=e,t):n},t.pad=function(e){return arguments.length?(i="function"==typeof e?e:ye(+e),t):i},t},Oe=function(t,e){var i=t[0],n=t[1],r=(n-i)/e,a=Math.floor(Math.log10(r)),o=Math.pow(10,a);r/o>5&&(o*=10),o*=.1;var s=o*Math.ceil(r/o),l=o*Math.floor(i/o);return[l,l+e*s]},Te=function(){function t(t){var s=!1,l=void 0,u=void 0,d=void 0;return e&&(u=t.dimension(e).group().top(1/0).map(function(t){return t.key}),u.length<=1&&(u=null)),u?(t=t.pivot(i,e,n),r&&(t=t.sortby("total")),l=t.data,a&&(o&&(l=ot(l)),l=a.keys(u)(l),s=!0)):(l=t.data,u=[n]),s||(l=u.map(function(t,e){return d=l.map(function(e){return d=[0,e[t]],d.data=e,d}),d.index=e,d.key=t,d})),new at(l,i,n,s)}var e=null,i="x",n="y",r=!1,a=null,o=!1;return t.groupby=function(i){return arguments.length?(e=i,t):e},t.x=function(e){return arguments.length?(i=e,t):i},t.y=function(e){return arguments.length?(n=e,t):n},t.normalize=function(e){return arguments.length?(o=e,t):o},t.stack=function(e){return arguments.length?(a=e,t):a},t};at.prototype={rangeX:function(){return this.range(this.x)},rangeY:function(){return this.range()},range:function(t){function e(t){return t[0]}function n(t){return t[1]}function r(e){return e.data[t]}var a=void 0,o=void 0;return o=t?this.data.reduce(function(t,e){return a=i.extent(e,r),t.push(a[0]),t.push(a[1]),t},[]):this.data.reduce(function(t,r){return a=i.extent(r,e),t.push(a[0]),t.push(a[1]),a=i.extent(r,n),t.push(a[0]),t.push(a[1]),t},[]),i.extent(o)}};var We={curve:function(t){var e=Zt(m,"curve",t,!0);return e||(Mt('Could not locate curve type "'+t+'"'),e=Zt(m,"curve","cardinalOpen",!0)),e},range:function(t,e,n,r){var a={x:i.extent(t,e),y:i.extent(t,n)};r&&(Array.prototype.push.apply(r.x,a.x),Array.prototype.push.apply(r.y,a.y))},newRange:function(){return{x:[],y:[]}},x:function(t,e){var n=this.getModel(),r=this.getScale(n.scaleX).domain(i.extent(e)).range([0,t.innerWidth]);return function(t){return r(t[n.x])}},y:function(t,e,n){var r=this.getModel(),a=this.getScale(r.scaleY).domain(i.extent(e)).range([t.innerHeight,0]);return 2===arguments.length&&(n=function(t){return t[r.y]}),function(t){return a(n(t))}},getStack:function(){var t=this.getModel();if(t.stack){var e=m.stack();return t.stackOrder&&e.order(t.stackOrder),e}}},Ce=Qt("linechart",We,{options:{lineWidth:1,curve:"natural",x:"x",y:"y",groupby:null,scaleX:"linear",scaleY:"linear",axisX:!0,axisY:!0},doDraw:function(t){function e(t,e){return y[e]}function i(t){return h(t.data[o])+x}function n(t){return f(t[1])}var r=this.getModel(),o=r.x,s=r.y,l=this.boundingBox(),u=Te().groupby(r.groupby).x(o).y(s)(t),d=u.rangeX(),c=u.rangeY(),h=this.getScale(r.scaleX).domain(d).rangeRound([0,l.innerWidth]),f=this.getScale(r.scaleY).domain(c).rangeRound([l.innerHeight,0]).nice(),p=this.group(),g=this.group("chart"),v=g.selectAll(".line").data(u.data),y=this.stroke(u.data).colors,x=0,w=m.line().x(i).y(n).curve(this.curve(r.curve));this.applyTransform(p,this.translate(l.padding.left,l.padding.top)),this.applyTransform(g,this.translate(l.margin.left,l.margin.top)),a.isFunction(h.bandwidth)&&(h.domain(u.data[0].map(function(t){return t.data[o]})),x=h.bandwidth()/2),v.enter().append("path").attr("class","line").attr("fill","none").attr("stroke",e).attr("stroke-width",r.lineWidth).merge(v).transition().attr("stroke",e).attr("stroke-width",r.lineWidth).attr("d",w),v.exit().transition().style("opacity",0).remove(),r.axisX&&this.xAxis1(!0===r.axisX?"bottom":r.axisX,f,l),r.axisY&&this.yAxis1(!0===r.axisY?"left":r.axisY,f,l)}}),Ee=Qt("barchart",We,{options:{orientation:"vertical",sortby:null,stack:!0,normalize:!1,scaleX:{type:"band",padding:.2},scaleY:"linear",x:"x",y:"y",radius:0,groupby:null,axisY:!0,axisX:!0,valueformat:".1f",legendType:"color",legendLabel:"label"},doDraw:function(t){var e=this.getModel(),i=t.data,n=this.boundingBox(),r=this.group(),a=this.group("chart"),o=a.selectAll(".group"),s=e.x,l=e.y,u=e.groupby,d="vertical"===e.orientation?new st(this):new lt(this),c=void 0,h=!1;if(this.applyTransform(r,this.translate(n.padding.left,n.padding.top)),this.applyTransform(a,this.translate(n.margin.left,n.margin.top)),u&&(c=t.dimension(u).group().top(1/0).map(function(t){return t.key}),c.length<=1&&(c=null)),c){var f=t.pivot(s,u,l);"y"===e.sortby&&(f=f.sortby("total")),i=f.data,d.sz.domain(c).range(this.fill(c).colors),e.stack&&(e.normalize&&(i=this.normalize(f)),h=!0)}else d.sz.domain([l]).range(this.fill([l]).colors),h=!0;var p=i.map(function(t){return t[s]});d.sx.domain(p),h||!c?d.stacked(o,i,c):d.grouped(o,i,c),d.axis(p),d.legend(c)}}),qe={init:function(t){this.viz=t,this.model=t.getModel(),this.box=t.boundingBox(),this.sx=t.getScale(this.model.scaleX),this.sy=t.getScale(this.model.scaleY),this.sz=t.getScale("ordinal")},legend:function(t){this.model.legendType&&t&&this.viz.legend({scale:this.sz},this.box)},stacked:function(t,e,n){function r(t){return c(t[1-k])-c(t[k])}function a(t){return d(t.data[f])}function o(t){return c(t[k])}function s(t){return t.forEach(function(e){e.key=t.key,e.value=e.data[t.key]}),t}var l=m.stackOrderDescending,u=this.viz.getModel("color"),d=this.sx,c=this.sy,h=this.sz,f=this.model.x,p=this.model.y,g=this.viz,v=this.model.radius,y=void 0,x=void 0,w=void 0,b=void 0,k=void 0,z=void 0;n?this.sy.domain([0,i.max(e,function(t){return t.total})]).nice():(this.sy.domain([0,i.max(e,function(t){return t[p]})]).nice(),n=[this.model.y]),this.vertical?(w=a,b=o,y=d.bandwidth,x=r,k=1):(w=o,b=a,y=r,x=d.bandwidth,k=0),e=m.stack().order(l).keys(n)(e),z=t.data(e).enter().append("g").classed("group",!0).attr("fill",function(t){return h(t.key)}).merge(t).attr("fill",function(t){return h(t.key)}).attr("stroke",g.modelProperty("stroke",u)).attr("stroke-opacity",g.modelProperty("strokeOpacity",u)).selectAll("rect").data(s),z.enter().append("rect").attr("x",w).attr("y",b).attr("height",x).attr("width",y).attr("rx",v).attr("ry",v).on("mouseover",g.mouseOver()).on("mouseout",g.mouseOut()).merge(z).transition().attr("x",w).attr("y",b).attr("height",x).attr("width",y)},grouped:function(t,e,n){function r(t){return d(t[f])}function a(t){return c(t.value)}function o(t){return c(0)-c(t.value)}function s(t){return n.map(function(e){return{key:e,value:t[e]}})}function l(t){return n.reduce(function(e,i){return Math.max(e,t[i])},0)}var u=this.viz.getModel("color"),d=this.sx,c=this.sy,h=this.sz,f=this.model.x,p=this.viz,g=this.model.radius,m=d.paddingInner(),v=p.getScale("band").domain(n).paddingInner(.5*m),y=void 0,x=void 0,w=void 0,b=void 0;c.domain([0,i.max(e,l)]).nice(),this.vertical?(v.rangeRound([0,d.bandwidth()]),w=r,y=v.bandwidth,x=o):(w=r,x=v.bandwidth,y=o),t=t.data(e),t.exit().remove(),b=t.enter().append("g").classed("group",!0).attr("transform",function(t){return p.translate(w(t),0)}).merge(t).attr("transform",function(t){return p.translate(w(t),0)}).selectAll("rect").data(s),b.exit().transition().style("opacity",0).remove(),b.enter().append("rect").attr("x",function(t){return v(t.key)}).attr("y",a).attr("rx",g).attr("ry",g).attr("height",x).attr("width",y).attr("stroke",u.stroke).attr("stroke-opacity",0).attr("fill",function(t){return h(t.key)}).on("mouseover",p.mouseOver()).on("mouseout",p.mouseOut()).merge(b).transition(p.transition("rect")).attr("x",function(t){return v(t.key)}).attr("y",a).attr("height",x).attr("width",y).attr("stroke",u.stroke).attr("stroke-opacity",u.strokeOpacity).attr("fill",function(t){return h(t.key)}),b.exit().remove()}};st.prototype=e({},qe,{axis:function(t){this.model.axisX&&this.viz.xAxis1(!0===this.model.axisX?"bottom":this.model.axisX,this.sx,this.box,t[0]),this.model.axisY&&this.viz.yAxis1(!0===this.model.axisY?"left":this.model.axisY,this.sy,this.box)}}),lt.prototype=e({},qe,{axis:function(t){this.model.axisX&&this.viz.xAxis1(!0===this.model.axisX?"left":this.model.axisX,this.sx,this.box,t[0]),this.model.axisY&&this.viz.yAxis1(!0===this.model.axisY?"bottom":this.model.axisY,this.sy,this.box)}});var He=Qt("boxchart",We,{options:{orientation:"vertical",lineWidth:1,x:"x",y:"y",scaleX:"linear",scaleY:"linear",gradient:!0},doDraw:function(t){var e=this,n=this.getModel(),r=e.getDataInfo(t),a=this.boundingBox(),o=ut(),s=this.paper().size(a),l=kt(n.x),u=s.group().attr("transform",this.translate(a.total.left,a.total.top)).selectAll(".box").data(r.data),d=t.groupby(n.x),c=this.getScale(n.scaleX).domain(i.extent(t.data,l)),h=a.innerWidth;"vertical"===n.orientation?c.range([0,a.innerWidth]):(c.range([0,a.innerHeight]),h=this.innerHeight),o.width(this.dim(n.width,h,h/d.length-2)),u.enter().append("g").classed("box",!0).call(o)}}),je=Qt("areachart",We,{options:{lineWidth:1,curve:"natural",x:"x",y:"y",groupby:null,scaleX:"linear",scaleY:"linear",gradient:!0,lineDarken:.2,axisX:!0,axisY:!0},doDraw:function(t){function e(t){return p(t.data[s])}function i(t){return g(t[0])}function n(t){return g(t[1])}function r(t){var r=m.area().curve(z).x(e).y1(n).y0(i),a=m.line().curve(z).x(e).y(n),s=v.color(b[t.index]);return[{type:"area",data:t,draw:r(t),stroke:"none",fill:k[t.index]},{type:"line",data:t,draw:a(t),fill:"none",stroke:s.darker(o.lineDarken)}]}var a=this,o=this.getModel(),s=o.x,l=o.y,u=this.getModel("color"),d=this.boundingBox(),c=Te().groupby(o.groupby).stack(this.getStack()).x(s).y(l)(t),h=c.rangeX(),f=c.rangeY(),p=this.getScale(o.scaleX).domain(h).rangeRound([0,d.innerWidth]),g=this.getScale(o.scaleY).domain(f).rangeRound([d.innerHeight,0]).nice(),y=this.group(),x=this.group("chart"),w=x.selectAll(".areagroup").data(c.data),b=this.colors(c.data.length),k=o.gradient?b.map(function(t,e){return a.linearGradient(t,d,"vertical","fill"+a.model.uid+"-"+e)}):b,z=this.curve(o.curve);this.applyTransform(y,this.translate(d.padding.left,d.padding.top)),this.applyTransform(x,this.translate(d.margin.left,d.margin.top));var _=w.enter().append("g").classed("areagroup",!0).merge(w).selectAll("path").data(r);_.enter().append("path").attr("class",function(t){return t.type}).attr("fill",function(t){return t.fill}).attr("stroke",function(t){return t.stroke}).attr("d",function(t){return t.draw}).merge(_).attr("d",function(t){return t.draw}).attr("fill",function(t){return t.fill}).attr("stroke",function(t){return t.stroke}).attr("fill-opacity",u.fillOpacity).attr("stroke-width",o.lineWidth).attr("stroke-opacity",u.strokeOpacity),_.exit().transition().remove(),o.axisX&&this.xAxis1(!0===o.axisX?"bottom":o.axisX,p,d,h[0]),o.axisY&&this.yAxis1(!0===o.axisY?"left":o.axisY,g,d,f[0])},ticks:function(t,e){return Math.max(Math.floor(t/e),1)}}),De=function(t,e,i){t.each(function(){for(var t,n=c.select(this),r=n.text().split(/\s+/).reverse(),a=[],o=parseFloat(n.attr("dy"))||0,s=n.text(null).append("tspan").attr("x",0).attr("dy",o+"em");t=r.pop();)a.push(t),s.text(a.join(" ")),s.node().getComputedTextLength()>e&&a.length>1&&(a.pop(),s.text(a.join(" ")),a=[t],s=n.append("tspan").attr("x",0).attr("dy",1.2+o+"em").text(t));i&&n.selectAll("tspan").each(i)})},Fe=Math.PI,Be=Fe/180,Ye={proportionalData:function(t,e){return t.dimension(e).top(1/0)},total:function(t){function e(e){return i+=e[t],e[t]}var i=0;return e.total=function(){return i},e}},Xe=Qt("piechart",Ye,{options:{field:"data",label:"label",startAngle:0,endAngle:360,sort:!1,innerRadius:0,padAngle:0,cornerRadius:0,lineWidth:1,fractionFormat:".1%",legendType:"color",legendLabel:"label + ' - ' + format(fraction)",center:null,centerOpacity:1,centerFontSize:"7%"},doDraw:function(t){var e=this.getModel(),i=this.getModel("color"),n=e.field,r=this.boundingBox(),a=Math.min(r.innerWidth,r.innerHeight)/2,s=S(e.innerRadius,a),l=this.total(n),u=m.pie().padAngle(Be*e.padAngle).startAngle(Be*e.startAngle).endAngle(Be*e.endAngle).value(l),d=m.arc().innerRadius(s).outerRadius(a).cornerRadius(e.cornerRadius),c=this.paper().size(r),h=u(this.proportionalData(t,n)),g=this.fill(h),v=c.group().attr("transform",this.translate(r.total.left+r.innerWidth/2,r.total.top+r.innerHeight/2)).selectAll(".slice").data(h);if(v.enter().append("path").attr("class","slice").attr("stroke",i.stroke).attr("stroke-opacity",0).attr("fill",g).attr("stroke-width",e.lineWidth).on("mouseover",this.mouseOver()).on("mouseout",this.mouseOut()).merge(v).transition().attr("stroke",i.stroke).attr("stroke-opacity",i.strokeOpacity).attr("d",d).attr("fill",g),v.exit().transition().remove(),e.center){var y=this.dataStore.eval(e.center,{total:l.total()});if(y){var x=this.getModel("font"),w=this.dim(e.centerFontSize,r.innerWidth),b=c.group("center-notation").attr("transform",this.translate(r.total.left+r.innerWidth/2,r.total.top+r.innerHeight/2)).selectAll(".info").data([y]);b.enter().append("text").attr("class","info").attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-size",w+"px").style("fill-opacity",0).merge(b).text(y).style("fill-opacity",e.centerOpacity).style("fill",x.stroke).call(De,1.5*(s||a))}}if(e.legendType){l=l.total();var k=o.viewExpression(e.legendLabel),z=p.format(e.fractionFormat),_=h.map(function(t,i){return k.eval({d:t,value:t.value,format:z,total:l,fraction:t.value/l,label:t.data[e.label]||i})});this.legend({scale:f.scaleOrdinal().domain(_).range(g.colors)},r)}}}),Re=function(t){return{draw:function(e){t.forEach(function(t,i){i?e.lineTo(t[0],t[1]):e.moveTo(t[0],t[1])}),e.closePath()}}},Le=Qt("pyramidchart",Ye,{options:{field:"data",label:"label",pad:.005,lineWidth:1,inverted:!1,legendType:"color",invereted:!1,legendLabel:"label + ' - ' + format('.1%', fraction)"},doDraw:function(t){var e=this.getModel(),i=e.field,n=this.getModel("color"),r=this.boundingBox(),a=Pe().pad(e.pad).value(function(t){return t[i]}),s=this.getScale("linear").rangeRound([0,r.innerWidth]),l=this.getScale("linear").rangeRound(e.inverted?[r.innerHeight,0]:[0,r.innerHeight]),u=t.new(a(this.proportionalData(t,i))).dimension("fraction").bottom(1/0),d=m.symbol().type(function(t){return Re(t.points.map(function(t){return[s(t[0]),l(t[1])]}))}).size(1),c=this.fill(u),h=this.group(),f=this.group("chart"),p=f.style("shape-rendering","crispEdges").selectAll(".segment").data(u);if(this.applyTransform(h,this.translate(r.padding.left,r.padding.top)),this.applyTransform(f,this.translate(r.margin.left+r.innerWidth/2,r.margin.top)),p.enter().append("path").attr("class","segment").attr("stroke",n.stroke).attr("stroke-opacity",0).attr("fill",c).attr("stroke-width",e.lineWidth).attr("d",d).on("mouseover",this.mouseOver()).on("mouseout",this.mouseOut()).merge(p).transition().attr("stroke",n.stroke).attr("stroke-opacity",n.strokeOpacity).attr("d",d).attr("fill",c),p.exit().remove(),e.legendType){var g=o.viewExpression(e.legendLabel),v=this,y=u.map(function(t,i){return g.eval(v.getContext({d:t,value:t.value,fraction:t.fraction,label:t.data[e.label]||i}))});this.legend({scale:this.getScale("ordinal").domain(y).range(c.colors)},r)}}}),Ve=function(t,e,i){return t=v.color(t),.299*t.r+.587*t.g+.114*t.b>186?i||"#000":e||"#fff"},Ge=Qt("treemap",{requires:["d3-hierarchy"],options:{label:"label",field:"data",padding:2,tile:"resquarify",format:","},doDraw:function(t,e){function i(t){t.parent?(t.data._counter=t.parent.data._counter,t.parent.data._counter++):t.data._counter=0}function n(t){var e=w.font({height:Math.min(t.x1-t.x0,t.y1-t.y0)}),i=d(t.data).split(/(?=[A-Z][^A-Z])/g);return i.push(h(t.value)),i.map(function(t){return{size:e,text:t}})}function r(t){return[t]}function a(t){var e=void 0;return t.map(function(t){return e=t.children,e&&(t._children=a(e),delete t.children),t})}var o=this,s=this.getModel(),l=this.getModel("font"),u=this.boundingBox(),d=kt(s.label),c=kt(s.field),h=p.format(s.format),f=e.hierarchy(function(t){return t={children:a(t)},t[s.label]="root",t}(t.data)).sum(c).sort(function(t,e){return e.value-t.value}).eachBefore(i),g=e.treemap().tile(Zt(e,"treemap",s.tile,!0)).size([u.innerWidth,u.innerHeight]).round(!0).padding(s.padding),m=this.fill(f.children).colors,v=this.group().attr("transform",this.translate(u.total.left,u.total.top)).style("shape-rendering","crispEdges"),y=g(f).leaves(),x=v.selectAll("g").data(y),w=this;this.paper().size(u),x.exit().remove(),x=x.enter().append("g").attr("transform",function(t){return o.translate(t.x0,t.y0)}).merge(x).attr("transform",function(t){return o.translate(t.x0,t.y0)});var b=x.selectAll("rect").data(r);b.enter().append("rect").attr("width",function(t){return t.x1-t.x0}).attr("height",function(t){return t.y1-t.y0}).attr("fill",function(t){return m[t.data._counter]}).attr("stroke","none").on("mouseover",this.mouseOver()).on("mouseout",this.mouseOut()).merge(b).transition().attr("width",function(t){return t.x1-t.x0}).attr("height",function(t){return t.y1-t.y0}).attr("fill",function(t){return m[t.data._counter]}),b=x.selectAll("text").data(r),b.enter().append("text").style("fill",function(t){return Ve(m[t.data._counter],"#fff",l.stroke)}).selectAll("tspan").data(n).enter().append("tspan").style("font-size",function(t){return t.size}).attr("x",4).attr("y",function(t,e){return 1.5*t.size+1.2*e*t.size}).text(function(t){return t.text})}}),$e=Qt("text",{options:{label:"label",data:"data",text:'label + " " + data',sizeReduction:.7},doDraw:function(t){function e(t,e){return n.translate((e+.5)*c,0)}function i(t,e){var i=s;e&&(i=r.sizeReduction*s),n.select(this).attr("font-size",i+"px")}var n=this,r=this.getModel(),a=this.getModel("font"),o=this.boundingBox(),s=this.font(o),l=this.group(),u=this.group("chart"),d=u.selectAll("text").data(t.data),c=o.innerWidth/t.data.length,h=.4*c,f=this.dataStore,p=this.modelProperty("stroke",a);this.applyTransform(l,this.translate(o.padding.left,o.padding.top)),this.applyTransform(u,this.translate(o.margin.left,o.margin.top+o.innerHeight/2)),d.enter().append("text").attr("transform",e).attr("text-anchor","middle").attr("alignment-baseline","middle").style("fill",p).merge(d).attr("transform",e).text(function(t){return f.eval(r.text,t)}).style("fill",p).call(De,h,i),l.exit().remove()}}),Ne=Qt("heatmap",We,{options:{shape:"square",layout:"heatmap",buckets:10,pad:.005,x:"x",y:"y",z:"data",axisX:!0,axisY:!0},doDraw:function(t){var e=this.getModel(),n=this.getModel("color"),r=e.layout,a=this.boundingBox(),o=i.extent(t.data,kt(e.z));o[0]<0&&"punchcard"===r&&(r="heatmap");var s=this.heatmap(r,t,a,o),l=(a.innerWidth-s.width)/2,u=(a.innerHeight-s.height)/2,d=this.getSymbol(e.shape).size(function(t){return t.size*t.size}),c=this.group(),h=this.group("chart"),f=h.selectAll(".shape").data(s.data);this.applyTransform(c,this.translate(a.padding.left,a.padding.top)),this.applyTransform(h,this.translate(a.margin.left+l,a.margin.top+u)),i.range[0]<0&&"punchcard"===r&&(r="heatmap"),f.enter().append("path").classed("shape",!0).attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).attr("fill",function(t){return t.color}).attr("fill-opacity",0).attr("stroke-opacity",0).attr("stroke",n.stroke).attr("d",d).on("mouseover",this.mouseOver()).on("mouseout",this.mouseOut()).merge(f).transition(this.transition()).attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).attr("fill-opacity",n.fillOpacity).attr("fill",function(t){return t.color}).attr("stroke-opacity",n.strokeOpacity).attr("stroke",n.stroke).attr("d",d);var p={innerWidth:s.width,innerHeight:s.height,margin:{top:a.margin.top+u,left:a.margin.left+l}};e.axisX&&this.xAxis1(!0===e.axisX?"bottom":e.axisX,s.scaleX,p),e.axisY&&this.yAxis1(!0===e.axisY?"left":e.axisY,s.scaleY,p),"heatmap"===r?this.legend({type:"color",shape:e.shape,scale:s.colors
},a):"punchcard"===r&&this.legend({type:"size",shape:e.shape,scale:s.sizes},a)},heatmap:function(t,e,n,a){var o=this.getModel(),s=o.pad,l=o.x,u=o.y,d=o.z,c=e.dimension(o.x).group().size(),h=e.dimension(o.y).group().size(),f=Math.min(o.buckets,c*h),p=(1-s*(c+1))*n.innerWidth/c,g=(1-s*(h+1))*n.innerHeight/h,m=[],v=[],y=[],x=r.map(),w=r.map(),b=void 0,k=void 0,z=void 0,_=void 0,S=void 0,M=void 0,A=void 0,P=void 0,O=void 0,T=void 0;if(p<g?(P=p,O=n.innerWidth,s*=O,T=h*(P+s)+s):(P=g,T=n.innerHeight,s*=T,O=c*(P+s)+s),a=Oe(a,f),"heatmap"===t)M=this.getScale("quantile").range(this.colors(f).reverse()).domain(a),A=function(){return 1};else{var W=this.colors(1)[0];M=function(){return W},A=this.getScale("quantile").range(i.range(f).map(function(t){return(t+1)/f})).domain(a)}return e.data.forEach(function(t){b=t[l],k=t[u],z=t[d],x.has(b)||(x.set(b,v.length),v.push(b)),w.has(k)||(w.set(k,y.length),y.push(k)),_=x.get(b),S=w.get(k),m.push({i:_,j:S,x:s+P/2+_*(P+s),y:s+P/2+S*(P+s),color:M(z),size:P*A(z),data:t})}),{data:m,size:P,width:O,height:T,scaleX:this.getScale("band").domain(v).range([0,O]),scaleY:this.getScale("band").domain(y).range([0,T]),colors:M,sizes:A}}}),Ke=Qt("geochart",{requires:["d3-geo","topojson","d3-geo-projection"],options:{geometry:"countries",geoKey:"id",dataKey:"id",dataLabelKey:"label",dataValueKey:"value",buckets:10,choroplethScale:"quantile",boundGeometry:null,boundScaleFactor:.9,projection:null,graticule:!1,leaflet:!1,scale:200,mouseover:["darken","tooltip"]},doDraw:function(t,e){var i=this.getGeoData(t);if(!i)return Mt("Topojson data not available - cannot draw topology");this._geoPath||this.createGeoPath(e,i),this.update(e,i)},update:function(t,e){var i=this.getModel(),n=this.getModel("color"),r=this.boundingBox(),a=this.group(),o=this.group("geo"),s=this._geoPath,l=t.feature(e.topology,e.topology.objects[i.geometry]).features,u=o.selectAll(".geometry").data(l),d="none";a.transition(this.transition("group0")).attr("transform",this.translate(r.padding.left,r.padding.top)),o.transition(this.transition("group1")).attr("transform",this.translate(r.margin.left,r.margin.top)),this.center(t,e),e.data&&(d=this.choropleth(e.data,r)),u.enter().append("path").attr("class","geometry").attr("d",s).style("fill","none").style("stroke",n.stroke).style("stroke-opacity",0).style("fill-opacity",0).on("mouseover",this.mouseOver()).on("mouseout",this.mouseOut()).merge(u).transition(this.transition("geometry")).attr("d",s).style("stroke",n.stroke).style("stroke-opacity",n.strokeOpacity).style("fill",d).style("fill-opacity",n.fillOpacity),u.exit().remove()},createGeoPath:function(t,e){function i(e,i){var r=n.latLngToLayerPoint(new t.LatLng(i,e));this.stream.point(r.x,r.y)}var n,r=this.getModel(),a=Zt(t,"geo",e.projection).scale(r.scale),o=t.geoPath().projection(a),s=this;if(this._geoPath=o,this.center(t,e),r.leaflet){var l="leaflet-"+r.uid,u=this.paper();this.visualParent.paper.append("div").attr("id",l),n=new t.Map(l,{center:[37.8,-96.9],zoom:4}).addLayer(new t.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),n.getPanes().overlayPane.appendChild(u.element),a=t.transform({point:i}),n.on("viewreset",function(){return s.update(t,e)})}return o},getGeoData:function(t){var e={};if("frameCollection"===t.type)for(var i in t)"Topology"===t[i].type?e.topology=t[i]:e.data=t[i];else"Topology"===t.type&&(e.topology=t);if(e.topology){var n=this.getModel();return n.projection?e.projection=n.proection:e.projection="kavrayskiy7",e}},center:function(t,e){var i=this.getModel();if(i.boundGeometry){var n=this._geoPath,r=n.projection(),a=this.boundingBox(),o=t.feature(e.topology,e.topology.objects[i.boundGeometry]).features;r.scale(1).translate([0,0]);var s=n.bounds(o[0]),l=s[0],u=s[1],d=(u[0]-l[0])/a.innerWidth,c=(u[1]-l[1])/a.innerHeight,h=Math.round(i.boundScaleFactor/Math.max(d,c)),f=[(a.innerWidth-h*(u[0]+l[0]))/2,(a.innerHeight-h*(u[1]+l[1]))/2];r.scale(h).translate(f)}},choropleth:function(t,e){var n=this.getModel(),r=Math.min(n.buckets,t.data.length),a=n.dataKey,o=n.dataLabelKey,s=n.dataValueKey,l=n.geoKey,u=Oe(i.extent(t.data,kt(s)),r),d=this.getScale(n.choroplethScale).range(this.colors(r).reverse()).domain(u),c=t.data.reduce(function(t,e){return t[e[a]]=e,t},{}),h=void 0,f=void 0;return this.legend({type:"color",scale:d},e),function(t){return h=t.properties[l],f=c[h],t.choropleth={label:f[o]||h,value:f[s],color:d(f[s])},t.choropleth.color}}}),Ie=function(t){for(var i=[{},te,ee,Ue],n=1;n<arguments.length;++n)i.push(arguments[n]);return It(t,e.apply(void 0,i))},Ue={initialise:function(t){te.initialise.call(this,t);var i=this.getLayers();a.isArray(i)&&i.length||(Mt("a composite chart requires layers"),i=[]),Object.defineProperties(this,{element:{get:function(){return this.visualParent.element}},paperElement:{get:function(){return this.visualParent.paperElement}},sel:{get:function(){return this.visualParent.sel}},width:{get:function(){return this.boundingBox().innerWidth}},height:{get:function(){return this.boundingBox().innerHeight}}});var n=this,o=r.set(),s=void 0,l=void 0,u=void 0;this.layers=[],i.forEach(function(t){t=e({},t),l=a.pop(t,"type"),u=Nt.types[l],u?(t[l]=e({},t[l],n.options[l]),s=new u(n.element,t,n),s.requires&&s.requires.forEach(function(t){return o.add(t)})):Mt('Cannot add visual type "'+l+'", not available')}),this.requires=o.values(),this.requires.length||delete this.requires},getLayers:function(){},layerOptions:function(t){return e(t,this.options)},getPaperGroup:function(t){var e=this.boundingBox(),i=this.group("layers");return this.applyTransform(i,this.translate(e.margin.left,e.margin.top)),this.paper().childGroup(i,t)},doDraw:function(t,e){var i=this.boundingBox();this.applyTransform(this.group(),this.translate(i.padding.left,i.padding.top)),this.layers.forEach(function(i){return i.doDraw(t,e)})}};t.visualizeVersion="0.2.1",t.randomPath=ft,t.DataStore=_,t.dataSources=Rt,t.visuals=Nt,t.createChart=Qt,t.createPaper=F,t.Svg=ne,t.Div=re,t.visualTransforms=Bt,t.visualComponents=Me,t.colorScales=ge,t.pyramid=Pe,t.niceRange=Oe,t.Visual=Ut,t.BarChart=Ee,t.BoxChart=He,t.LineChart=Ce,t.AreaChart=je,t.PieChart=Xe,t.PyramidChart=Le,t.Treemap=Ge,t.TextChart=$e,t.Heatmap=Ne,t.GeoChart=Ke,t.createCompositeChart=Ie,Object.defineProperty(t,"__esModule",{value:!0})});