// d3-view Version 0.1.9. Copyright 2016 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-timer"),require("d3-selection"),require("d3-collection"),require("d3-dispatch"),require("d3-transition")):"function"==typeof define&&define.amd?define("d3-view",["exports","d3-timer","d3-selection","d3-collection","d3-dispatch","d3-transition"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,r,n,i,o){"use strict";function a(t){if(null===t||void 0===t)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}function s(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var e={},r=0;r<10;r++)e["_"+String.fromCharCode(r)]=r;var n=Object.getOwnPropertyNames(e).map(function(t){return e[t]});if("0123456789"!==n.join(""))return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(t){i[t]=t}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},i)).join("")}catch(t){return!1}}function u(){return s()?Object.assign:function(t){for(var e,r,n=a(t),i=1;i<arguments.length;i++){e=Object(arguments[i]);for(var o in e)pt.call(e,o)&&(n[o]=e[o]);if(Object.getOwnPropertySymbols){r=Object.getOwnPropertySymbols(e);for(var s=0;s<r.length;s++)vt.call(e,r[s])&&(n[r[s]]=e[r[s]])}}return n}}function c(t){return"[object Object]"===ft.call(t)}function l(t){return"[object String]"===ft.call(t)}function f(t){return"[object Function]"===ft.call(t)}function d(t){return"[object Array]"===ft.call(t)}function h(t){return"[object Promise]"===ft.call(t)}function p(){this._array=[]}function v(t,e){var r=new p;if(t instanceof p)t.each(function(t,e){r.set(e,t)});else if(Array.isArray(t)){var n,i=-1,o=t.length;if(null==e)for(;++i<o;)r.set(i,t[i]);else for(;++i<o;)r.set(e(n=t[i],i,t),n)}else if(t)for(var a in t)r.set(a,t[a]);return r}function m(t,e){switch(e.type){case bt.IDENTIFIER:return t[e.name];case bt.LITERAL:return e.value;case bt.ARRAY_EXP:return e.elements.map(function(e){return m(t,e)});case bt.LOGICAL_EXP:case bt.BINARY_EXP:return E(e.operator,m(t,e.left),m(t,e.right));case bt.CALL_EXP:return g(t,e.callee,e.arguments);case bt.MEMBER_EXP:return m(m(t,e.object),e.property);case bt.CONDITIONAL_EXP:return m(t,e.test)?m(t,e.consequent):m(t,e.alternate);case bt.UNARY_EXP:return b(e.operator,m(t,e.argument))}}function y(t,e){switch(1===arguments.length&&(e=n.set()),t.type){case bt.IDENTIFIER:e.add(t.name);break;case bt.ARRAY_EXP:t.elements.forEach(function(t){y(t,e)});break;case bt.BINARY_EXP:y(t.left,e),y(t.right,e);break;case bt.CALL_EXP:y(t.arguments,e);break;case bt.MEMBER_EXP:y(t.object,e);break;case bt.CONDITIONAL_EXP:y(t.test,e),y(t.consequent,e),m(t.alternate,e)}return e}function g(t,e,r){var n;return r=r.map(function(e){return m(t,e)}),e.type!==bt.IDENTIFIER&&(t=m(t,e.object),e=e.property),n=t[e.name],n.apply(t,r)}function b(t,e){return Gt[t]||(Gt[t]=new Function("arg","return "+t+" arg")),Gt[t](e)}function E(t,e,r){return Vt[t]||(Vt[t]=new Function("a","b","return a "+t+" b")),Vt[t](e,r)}function w(){if(dt)return window.fetch}function x(t){this.codes=bt,this.expr=t,this.parsed=Yt(t)}function _(t){return arguments.length?this.property("__model__",t):this.node().__model__}function O(t,e){for(;!(e in t)&&t.$parent;)t=t.$parent;return t}function P(t,e,r){function n(e){s&&(e=s.get.call(t)),e!==r&&(l(r),r=e)}function o(){var i={get:function(){return r}};return f(r)&&(r={get:r}),c(r)&&f(r.get)?(s=r,r=s.get.call(t),s.reactOn?s.reactOn.forEach(function(r){t.$on(r+"."+e,n)}):t.$on("."+e,n),f(s.set)&&(i.set=s.set)):i.set=n,i}var a,s,u=t.$events;u.set(e,i.dispatch("change")),Object.defineProperty(t,e,o());var l=ae(function(){a=arguments[0],u.get(e).call("change",t,r,a),s||u.get("").call("change",t,e)});l()}function C(t,e){var r=t.$events.get(e);return!r&&t.parent?C(t.parent,e):r}function j(t){function e(t){ie(this,t)}return e.prototype=t,e}function I(t,e){return!this.$events.has(t)&&this.$parent?I.call(this.$parent,t,e):void this.$set(t,e)}function $(t){ie(this,t)}function A(t){return new $(t)}function L(t){var e=this,r=A(t);return Object.defineProperty(r,"parent",{get:function(){return e}}),r}function N(t){return arguments.length?this.property("__directives__",t):this.node().__directives__}function k(){this.attrs={},this._dirs={},this._all=[]}function S(t,e){var n=r.select(e),i=n.directives();i||(i=he(e,t.$vm?t.$vm.directives:null),t=fe(i,null,t));var o=i.pop("for");return o?(o.execute(t),!0):(n.model()||n.model(t),void T(n,i))}function T(t,e){var n=t.model(),i=n.$vm;t.selectAll(function(){return this.children}).each(function(){var t=i?i.components.get(this.tagName.toLowerCase()):null;if(t)t({parent:i}).mount(this);else{S(n,this);var e=r.select(this);e.model()===n&&e.model(null)}}),e.size()?e.forEach(function(t){t.execute(n)}):t.directives(null)}function D(t){function e(t){this.el=t}function n(t){var n=new e(t);return Object.defineProperty(n,"value",{get:function(){return r.select(n.el).property("value")},set:function(t){r.select(n.el).property("value",t)}}),n}return e.prototype=mt({},ge,t),n.prototype=e.prototype,n}function R(t,e,r){return ae(function(){e.$set(r,t.value)})}function X(t){var e=dt?window.handlebars:require("handlebars");return e?e.compile(t):void Wt("compile function requires handlebars")}function M(t,e){if(l(t)){if(!e)return t;var r=X(t);if(!r)return t}return t(e)}function q(t,e){var n=r.select(document.createElement("div"));n.html(M(t,e));var i=n.node().children;return 1!==i.length&&Wt("HtmlElement function should return one root element only, got "+i.length),i[0]}function U(t,e){function r(t){var e=yt(t,"parent"),r=n.map(e?e.components:null),o=n.map(e?e.directives:Le),a=i.dispatch("message");s.each(function(t,e){r.set(e,t)}),u.each(function(t,e){o.set(e,t)}),B(r,yt(t,"components")),F(o,yt(t,"directives")),Object.defineProperties(this,{components:{get:function(){return r}},directives:{get:function(){return o}},parent:{get:function(){return e}},root:{get:function(){return e?e.root:this}},props:{get:function(){return l}},uid:{get:function(){return this.model.uid}},events:{get:function(){return a}}}),this.model=mt({},c,yt(t,"model")),this.init(t)}function o(t){return new r(t)}e=e||ke,f(t)&&(t={render:t});var a=mt({},t),s=B(n.map(),yt(a,"components")),u=F(n.map(),yt(a,"directives")),c=yt(a,"model"),l=yt(a,"props");return r.prototype=mt({},e,a),o.prototype=r.prototype,o}function B(t,e){return n.map(e).each(function(e,r){t.set(r,U(e,Se))}),t}function F(t,e){return n.map(e).each(function(e,r){t.set(r,ne(e))}),t}function H(t,n){var i=t.model;Object.defineProperty(ee(t),"el",{get:function(){return n}}),Object.defineProperty(i,"$vm",{get:function(){return t}}),r.select(n).model(i),S(i,n),e.timeout(function(){t.mounted()})}function Y(t){if(!t)return Wt("element not defined, pass an identifier or an HTMLElement object");var e=f(t.node)?t:r.select(t),n=e.node();return n?n:void Wt("could not find "+t+" element")}function G(t){var e=t.isMounted;return e||Object.defineProperty(t,"isMounted",{get:function(){return!0}}),e}function V(t,e,n){return n?(n=$e(n),1!==n.size()&&Wt("render function must return a single HTML node"),n=n.node(),e.parentNode.insertBefore(n,e),r.select(e).remove(),void H(t,n)):Wt("render function must return a single HTML node. It returned nothing!")}function z(){document.removeEventListener("DOMContentLoaded",z),window.removeEventListener("load",z),J()}function J(){for(var t=void 0;Re.length;)t=Re.shift(),e.timeout(t)}function W(t){var e=this;return new Promise(function(t){t()}).then(function(){return t.call(e)})}function K(t){var e=t.type||"text";return Fe[e]||e}function Q(t){var e=this.data.children;if(e){if(!d(e))return qe("children should be an array of fields, for "+("undefined"==typeof e?"undefined":Ue(e))),t;t.selectAll(".d3form").data(e).enter().append(tt).classed("d3form",!0)}return t}function Z(t){t||(t={}),this.data=t;var e=this.model;return Be.forEach(function(r){r in t&&e.$set(r,t[r])}),t}function tt(t){var e=K(t);return e||(qe("Could not find form component "+t.type),e="input",t.type="hidden"),document.createElement("d3"+e)}function et(t){var e=t.formTheme;return!e&&t.parent?et(t.parent):e}function rt(t){var e=t.attr("min"),r=t.attr("max");return e=null===e?-(1/0):+e,r=null===r?1/0:+r,[e,r]}function nt(t,e){return{set:function(e,r){var n=r[t]},validate:function(t,r){return e(t,r)}}}function it(){return d(this.option)?this.option[0]:this.option}function ot(){return d(this.option)?this.option[1]||this.option[0]:this.option}function at(t){var e=t.json();this.message(e)}function st(){window.location.href=this.data.redirectTo||"/"}function ut(t){function e(t){n.setSubmitDone(),n.response(t)}function r(){n.setSubmitDone()}var n=this&&this.model?this.model.form:null;if(!n)return void qe("form not available, cannot submit");t&&(t.preventDefault(),t.stopPropagation());var i=Xe.fetch,o=(n.data.enctype||"").split(";")[0],a=n.data.action,s=c(a)?a.url:a,u=n.inputData(),l={};if(!i)return void qe("fetch provider not available, cannot submit");if(!s)return void qe("No url, cannot submit");if("application/json"===o)l.headers={"Content-Type":n.data.enctype},l.body=JSON.stringify(u);else{l.body=new FormData;for(var f in u)l.body.set(f,u[f])}n.setSubmit(),l.method=n.method||"post",i(s,l).then(e,r)}function ct(t){var e=t.label||t.name;return"<label for="+t.id+' class="control-label" d3-class="[required, labelSrOnly ? \'sr-only\' : null]">'+e+"</label>\n<slot></slot>"}function lt(t,e){return'<div class="input-group" :class="bootstrapStatus()">\n<span class="input-group-addon" id="'+t+'">'+e+"</span>\n<slot></slot>\n</div>"}var ft=Object.prototype.toString,dt="undefined"!=typeof window&&"[object Object]"!==ft.call(window),ht=dt?window.console:require("console"),pt=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable,mt=u(),yt=function(t,e){var r=void 0;if(c(t))return r=t[e],delete t[e],r;if(d(t)){var n=+e;return n===n?t.splice(n,1)[0]:(r=t[e],delete t[e],r)}},gt="$";p.prototype=v.prototype={constructor:p,size:function(){return this._array.length},get:function(t){return this[gt+t]},set:function(t,e){return this.has(t)||this._array.push(t),this[gt+t]=e,this},has:function(t){return gt+t in this},clear:function(){var t=this;this.each(function(e,r){delete t[gt+r]}),this._array.splice(0)},keys:function(){var t=[];return this.each(function(e,r){t.push(r)}),t},values:function(){var t=[];return this.each(function(e){t.push(e)}),t},each:function(t){for(var e,r=this._array,n=0;n<r.length;++n)e=r[n],t(this.get(e),e,n)}};var bt={COMPOUND:"Compound",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",LOGICAL_EXP:"LogicalExpression",CONDITIONAL_EXP:"ConditionalExpression",ARRAY_EXP:"ArrayExpression"},Et=46,wt=44,xt=39,_t=34,Ot=40,Pt=41,Ct=91,jt=93,It=63,$t=59,At=58,Lt=function(t,e){var r=new Error(t+" at character "+e);throw r.index=e,r.description=t,r},Nt=!0,kt={"-":Nt,"!":Nt,"~":Nt,"+":Nt},St={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},Tt=function(t){var e,r=0;for(var n in t)(e=n.length)>r&&t.hasOwnProperty(n)&&(r=e);return r},Dt=Tt(kt),Rt=Tt(St),Xt={true:!0,false:!1,null:null},Mt="this",qt=function(t){return St[t]||0},Ut=function(t,e,r){var n="||"===t||"&&"===t?bt.LOGICAL_EXP:bt.BINARY_EXP;return{type:n,operator:t,left:e,right:r}},Bt=function(t){return t>=48&&t<=57},Ft=function(t){return 36===t||95===t||t>=65&&t<=90||t>=97&&t<=122||t>=128&&!St[String.fromCharCode(t)]},Ht=function(t){return 36===t||95===t||t>=65&&t<=90||t>=97&&t<=122||t>=48&&t<=57||t>=128&&!St[String.fromCharCode(t)]},Yt=function(t){for(var e,r,n=0,i=t.charAt,o=t.charCodeAt,a=function(e){return i.call(t,e)},s=function(e){return o.call(t,e)},u=t.length,c=function(){for(var t=s(n);32===t||9===t;)t=s(++n)},l=function t(){var e,r,i=d();return c(),s(n)!==It?i:(n++,e=t(),e||Lt("Expected expression",n),c(),s(n)===At?(n++,r=t(),r||Lt("Expected expression",n),{type:bt.CONDITIONAL_EXP,test:i,consequent:e,alternate:r}):void Lt("Expected :",n))},f=function(){c();for(var e=t.substr(n,Rt),r=e.length;r>0;){if(St.hasOwnProperty(e))return n+=r,e;e=e.substr(0,--r)}return!1},d=function(){var t,e,r,i,o,a,s,u;if(a=h(),e=f(),!e)return a;for(o={value:e,prec:qt(e)},s=h(),s||Lt("Expected expression after "+e,n),i=[a,o,s];(e=f())&&(r=qt(e),0!==r);){for(o={value:e,prec:r};i.length>2&&r<=i[i.length-2].prec;)s=i.pop(),e=i.pop().value,a=i.pop(),t=Ut(e,a,s),i.push(t);t=h(),t||Lt("Expected expression after "+e,n),i.push(o,t)}for(u=i.length-1,t=i[u];u>1;)t=Ut(i[u-1].value,i[u-2],t),u-=2;return t},h=function e(){var r,i,o;if(c(),r=s(n),Bt(r)||r===Et)return p();if(r===xt||r===_t)return v();if(Ft(r)||r===Ot)return g();if(r===Ct)return E();for(i=t.substr(n,Dt),o=i.length;o>0;){if(kt.hasOwnProperty(i))return n+=o,{type:bt.UNARY_EXP,operator:i,argument:e(),prefix:!0};i=i.substr(0,--o)}return!1},p=function(){for(var t,e,r="";Bt(s(n));)r+=a(n++);if(s(n)===Et)for(r+=a(n++);Bt(s(n));)r+=a(n++);if(t=a(n),"e"===t||"E"===t){for(r+=a(n++),t=a(n),"+"!==t&&"-"!==t||(r+=a(n++));Bt(s(n));)r+=a(n++);Bt(s(n-1))||Lt("Expected exponent ("+r+a(n)+")",n)}return e=s(n),Ft(e)?Lt("Variable names cannot start with a number ("+r+a(n)+")",n):e===Et&&Lt("Unexpected period",n),{type:bt.LITERAL,value:parseFloat(r),raw:r}},v=function(){for(var t,e="",r=a(n++),i=!1;n<u;){if(t=a(n++),t===r){i=!0;break}if("\\"===t)switch(t=a(n++)){case"n":e+="\n";break;case"r":e+="\r";break;case"t":e+="\t";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+="\\"+t}else e+=t}return i||Lt('Unclosed quote after "'+e+'"',n),{type:bt.LITERAL,value:e,raw:r+e+r}},m=function(){var e,r=s(n),i=n;for(Ft(r)?n++:Lt("Unexpected "+a(n),n);n<u&&(r=s(n),Ht(r));)n++;return e=t.slice(i,n),Xt.hasOwnProperty(e)?{type:bt.LITERAL,value:Xt[e],raw:e}:e===Mt?{type:bt.THIS_EXP}:{type:bt.IDENTIFIER,name:e}},y=function(t){for(var e,r,i=[],o=!1;n<u;){if(c(),e=s(n),e===t){o=!0,n++;break}e===wt?n++:(r=l(),r&&r.type!==bt.COMPOUND||Lt("Expected comma",n),i.push(r))}return o||Lt("Expected "+String.fromCharCode(t),n),i},g=function(){var t,e;for(t=s(n),e=t===Ot?b():m(),c(),t=s(n);t===Et||t===Ct||t===Ot;)n++,t===Et?(c(),e={type:bt.MEMBER_EXP,computed:!1,object:e,property:m()}):t===Ct?(e={type:bt.MEMBER_EXP,computed:!0,object:e,property:l()},c(),t=s(n),t!==jt&&Lt("Unclosed [",n),n++):t===Ot&&(e={type:bt.CALL_EXP,arguments:y(Pt),callee:e}),c(),t=s(n);return e},b=function(){n++;var t=l();return c(),s(n)===Pt?(n++,t):void Lt("Unclosed (",n)},E=function(){return n++,{type:bt.ARRAY_EXP,elements:y(jt)}},w=[];n<u;)e=s(n),e===$t||e===wt?n++:(r=l())?w.push(r):n<u&&Lt('Unexpected "'+a(n)+'"',n);return 1===w.length?w[0]:{type:bt.COMPOUND,body:w}};Yt.addUnaryOp=function(t){return Dt=Math.max(t.length,Dt),kt[t]=Nt,this},Yt.addBinaryOp=function(t,e){return Rt=Math.max(t.length,Rt),St[t]=e,this},Yt.addLiteral=function(t,e){return Xt[t]=e,this},Yt.removeUnaryOp=function(t){return delete kt[t],t.length===Dt&&(Dt=Tt(kt)),this},Yt.removeBinaryOp=function(t){return delete St[t],t.length===Rt&&(Rt=Tt(St)),this},Yt.removeLiteral=function(t){return delete Xt[t],this};var Gt={},Vt={},zt={logger:ht,fetch:w()},Jt="[d3-view]",Wt=function(t){zt.logger.warn(Jt+" "+t)},Kt={eval:function(t){return m(t,this.parsed)},safeEval:function(t){try{return m(t,this.parsed)}catch(t){Wt("Could not evaluate <<"+this.expr+">> expression: "+t)}},identifiers:function(){return y(this.parsed).values()}};x.prototype=Kt;var Qt=function(t){try{return new x(t)}catch(e){Wt("Could not parse <<"+t+">> expression: "+e)}},Zt=0,te=function(t){var e=++Zt;return Object.defineProperty(t,"uid",{get:function(){return e}}),t},ee=function(t){return Object.defineProperty(t,"sel",{get:function(){return r.select(this.el)}}),t},re={priority:1,create:function(t){return t},mount:function(t){return t},refresh:function(){},destroy:function(){},removeAttribute:function(){this.el.removeAttribute(this.name)},execute:function(t){var e=this;if(this.expression&&(this.removeAttribute(),t=this.mount(t))){var r=this,n=this.sel,i=function(){try{r.refresh(t,r.expression.eval(t))}catch(t){Wt('Error while refreshing "'+r.name+'" directive: '+t)}};this.identifiers=this.expression.identifiers().map(function(e){var n=e+"."+r.uid;return t.$on(n,i),e}),n.on("remove."+r.uid,function(){e.identifiers.forEach(function(e){t.$off(e+"."+r.uid)}),r.destroy(t)}),i()}}},ne=function(t){function e(t,e,r){this.el=t,this.name=e.name,this.arg=r;var n=ee(te(this)).create(e.value);n&&(this.expression=Qt(n))}function r(t,r,n){return new e(t,r,n)}return e.prototype=mt({},re,t),r.prototype=e.prototype,r};r.selection.prototype.model=_;var ie=function(t,e){var r=n.map();r.set("",i.dispatch("change")),Object.defineProperty(te(t),"$events",{get:function(){return r}}),t._Child=null,t.$update(e)},oe=function(t){var e=t.split("."),r=e.splice(0,1),n=O(this,r);if(r in n){for(var i=n[r];i&&e.length;)i=i[e.splice(0,1)];return i}},ae=function(t){var r=!1;return function(){if(!r){var n=Array.prototype.slice.call(arguments);r=!0,e.timeout(function(){r=!1,t.apply(void 0,n)})}}},se=function(t,e){this.$events.get(t)?this[t]=e:P(this,t,e)},ue=function(t,e){1===arguments.length&&f(t)&&(e=t,t="");var r=t.split("."),n=r[0],i=C(this,n);return i?(this.$events.get(t)||r.push(this.uid),r[0]="change",i.on(r.join("."),e)):Wt('Cannot bind to "'+n+'" - no such reactive property')},ce=function(t){if(t)for(var e in t)"$"===e.substring(0,1)?this.constructor.prototype[e]?Wt("Cannot set attribute method "+e+", it is protected"):this[e]=t[e]:this.$set(e,t[e]);return this},le=function(t){this._Child||(this._Child=j(this));var e=this,r=new this._Child(t);return Object.defineProperty(r,"parent",{get:function(){return e}}),r};A.prototype=$.prototype,$.prototype.$on=ue,$.prototype.$update=ce,$.prototype.$get=oe,$.prototype.$set=se,$.prototype.$child=le,$.prototype.$new=L,$.prototype.$setbase=I;var fe=function(t,e,r){var n=t.pop("model");if(t.get("for")&&!r&&(Wt('Cannot have a "d3-for" directive in the root view element'),t.pop("for")),!r)return n&&Wt("Cannot have a d3-model directive in the root element"),A(e);if(n){n.execute(r);var i=n.sel.model();return i&&i.$update(e),i}return e?r.$child(e):r},de=["name","class","disabled","readonly","required"];r.selection.prototype.directives=N;var he=function(t,e){var n=r.select(t),i=n.directives();if(i)return i;if(i=new k,n.directives(i),!e)return i;for(var o=0;o<t.attributes.length;++o){var a=t.attributes[o],s=a.name.split("-"),u=s[2],c="d3"===s[0]?s[1]:null;if(c){!u&&de.indexOf(c)>-1&&(u=c,c="attr");var l=e.get(c);l?i.add(c,l(t,a,u)):Wt(t.tagName+' cannot find directive "'+c+'". Did you forget to register it?')}i.attrs[a.name]=a.value}return i.sorted()};k.prototype={size:function(){return this._all.length},get:function(t){return this._dirs[t]},pop:function(t){var e=this._dirs[t];if(e){delete this._dirs[t],e.removeAttribute();var r=this._all.indexOf(e);r>-1&&this._all.splice(r,1)}return e},add:function(t,e){this._dirs[t]=e,this._all.push(e)},sorted:function(){return this._all.sort(function(t){return-t.priority}),this},forEach:function(t){this._all.forEach(t)}};var pe={mount:function(t){var e=this.expression;if(e.parsed.type!==e.codes.IDENTIFIER)return Wt('d3-model expression support identifiers only, got "'+e.parsed.type+'": '+this.expression);var r=t.$child(e.eval(t));this.sel.model(r),t.$setbase(this.expression.expr,r)}},ve=["disabled","readonly","required"],me={create:function(t){return this.arg?t:Wt("Cannot bind to empty attribute. Specify :<attr-name>")},refresh:function(t,e){return"class"===this.arg?this.refreshClass(e):d(e)?Wt("Cannot apply array to attribute "+this.arg):void(ve.indexOf(this.arg)>-1?this.sel.property(this.arg,e||null):this.sel.attr(this.arg,e))},refreshClass:function(t){var e=this.sel;d(t)||(t=[t]),this.oldValue&&this.oldValue.forEach(function(t){t&&e.classed(t,!1)}),this.oldValue=t.map(function(t){var r=!0;return d(t)&&(r=t[1],t=t[0]),t&&e.classed(t,r),t})}},ye={refresh:function(t,e){l(e)&&this.sel.html(e)}},ge={on:function(t,e){var n=R(this,t,e);r.select(this.el).on("input",n).on("change",n)}},be=D(),Ee=D(),we={input:be,textarea:Ee},xe={create:function(t){var e=this.sel.attr("type"),r=this.el.tagName.toLowerCase(),n=we[e]||we[r];return n?(this.tag=new n(this.el),t):Wt("Cannot apply d3-value directive to "+r)},mount:function(t){var e=this.expression;if(e.parsed.type!==e.codes.IDENTIFIER)return Wt('d3-value expression support identifiers only, got "'+e.parsed.type+'": '+this.expression);var r=this.expression.expr;return t.$set(r,this.tag.value),this.tag.on(t,r),t},refresh:function(t,e){this.tag.value=e},destroy:function(){this.tag.off()}},_e={mount:function(t){return this.block=this.sel.style("display")?"block":null,t},refresh:function(t,e){e?this.sel.style("display",this.block):this.sel.style("display","none")}},Oe={mount:function(t){var e=this.arg||"click",r=this.expression;this.sel.on(e+"."+this.uid,function(){r.eval(t)})}},Pe={refresh:function(t){o.transition(t)}},Ce={create:function(t){var e=[];return t.trim().split(" ").forEach(function(t){t?e.push(t):null}),3!==e.length||"in"!=e[1]?Wt('d3-for directive requires "item in expression" template'):(this.itemName=e[0],this.itemClass="for"+this.uid,e[2])},mount:function(t){return this.creator=this.el,this.el=this.creator.parentNode,r.select(this.creator).remove(),t},refresh:function(t,e){if(d(e)){var r=this.creator,n=r.tagName+"."+this.itemClass,i=this.itemName,o=this.sel.selectAll(n).data(e);o.enter().append(function(){return r.cloneNode(!0)}).classed(this.itemClass,!0).each(function(e,r){var n={index:r};n[i]=e,S(t.$child(n),this)}),o.exit().remove()}}},je={refresh:function(t,e){e?this.sel.style("display",null):this.sel.style("display","none")}},Ie={model:pe,attr:me,html:ye,value:xe,show:_e,on:Oe,transition:Pe,for:Ce,if:je},$e=function(t){return t&&!f(t.size)?r.select(t):t},Ae=function(t){if(l(t))try{return JSON.parse(t)}catch(e){return t}return t},Le=F(n.map(),Ie),Ne={isd3:!0,providers:zt,htmlElement:q,viewElement:q,init:function(){},mounted:function(){},createElement:function(t){return r.select(document.createElement(t))},responseError:function(t){var e=this;t.json().then(function(r){e.error(r,t)})},error:function(t){t.level="error",this.message(t)},message:function(t){var e=this;this.root.events.call("message",e,t)},fetch:function t(e,r){var t=zt.fetch;return 1==arguments.length?t(e):t(e,r)}},ke=mt({},Ne,{use:function(t){return c(t)?t.install(this):t(this),this},addComponent:function(t,e){if(this.isMounted)return Wt("already mounted, cannot add component");var r=U(e,Se);return this.components.set(t,r),r},addDirective:function(t,e){if(this.isMounted)return Wt("already mounted, cannot add directive");var r=ne(e);return this.directives.set(t,r),r},mount:function(t){if(G(this))Wt("already mounted");else if(t=Y(t)){var e=this.parent?this.parent.model:null;this.model=fe(he(t,this.directives),this.model,e),H(this,t)}return this}}),Se=mt({},Ne,{render:function(){},mount:function(t){if(G(this))Wt("already mounted");else{var e=this.parent?this.parent.model:null,n=he(t,this.directives),i=fe(n,this.model,e);if(this.model=i,S(this.model,t))return;var o=r.select(t).datum()||{};if(d(this.props)){var a,s;this.props.forEach(function(t){a=n.attrs[t],s=i[a]?i[a]:Ae(a),o[t]=s})}var u=this.render(o,n.attrs);if(h(u)){var c=this;u.then(function(e){V(c,t,e)})}else V(this,t,u)}return this}}),Te=U(),De=function(t){Re.push(t),"complete"!==document.readyState?(document.addEventListener("DOMContentLoaded",z),window.addEventListener("load",z)):J()},Re=[],Xe={logger:ht},Me="[d3-form]",qe=function(t){Xe.logger.warn(Me+" "+t)},Ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Be=(function(){function t(t){this.value=t}function e(e){function r(t,e){return new Promise(function(r,i){var s={key:t,arg:e,resolve:r,reject:i,next:null};a?a=a.next=s:(o=a=s,n(t,e))})}function n(r,o){try{var a=e[r](o),s=a.value;s instanceof t?Promise.resolve(s.value).then(function(t){n("next",t)},function(t){n("throw",t)}):i(a.done?"return":"normal",a.value)}catch(t){i("throw",t)}}function i(t,e){switch(t){case"return":o.resolve({value:e,done:!0});break;case"throw":o.reject(e);break;default:o.resolve({value:e,done:!1})}o=o.next,o?n(o.key,o.arg):a=null}var o,a;this._invoke=r,"function"!=typeof e.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new e(t.apply(this,arguments))}},await:function(e){return new t(e)}}}(),["labelSrOnly","layout"]),Fe={text:"input",password:"input",number:"input"},He={render:function(t){var e=this.createElement("fieldset");return Z.call(this,t),Q.call(this,e)}},Ye={wrap:function t(e){var r=this,n=et(r),i=n?n[e.attr("type")]||n[e.node().tagName.toLowerCase()]:null;if(!i||!n.wrappers)return e;var t,o=e;return i.forEach(function(i){t=n.wrappers[i],t?o=t.call(r,o,e):qe("Could not find form field wrapper "+i)}),o},wrapTemplate:function(t,e){var n=document.createElement("div"),i=r.select(n).html(e),o=i.select("slot");if(!o.size())return qe("template does not provide a slot element"),t;var a=r.select(o.node().parentNode);return t.nodes().forEach(function(t){a.insert(function(){return t},"slot")}),o.remove(),r.selectAll(n.children)}},Ge=mt({model:{error:"",isDirty:!1,showError:{reactOn:["error","isDirty","formSubmitted"],get:function(){return!!this.error&&(this.isDirty||this.formSubmitted)}}},mounted:function(){this.model.$on("value",function(){this.isDirty=!0})},inputData:function(t){return t=Z.call(this,t),t.name||qe("Input field without a name"),t.placeholder=t.placeholder||t.label||t.name,t.id=t.id||"d3f"+this.uid,this.model.inputs[t.name]=this.model,t}},Ye),Ve={set:function(t,e){var r=e.required;l(r)?t.attr("d3-required",r):t.property("required",r||null)},validate:function(t,e){if(t.property("required")){if(!e)return"required"}else if(""===e)return!0}},ze={set:function(t,e){var r=e.minlength;l(r)?t.attr("d3-attr-minlength",r):void 0!==r&&t.attr("minlength",r)},validate:function(t,e){var r=+t.attr("minlength");if(r===r&&r>0&&e.length<r)return"too short - "+r+" characters or more expected"}},Je={set:function(t,e){var r=e.maxlength;l(r)?t.attr("d3-attr-maxlength",r):void 0!==r&&t.attr("maxlength",r)},validate:function(t,e){var r=+t.attr("maxlength");if(r===r&&r>0&&e.length>r)return"too long - "+r+" characters or less expected"}},We={set:function(t,e){var r=e.min;l(r)?t.attr("d3-attr-min",r):void 0!==r&&t.attr("min",r)},validate:function(t,e){var r=rt(t);if(r&&+e<r[0])return"must be greater or equal "+r[0]}},Ke={set:function(t,e){var r=e.max;l(r)?t.attr("d3-attr-max",r):void 0!==r&&t.attr("max",r)},validate:function(t,e){var r=rt(t);if(r&&+e>r[1])return"must be less or equal "+r[1]}},Qe={get:function(t,e){var r=this.all.slice(0);if(c(e))for(var n in e)r.push(nt(n,e[n]));return r},set:function(t,e){t.model.validators.forEach(function(r){r.set(e,t.data)}),t.model.$on(this.validate)},validate:function(t){if("value"===t){for(var e,r,n=this.$vm,i=this.validators,o=n.sel.attr("id")===n.data.id?n.sel:n.sel.select("#"+n.data.id),a=this.value,s=0;s<i.length;++s)if(e=i[s],r=e.validate(o,a)){r===!0&&(r="");break}this.error=r||""}},all:[Ve,ze,Je,We,Ke]},Ze=mt({render:function(t){t=this.inputData(t);var e=this.createElement("input").attr("id",t.id).attr("type",t.type||"text").attr("name",t.name).attr("d3-value","value").attr("placeholder",t.placeholder);return Qe.set(this,e),this.wrap(e)}},Ge),tr=mt({render:function(t){t=this.inputData(t);var e=this.createElement("textarea").attr("id",t.id).attr("name",t.name).attr("placeholder",t.placeholder).attr("d3-value","value").attr("d3-validate","validators");return Qe.set(this,e),this.wrap(e)}},Ge),er=mt({},Ge,{model:mt({options:[],$optionLabel:ot,$optionValue:it},Ge.model),render:function(t){t=this.inputData(t);var e=this.createElement("select").attr("id",t.id).attr("name",t.name).attr("d3-value","value").attr("placeholder",t.placeholder);return this.model.options=t.options,e.append("option").attr("d3-for","option in options").attr("d3-html","$optionLabel()").attr("d3-attr-value","$optionValue()"),Qe.set(this,e),this.wrap(e)}}),rr=mt({render:function(t){t=Z.call(this,t),t.type=t.type||"submit",this.model.$set("error",!1),l(t.disabled)||(this.model.$set("disabled",t.disabled||null),t.disabled="disabled"),t.click||(t.click="$vm.click()");var e=this.createElement("button").attr("type",t.type).attr("name",t.name).attr("d3-attr-disabled",t.disabled).attr("d3-on-click",t.click).html(t.label||"submit");return this.wrap(e)},click:function(){this.model.form.actions.submit.call(this,r.event)}},Ye),nr={default:at,redirect:st},ir={submit:ut},or={props:["json"],model:{formSubmitted:!1,formPending:!1},components:{d3fieldset:He,d3input:Ze,d3textarea:tr,d3select:er,d3submit:rr},render:function(t){function e(e){Z.call(i,e),r.validators=Qe.get(r,t.validators),i.actions={};for(var o in ir){var a=i.data[o];l(a)&&(a=i.model.$get(a)),i.actions[o]=a||ir[o]}return Q.call(i,n),n}var r=this.model,n=this.createElement("form").attr("novalidate",""),i=this;r.inputs={},r.form=this;var o=t.json;if(l(o)){var a=Xe.fetch;return a(o,{method:"GET"}).then(function(t){return 200===t.status?t.json().then(e):void qe("Could not load form from "+o+": status "+t.status)})}return e(o)},inputData:function(){var t,e=this.model.inputs,r={};for(var n in e)t=e[n].value,void 0!==t&&(r[n]=t);return r},setSubmit:function(){var t=this;return this.model.formSubmitted=!0,this.model.formPending=!0,W.call(this,function(){return t.isValid()})},setSubmitDone:function(){this.model.formPending=!1},isValid:function(){var t;for(var e in this.model.inputs)if(t=this.model.inputs[e],t.error)return!1;return!0},inputError:function(t){var e=this.model.inputs[t.name];e||(qe("Unknown input, cannot set input error"),this.error(t))},response:function(t){if(t){var e;if(t.status)t.status<300?this.data.resultHandler?(e=nr[this.data.resultHandler],e?e.call(this,t):qe("Could not find "+this.data.resultHandler+" result handler")):nr.default.call(this,t):this.responseError(t);else if(t.error)this.error(t.error);else if(d(t.errors)){var r=this;t.errors.forEach(function(t){r.inputError(t)})}else this.data.resultHandler?(e=nr[this.data.resultHandler],e?e.call(this,t):qe("Could not find "+this.data.resultHandler+" result handler")):nr.default.call(this,t)}}},ar={install:function(t){t.addComponent("d3form",or);for(var e in t.providers)Xe[e]=t.providers[e]},actions:ir,responses:nr},sr=function(t){return this.wrapTemplate(t,ct(this.data))},ur='<div class="form-group" d3-class=\'showError ? "has-danger" : null\'>\n<slot></slot>\n<p d3-if="showError" class="text-danger error-block" d3-html="error"></p>\n</div>',cr=function(t,e){return e.classed("form-control",!0).attr("d3-class",'showError ? "form-control-danger" : null'),this.wrapTemplate(t,ur)},lr=function(t,e){var r=this.data.group;if(!r)return t;var n="g"+e.attr("id");return e.attr("aria-describedby",n),this.wrapTemplate(t,lt(n,r))},fr='<div class="form-group">\n<slot></slot>\n</div>',dr=function(t,e){var r=this.data.theme||"primary";return e.classed("btn",!0).classed("btn-"+r,!0),this.wrapTemplate(t,fr)},hr={input:["inputGroup","label","formGroup"],textarea:["label","formGroup"],select:["label","formGroup"],submit:["submit"],wrappers:{label:sr,formGroup:cr,inputGroup:lr,submit:dr}},pr={install:function(t){var e=t.components.get("d3form");e&&(e.prototype.formTheme=hr)}},vr="0.1.9";t.view=Te,t.viewModel=A,t.viewExpression=Qt,t.viewReady=De,t.viewProviders=zt,t.viewWarn=Wt,t.viewForms=ar,
t.viewBootstrapForms=pr,t.viewVersion=vr,t.viewElement=q,t.viewTemplate=X,t.viewHtml=M,Object.defineProperty(t,"__esModule",{value:!0})});