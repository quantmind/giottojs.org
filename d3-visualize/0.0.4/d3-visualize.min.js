// d3-visualize Version 0.0.4. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("object-assign"),require("d3-array"),require("d3-random"),require("d3-collection"),require("d3-let"),require("d3-dsv"),require("d3-view"),require("d3-dispatch"),require("crossfilter"),require("d3-format"),require("d3-time-format"),require("d3-canvas-transition"),require("d3-require"),require("d3-selection")):"function"==typeof define&&define.amd?define(["exports","object-assign","d3-array","d3-random","d3-collection","d3-let","d3-dsv","d3-view","d3-dispatch","crossfilter","d3-format","d3-time-format","d3-canvas-transition","d3-require","d3-selection"],e):e(t.d3={},t.assign,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.crossfilter,t.d3,t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,i,r,o,a,s,u,l,d,c,h,f,p){"use strict";function m(t){var e=(t.headers.get("content-type")||"").split(";")[0];return"text/plain"===e||"text/csv"===e?t.text().then(a.csvParse):"application/json"===e?t.json():(N("Cannot load content type '"+e+"'"),[])}function g(t,e,n,i){var r=i.dataName(o.pop(n,"name")),a=l();Object.defineProperties(t,{cf:{get:function(){return a}},name:{get:function(){return r}},store:{get:function(){return i}},type:{get:function(){return e}},config:{get:function(){return n}}}),i.series.set(r,t),H.call("init",t),t.data()}function v(t){var e=r.map();Object.defineProperties(this,{series:{get:function(){return e}}}),this.dataCount=0,this.model=t}function y(t,e){var n={width:e.width,height:e.height};return n.width||(n.width=b(t),n.width?n.widthElement=x(t):n.width=J),n.height||(n.height=w(t),n.height?n.heightElement=C(t):n.height=K),"string"==typeof n.height&&n.height.indexOf("%")===n.height.length-1&&(n.heightPercentage=.01*parseFloat(n.height),n.height=X(n.heightPercentage*n.width)),n}function b(t){var e=S(t,"width");if(e)return j(e)}function w(t){var e=S(t,"width");if(e)return P(e)}function x(t){return S(t,"width")}function C(t){return S(t,"height")}function j(t){var e=t.getBoundingClientRect().width,n=h.select(t);return e-z(n.style("padding-left"))-z(n.style("padding-right"))}function P(t){var e=t.getBoundingClientRect().height,n=h.select(t);return e-z(n.style("padding-top"))-z(n.style("padding-bottom"))}function S(t,e){for(var n=t.node?t.node():t;n&&"BODY"!==n.tagName;){if(n.getBoundingClientRect()[e])return n;n=n.parentNode}}function z(t){return t&&"px"==t.substring(t.length-2)?+t.substring(0,t.length-2):0}function D(t){var e,n=t.widthElement?b(t.widthElement):t.width;return e=t.heightPercentage?X(n*t.heightPercentage,0):t.heightElement?w(t.heightElement):t.height,t.minHeight&&(e=Math.max(e,t.minHeight)),[X(n),X(e)]}function O(t,e){Object.defineProperties(this,{element:{get:function(){return t}},sel:{get:function(){return h.select(t)}},size:{get:function(){return[this.width,this.height]}}}),this.width=e.width,this.height=e.height,this.sel.classed("d3-visual-root",!0)}function q(t){return t}function E(t){return new t}function _(t){var e=t.title||{};o.isString(e)&&(e={text:e}),this.title=e}function k(t,n){var i=t.records,r=t.data,o=t.model,a=n,s=void 0,u=void 0;n=a.splice(0,100),n.forEach(function(t){t.id?(s=t.id?i[t.id]:null,s?t=e(s,t):(r.push(t),i[t.id]=t)):r.push(t),o.columns.forEach(function(e){t[e.name]=e.$parse(t[e.name])})}),t.sel.select("tbody").selectAll("tr").data(r).enter().append("tr").attr("scope","row").selectAll("td").data(o.columns).enter().append("td").style("display",function(t){return t.hidden?"none":null}).html(function(t){return s=this.parentNode.__data__,u=s[t.name],t.$html(void 0===u?"":u)})}e=e&&e.hasOwnProperty("default")?e.default:e,l=l&&l.hasOwnProperty("default")?l.default:l;var A={sigma:.1,drift:0},T=function(t,r){r=e({},A,r);for(var o,a=n.range(0,+t,1),s=r.sigma,u=r.drift,l=[{x:0,y:0}],d=i.randomNormal(0,1),c=1;c<a.length;c++)o=u+s*d(),l[c]={x:c,y:l[c-1].y+o};return l},G={init:function(t){return o.isArray(t)?{data:t}:o.isObject(t)&&o.isArray(t.data)?t:void 0},load:function(){return o.pop(this.config,"data")}},N=function(t){s.viewProviders.logger.warn("[d3-data-source] "+t)},$=["http","https","ws","wss"],B=function(t){return o.isString(t)&&$.indexOf(t.split("://")[0])>-1},F={init:function(t){return B(t)?{url:t}:o.isObject(t)&&t.url?t:void 0},load:function(){var t=s.viewProviders.fetch;return t?t(this.url).then(m):void N("fetch provider not available, cannot submit")}},L={init:function(t){var e;if(!B(t))return o.isString(t)?{expression:t}:o.isObject(t)&&"expression"===t.type?t:(e=t,e?(this.name=e.name||this.dataName(),this.expression=s.viewExpression(e.expression),this):void 0)},load:function(){this.expression||(this.expression=s.viewExpression(this.config.expression));var t=this.store.model;return this.expression.eval(t)}},M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},R=(function(){function t(t){this.value=t}function e(e){function n(t,e){return new Promise(function(n,r){var s={key:t,arg:e,resolve:n,reject:r,next:null};a?a=a.next=s:(o=a=s,i(t,e))})}function i(n,o){try{var a=e[n](o),s=a.value;s instanceof t?Promise.resolve(s.value).then(function(t){i("next",t)},function(t){i("throw",t)}):r(a.done?"return":"normal",a.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":o.resolve({value:e,done:!0});break;case"throw":o.reject(e);break;default:o.resolve({value:e,done:!1})}o=o.next,o?i(o.key,o.arg):a=null}var o,a;this._invoke=n,"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}),H=u.dispatch("init","data"),V={init:function(){},size:function(){return this.cf.size()},load:function(){},data:function(t,e){if(2===arguments.length)return this.add(e);var n=this;return e=this.load(),o.isPromise(e)?e.then(function(e){n.data(t,e)}):this.data(t,e)},add:function(t){if(!t)return this;var e=this.size();return t=t.map(function(t){return"object"===(void 0===t?"undefined":M(t))?t._id=++e:t={_id:++e,data:t},t}),this.cf.add(t),H.call("data",this,t),this}},Y=e(r.map(),{events:H,add:function(t,n){function i(e,n){g(this,t,e,n)}return i.prototype=e({},V,n),this.set(t,i),i},create:function(t,e){for(var n,i=this.values(),r=0;r<i.length;++r)if(n=i[r].prototype.init(t))return new i[r](n,e)}});Y.add("array",G),Y.add("remote",F),Y.add("expression",L),v.prototype={size:function(){return this.series.size()},add:function(t){return Y.create(t,this)},serie:function(t,e){if(1===arguments.length)return this.series.get(t);if(null===e){var n=this.series.get(t);return this.series.remove(t),n}return this.series.set(t,e),this},dataName:function(t){return this.dataCount++,t?""+t:this.serie("default")?"serie"+this.dataCount:"default"}};var I={formatDate:c.timeFormat("%d/%m/%Y"),formatDateTime:c.timeFormat("%a %e %b %X %Y"),load:function(t){var e=this,n=Y.create("https://unpkg.com/d3-format/locale/"+t+".json"),i=Y.create("https://unpkg.com/d3-time-format/locale/"+t+".json");return Promise.all([n.load().then(function(n){e.symbol=t,e.number=n,d.formatDefaultLocale(n)}),i.load().then(function(t){e.time=t,e.formatDate=c.timeFormat(t.date),e.formatDateTime=c.timeFormat(t.dateTime),c.timeFormatDefaultLocale(t)})])}},U={dataSource:null,size:{width:null,height:"70%"}},X=function(t,e){return e?Math.round(t*(e=Math.pow(10,e)))/e:Math.round(t)},J=400,K="75%",Q=[],W={},Z=u.dispatch("init","before-draw","after-draw"),tt=e({},{initialise:function(){},draw:function(){},select:function(t){return h.select(t)},destroy:function(){}},s.viewBase);O.prototype={select:function(t){return h.select(t)},fit:function(){var t=y(this.element,this);this.width=t.width,this.height=t.height},resize:function(t,e){e||(e=D(this));var n=this.size;n[0]===e[0]&&n[1]===e[1]||(this.root.width=e[0],this.root.height=e[1],Z.call("before-draw",t),t.draw(),Z.call("after-draw",t))}};var et=function(t,n){function i(n,i){i=e({},U[t],i),Object.defineProperties(this,{visualType:{get:function(){return t}},element:{get:function(){return n}}}),this.initialise(n,i),Z.call("init",this,i)}return i.prototype=e({},tt,n),W[t]=i,i},nt=et("visual",{initialise:function(t,e){t.group||(t.group=new W.group(t,e)),this.group=t.group}});U.visualGroup={render:"svg"};var it=et("group",{initialise:function(t,e){var n=this;if(!e)throw new Error("HTMLElement required by visual group");this.root=new O(e,t),Q.push(this),Object.defineProperties(this,{group:{get:function(){return n}}})},addVisual:function(t){t.group=this,this.visuals.push(new nt(t))},resize:function(t){this.root.resize(this,t)},destroy:function(){var t=Q.indexOf(this);t>-1&&(Q.splice(t,1),this.visuals.forEach(function(t){return t.destroy()}))}}),rt={props:["schema","datasource","plugins"],render:function(t,e,n){var i=this,r=this.select(n).html(),a=this.model.dataStore;return a||(a=new v(this.model),this.model.dataStore=a),this.getSchema(t.schema,function(t){return o.isObject(t)||(t={}),i.build(t,r)})},getSchema:function(t,e){return o.isString(t)?this.json(t).then(e):e(t)},createGroup:function(){var t=this.model;return t.visualGroup=t,t.visuals={},t},build:function(){}},ot=e({},{build:function(t,e){return this.createGroup(),this.createElement("div").classed("dashboard",!0).html(e).mount()}},rt),at=e({},rt,{build:function(t){var e=this.model,n=e.visualGroup;n?n.visuals[t.name]=e:n=this.createGroup()}}),st=function(t){s.viewProviders.logger.warn("[d3-visualize] "+t)},ut={date:c.isoParse,string:function(t){return""+t}},lt={number:function(t){return t},date:function(t){return I.formatDate(t)},boolean:function(t){return t}},dt=function(t){var e=[],n=void 0;if(!t)return e;if(o.isArray(t)&&(t={properties:t}),o.isObject(t.properties))for(var i in t.properties)n=t.properties[i],o.isObject(n)&&(n.name||(n.name=i),e.push(n));else e.push.apply(e,R(t.properties));return e.map(function(t){return o.isObject(t)||(t={name:t}),t.label||(t.label=t.name),t.hidden||(t.hidden=!1),t.$parse||(t.$parse=ut[t.type]||ut.string),t.$html||(t.$html=lt[t.type]||q),t})},ct=function(t,e){return f.require("clusterize.js@0.17.6").then(function(t){return E(t)})},ht=function(t){return t},ft={over:!0,small:!0,bordered:!0,loadingClass:"table-info",loadingTextClass:"text-center"},pt=function(t,n){var i=t.model.style;i.$update(e({},ft,n)),i.tableClass="table table-responsive",i.striped&&(i.tableClass+=" table-striped"),i.over&&(i.tableClass+=" table-hover"),i.bordered&&(i.tableClass+=" table-bordered"),i.small&&(i.tableClass+=" table-sm")};if(U.resizeDelay||(U.resizeDelay=200),o.inBrowser){var mt=s.viewDebounce(function(){Q.forEach(function(t){return t.resize()})},U.resizeDelay);p.select(window).on("resize.visuals",mt)}Z.on("init.title",_);var gt={bootstrap:pt,clusterize:ct,paginate:ht},vt=e({},rt,{model:function(){return{header:!0,columns:[],loadingData:!1,style:{tableClass:null,headerClass:null,headerRowClass:null,loadingClass:"loading",loadingTextClass:null}}},build:function(t){var e=this,n=this.model,i=t.plugins||[];if(this.records={},this.data=[],this.template='<table d3-class="[style.tableClass, loadingData ? \'loading\' : null]">\n<thead d3-class="style.headerClass">\n<tr d3-class="style.headerRowClass">\n  <th d3-for="col in columns"\n        d3-html="col.label"\n        d3-if="!col.hidden">\n  </th>\n</tr>\n<tr d3-if="loadingData" d3-class="style.loadingClass">\n    <td d3-attr-colspan="columns.length">\n        <p d3-class="style.loadingTextClass">loading data</p>\n    </td>\n</tr>\n</thead>\n<tbody></tbody>\n</table>',n.columns=dt(t),o.isArray(i)){var r=[],a=void 0;if(i.forEach(function(t){o.isString(t)&&(t={name:t}),gt[t.name]?(a=gt[t.name](e,t),o.isPromise(a)&&r.push(a)):st("Unknown table plugin "+t.name)}),r.length)return Promise.all(r).then(function(){return e.viewElement(e.template)})}else st("plugins should be an array");return this.viewElement(this.template)},mounted:function(){var t=this,e=this.model;if(e.dataLoader){var n=e.dataLoader.load(e.columns);n&&(e.loadingData=!0,n.then(function(n){e.loadingData=!1,k(t,n)},function(t){return e.loadingData=!1,t}))}}}),yt={tabularPlugins:gt,install:function(t){t.addComponent("dashboard",ot),t.addComponent("visual",at),t.addComponent("tabular",vt)}};t.viewTableVersion="0.0.4",t.randomPath=T,t.DataStore=v,t.dataSources=Y,t.dataLocale=I,t.VisualGroup=it,t.visualComponents=yt,Object.defineProperty(t,"__esModule",{value:!0})});