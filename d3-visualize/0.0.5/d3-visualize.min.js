// d3-visualize Version 0.0.5. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-canvas-transition"),require("object-assign"),require("d3-array"),require("d3-random"),require("d3-collection"),require("d3-let"),require("d3-dsv"),require("d3-view"),require("d3-dispatch"),require("crossfilter"),require("d3-format"),require("d3-time-format"),require("d3-selection"),require("d3-shape"),require("d3-require")):"function"==typeof define&&define.amd?define(["exports","d3-canvas-transition","object-assign","d3-array","d3-random","d3-collection","d3-let","d3-dsv","d3-view","d3-dispatch","crossfilter","d3-format","d3-time-format","d3-selection","d3-shape","d3-require"],e):e(t.d3={},t.d3,t.assign,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.crossfilter,t.d3,t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,i,r,a,o,s,u,d,l,c,h,f,p,m){"use strict";function v(t){var e=(t.headers.get("content-type")||"").split(";")[0];return"text/plain"===e||"text/csv"===e?t.text().then(s.csvParse):"application/json"===e?t.json():(M("Cannot load content type '"+e+"'"),[])}function g(t,e,n,i){var r=i.dataName(o.pop(n,"name")),a=l();Object.defineProperties(t,{cf:{get:function(){return a}},name:{get:function(){return r}},store:{get:function(){return i}},type:{get:function(){return e}},config:{get:function(){return n}}}),i.series.set(r,t),W.call("init",t),t.data()}function y(t){var e=a.map();Object.defineProperties(this,{series:{get:function(){return e}}}),this.dataCount=0,this.model=t}function b(t,e){var n={width:e.width,height:e.height};return n.width||(n.width=w(t),n.width?n.widthElement=C(t):n.width=Z),n.height||(n.height=x(t),n.height?n.heightElement=S(t):n.height=tt),"string"==typeof n.height&&n.height.indexOf("%")===n.height.length-1&&(n.heightPercentage=.01*parseFloat(n.height),n.height=Q(n.heightPercentage*n.width)),n}function w(t){var e=P(t,"width");if(e)return j(e)}function x(t){var e=P(t,"width");if(e)return D(e)}function C(t){return P(t,"width")}function S(t){return P(t,"height")}function j(t){var e=t.getBoundingClientRect().width,n=f.select(t);return e-O(n.style("padding-left"))-O(n.style("padding-right"))}function D(t){var e=t.getBoundingClientRect().height,n=f.select(t);return e-O(n.style("padding-top"))-O(n.style("padding-bottom"))}function P(t,e){for(var n=t.node?t.node():t;n&&"BODY"!==n.tagName;){if(n.getBoundingClientRect()[e])return n;n=n.parentNode}}function O(t){return t&&"px"==t.substring(t.length-2)?+t.substring(0,t.length-2):0}function z(t){var e,n=t.widthElement?w(t.widthElement):t.width;return e=t.heightPercentage?Q(n*t.heightPercentage,0):t.heightElement?x(t.heightElement):t.height,t.minHeight&&(e=Math.max(e,t.minHeight)),[Q(n),Q(e)]}function E(t,e){Object.defineProperties(this,{element:{get:function(){return t}},sel:{get:function(){return f.select(t)}},size:{get:function(){return[this.width,this.height]}}}),this.width=e.width,this.height=e.height}function q(t,e){var n=p[k(e)];return n||(ot('Could not locate curve type "'+e+'"'),e=k(t.defaults().curveName),n=p[e]),n}function k(t){return"curve"!==t.substring(0,5)&&(t="curve"+t[0].toUpperCase()+t.substring(1)),t}function _(t){return t}function T(t,e){var n=e.dataStore,i=o.pop(e,"data");i&&(n||(n=new y),t.dataStore=n,o.isString(i)&&(i={name:i}),n.get(i.name)||(i=n.add(i)),t.data=i)}function A(t,e){var n=t.visual,i=n.dataStore,r=e.data;i&&r&&(t.data=r)}function N(t){return new t}function B(t,e){var i=t.records,r=t.data,a=t.model,o=e,s=void 0,u=void 0;e=o.splice(0,100),e.forEach(function(t){t.id?(s=t.id?i[t.id]:null,s?t=n(s,t):(r.push(t),i[t.id]=t)):r.push(t),a.columns.forEach(function(e){t[e.name]=e.$parse(t[e.name])})}),t.sel.select("tbody").selectAll("tr").data(r).enter().append("tr").attr("scope","row").selectAll("td").data(a.columns).enter().append("td").style("display",function(t){return t.hidden?"none":null}).html(function(t){return s=this.parentNode.__data__,u=s[t.name],t.$html(void 0===u?"":u)})}n=n&&n.hasOwnProperty("default")?n.default:n,l=l&&l.hasOwnProperty("default")?l.default:l;var L={sigma:.1,drift:0},$=function(t,e){e=n({},L,e);for(var a,o=i.range(0,+t,1),s=e.sigma,u=e.drift,d=[{x:0,y:0}],l=r.randomNormal(0,1),c=1;c<o.length;c++)a=u+s*l(),d[c]={x:c,y:d[c-1].y+a};return d},F={init:function(t){return o.isArray(t)?{data:t}:o.isObject(t)&&o.isArray(t.data)?t:void 0},load:function(){return o.pop(this.config,"data")}},M=function(t){u.viewProviders.logger.warn("[d3-data-source] "+t)},R=["http","https","ws","wss"],H=function(t){return o.isString(t)&&R.indexOf(t.split("://")[0])>-1},I={init:function(t){return H(t)?{url:t}:o.isObject(t)&&t.url?t:void 0},load:function(){var t=u.viewProviders.fetch;return t?t(this.url).then(v):void M("fetch provider not available, cannot submit")}},V={init:function(t){var e;if(!H(t))return o.isString(t)?{expression:t}:o.isObject(t)&&"expression"===t.type?t:(e=t,e?(this.name=e.name||this.dataName(),this.expression=u.viewExpression(e.expression),this):void 0)},load:function(){this.expression||(this.expression=u.viewExpression(this.config.expression));var t=this.store.model;return this.expression.eval(t)}},Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},U=(function(){function t(t){this.value=t}function e(e){function n(t,e){return new Promise(function(n,r){var s={key:t,arg:e,resolve:n,reject:r,next:null};o?o=o.next=s:(a=o=s,i(t,e))})}function i(n,a){try{var o=e[n](a),s=o.value;s instanceof t?Promise.resolve(s.value).then(function(t){i("next",t)},function(t){i("throw",t)}):r(o.done?"return":"normal",o.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":a.resolve({value:e,done:!0});break;case"throw":a.reject(e);break;default:a.resolve({value:e,done:!1})}a=a.next,a?i(a.key,a.arg):o=null}var a,o;this._invoke=n,"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}),W=d.dispatch("init","data"),X={init:function(){},size:function(){return this.cf.size()},load:function(){},data:function(t,e){if(2===arguments.length)return this.add(e);var n=this;return e=this.load(),o.isPromise(e)?e.then(function(e){n.data(t,e)}):this.data(t,e)},add:function(t){if(!t)return this;var e=this.size();return t=t.map(function(t){return"object"===(void 0===t?"undefined":Y(t))?t._id=++e:t={_id:++e,data:t},t}),this.cf.add(t),W.call("data",this,t),this}},G=n(a.map(),{events:W,add:function(t,e){function i(e,n){g(this,t,e,n)}return i.prototype=n({},X,e),this.set(t,i),i},create:function(t,e){for(var n,i=this.values(),r=0;r<i.length;++r)if(n=i[r].prototype.init(t))return new i[r](n,e)}});G.add("array",F),G.add("remote",I),G.add("expression",V),y.prototype={size:function(){return this.series.size()},add:function(t){return G.create(t,this)},serie:function(t,e){if(1===arguments.length)return this.series.get(t);if(null===e){var n=this.series.get(t);return this.series.remove(t),n}return this.series.set(t,e),this},dataName:function(t){return this.dataCount++,t?""+t:this.serie("default")?"serie"+this.dataCount:"default"}};var J={formatDate:h.timeFormat("%d/%m/%Y"),formatDateTime:h.timeFormat("%a %e %b %X %Y"),load:function(t){var e=this,n=G.create("https://unpkg.com/d3-format/locale/"+t+".json"),i=G.create("https://unpkg.com/d3-time-format/locale/"+t+".json");return Promise.all([n.load().then(function(n){e.symbol=t,e.number=n,c.formatDefaultLocale(n)}),i.load().then(function(t){e.time=t,e.formatDate=h.timeFormat(t.date),e.formatDateTime=h.timeFormat(t.dateTime),h.timeFormatDefaultLocale(t)})])}},K={dataSource:null,size:{width:null,height:"70%"}},Q=function(t,e){return e?Math.round(t*(e=Math.pow(10,e)))/e:Math.round(t)},Z=400,tt="75%",et=[],nt={},it=d.dispatch("before-init","after-init","before-draw","after-draw"),rt=n({},{initialise:function(){},draw:function(){it.call("before-draw",void 0,this),this.doDraw(),it.call("after-draw",void 0,this)},select:function(t){return f.select(t)},destroy:function(){},doDraw:function(){}},u.viewBase);E.prototype={select:function(t){return f.select(t)},fit:function(){var t=b(this.element,this);this.width=t.width,this.height=t.height},resize:function(t,e){e||(e=z(this));var n=this.size;n[0]===e[0]&&n[1]===e[1]||(this.root.width=e[0],this.root.height=e[1],t.draw())}};var at=function(t,e){function i(e,i){i=n({},K[t],i),it.call("before-init",void 0,this,i),e=this.initialise(e,i),Object.defineProperties(this,{visualType:{get:function(){return t}},element:{get:function(){return e}}}),it.call("after-init",void 0,this,i)}var r=o.pop(e,"options");return r&&(K[t]=r),i.prototype=n({},rt,e),nt[t]=i,i},ot=function(t){u.viewProviders.logger.warn("[d3-visualize] "+t)},st=at("visual",{options:{render:"svg"},initialise:function(t,e){var n=this;if(!t)throw new Error("HTMLElement required by visual group");this.root=new E(t,e),this.select(t).classed("d3-visual",!0),this.visuals=[],et.push(this),Object.defineProperties(this,{group:{get:function(){return n}}})},doDraw:function(){this.visuals.forEach(function(t){t.draw()})},addVisual:function(t){t.group=this;var e=nt[t.type];if(e){var n=new e(this.element,t);return this.visuals.push(n),n}ot("Cannot add visual "+t.type)},resize:function(t){this.root.resize(this,t)},destroy:function(){var t=et.indexOf(this);t>-1&&(et.splice(t,1),this.visuals.forEach(function(t){return t.destroy()}))}}),ut=function(t,e){return at(t,n({},lt,e))},dt={initialise:function(t,e){e.visual||(e.visual=new st(t,e)),this.visual=e.visual}},lt=n({},{draw:function(){it.call("before-draw",this),this.applyTransforms(),this.series&&(this.doDraw(),it.call("after-draw",this))},applyTransforms:function(){}},dt),ct=ut("barchart",{options:{orientation:"vertical",stack:!1},doDraw:function(){}}),ht=ut("linechart",{options:{lineWidth:1,colorOpacity:1,curve:"cardinalOpen"},doDraw:function(){var t=this.series,e=this.aesthetics,n=this.plot.path(this).data([t]),i=this.scaled(this.mapping.x,this.plot,t),r=this.scaled(this.mapping.y,this.plot,t),a=p.line().x(i).y(r).curve(q(this,e.curve)),o=this.plot.dim(e.lineWidth),s=this.plot.transition("update");n.enter().append("path").attr("class","line").attr("fill","none").attr("stroke",e.color).attr("stroke-opacity",0).attr("stroke-width",o).merge(n).transition(s).attr("stroke",e.color).attr("stroke-opacity",e.colorOpacity).attr("stroke-width",o).attr("d",a),n.exit().remove()}}),ft={props:["schema","datasource","plugins"],render:function(t,e,n){var i=this,r=this.select(n).html();return this.dataStore(),this.getSchema(t.schema,function(t){return o.isObject(t)||(t={}),i.build(t,r)})},getSchema:function(t,e){return o.isString(t)?this.json(t).then(e):e(t)},dataStore:function(){var t=this.model.dataStore;return t||(t=new y(this.model),this.model.dataStore=t),t},build:function(){}},pt=n({},ft,{build:function(t,e){var n=this.model;n.dashboard=n,n.visuals=[];var i=this.createElement("div").classed("dashboard",!0);return this.mountInner(i,e)}}),mt=n({},ft,{build:function(t){var e=this.model,n=e.dashboard,i=this.createElement("div");return n&&n.visuals.push(e),e.visual=new st(i.node(),t),i}}),vt={date:h.isoParse,string:function(t){return""+t}},gt={number:function(t){return t},date:function(t){return J.formatDate(t)},boolean:function(t){return t}},yt=function(t){var e=[],n=void 0;if(!t)return e;if(o.isArray(t)&&(t={properties:t}),o.isObject(t.properties))for(var i in t.properties)n=t.properties[i],o.isObject(n)&&(n.name||(n.name=i),e.push(n));else e.push.apply(e,U(t.properties));return e.map(function(t){return o.isObject(t)||(t={name:t}),t.label||(t.label=t.name),t.hidden||(t.hidden=!1),t.$parse||(t.$parse=vt[t.type]||vt.string),t.$html||(t.$html=gt[t.type]||_),t})};if(it.on("after-init.data",function(t,e){"visual"===t.visualType?T(t,e):A(t,e)}),K.resizeDelay||(K.resizeDelay=200),o.inBrowser){var bt=u.viewDebounce(function(){et.forEach(function(t){return t.resize()})},K.resizeDelay);f.select(window).on("resize.visuals",bt)}it.on("after-init.title",function(t,e){var n=e.title;n&&(o.isString(n)&&(n={text:n}),t.title=n)});var wt=function(t,e){return m.require("clusterize.js@0.17.6").then(function(t){return N(t)})},xt=function(t){return t},Ct={over:!0,small:!0,bordered:!0,loadingClass:"table-info",loadingTextClass:"text-center"},St=function(t,e){var i=t.model.style;i.$update(n({},Ct,e)),i.tableClass="table table-responsive",i.striped&&(i.tableClass+=" table-striped"),i.over&&(i.tableClass+=" table-hover"),i.bordered&&(i.tableClass+=" table-bordered"),i.small&&(i.tableClass+=" table-sm")},jt={bootstrap:St,clusterize:wt,paginate:xt},Dt=n({},ft,{model:function(){return{header:!0,columns:[],loadingData:!1,style:{tableClass:null,headerClass:null,headerRowClass:null,loadingClass:"loading",loadingTextClass:null}}},build:function(t){var e=this,n=this.model,i=t.plugins||[];if(this.records={},this.data=[],this.template='<table d3-class="[style.tableClass, loadingData ? \'loading\' : null]">\n<thead d3-class="style.headerClass">\n<tr d3-class="style.headerRowClass">\n  <th d3-for="col in columns"\n        d3-html="col.label"\n        d3-if="!col.hidden">\n  </th>\n</tr>\n<tr d3-if="loadingData" d3-class="style.loadingClass">\n    <td d3-attr-colspan="columns.length">\n        <p d3-class="style.loadingTextClass">loading data</p>\n    </td>\n</tr>\n</thead>\n<tbody></tbody>\n</table>',n.columns=yt(t),o.isArray(i)){var r=[],a=void 0;if(i.forEach(function(t){o.isString(t)&&(t={name:t}),jt[t.name]?(a=jt[t.name](e,t),o.isPromise(a)&&r.push(a)):ot("Unknown table plugin "+t.name)}),r.length)return Promise.all(r).then(function(){return e.viewElement(e.template)})}else ot("plugins should be an array");return this.viewElement(this.template)},mounted:function(){var t=this,e=this.model;if(e.dataLoader){var n=e.dataLoader.load(e.columns);n&&(e.loadingData=!0,n.then(function(n){e.loadingData=!1,B(t,n)},function(t){return e.loadingData=!1,t}))}}}),Pt={tabularPlugins:jt,install:function(t){t.addComponent("dashboard",pt),t.addComponent("visual",mt),t.addComponent("tabular",Dt)}};t.visualizeVersion="0.0.5",t.randomPath=$,t.DataStore=y,t.dataSources=G,t.dataLocale=J,t.Visual=st,t.crateChart=ut,t.BarChart=ct,t.LineChart=ht,t.visualComponents=Pt,Object.defineProperty(t,"__esModule",{value:!0})});