// https://github.com/quantmind/d3-canvas-transition Version 0.3.1. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-collection"),require("d3-color"),require("d3-timer")):"function"==typeof define&&define.amd?define("d3-canvas-transition",["exports","d3-selection","d3-collection","d3-color","d3-timer"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,r,i){"use strict";function o(t){var e=E[t.tagName];return e?e(t):{x:0,y:0,width:t.context.canvas.width,height:t.context.canvas.height}}function s(t,e,n){if(e&&"none"!==e){if("string"==typeof e&&"url("===e.substring(0,4)){var i=e.substring(4,e.length-1),o=w(t.rootNode).select(i).node();return o?c(t,o,n):null}if(!n&&0!==n)return e;var s=r.color(e);if(s)return s.opacity=n,""+s}}function a(t){this.node=t}function c(t,e,n){var r=A[e.tagName];if(r)return r(t,e,n)}function u(){return new h}function h(){this._head=null,this._tail=null,this._length=0,Object.defineProperty(this,"length",{get:function(){return this._length}})}function f(t,e){var n=t.rootNode;n._touches||(n._touches=0),n._touches+=e,n._touches&&!n._scheduled&&(n._scheduled=i.timeout(d(n)))}function l(t,e){var n=t.countNodes,r=R.get(t.tagName),i=t.factor,o=t.attrs;if(r!==!1)if(t.attrs){var a,c,u,h=t.context;h.save(),void 0!==o.$opacity&&(h.globalAlpha=+o.$opacity),o["$stroke-linecap"]&&(h.lineCap=o["$stroke-linecap"]),o["$stroke-linejoin"]&&(h.lineJoin=o["$stroke-linejoin"]),I(t),a=s(t,t.getValue("stroke"),t.getValue("stroke-opacity")),a&&(h.strokeStyle=a),void 0!==o["$stroke-width"]&&(u=V(t.attrs["$stroke-width"]),u&&(h.lineWidth=i*u)),a=0!==u,c=s(t,t.getValue("fill"),t.getValue("fill-opacity")),c&&(h.fillStyle=c),r&&r(t,a,c,e),n&&t.each(function(t){return l(t,e)}),h.restore()}else n&&t.each(function(t){return l(t,e)})}function d(t,e){return function(){var n=t.context;return t._touches=0,n.beginPath(),n.closePath(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,n.canvas.width,n.canvas.height),e&&(e.nodes=[]),l(t,e),t._scheduled=!1,f(t,0),e?e.nodes:null}}function g(t){this.node=t,this.context=t.context,this.current=t}function v(t){var e=this.getContext("2d"),n=e._rootElement;n&&y(n,t)}function p(t){var e=this.getContext("2d"),n=e._rootElement;if(n){t.canvasPoint={x:n.factor*t.offsetX,y:n.factor*t.offsetY};var r=d(n,t.canvasPoint)(),i="mousemove"===t.type?_:x;i(e,r,t)}}function x(t,e,n){for(var r=e.length-1;r>=0&&!y(e[r],n);--r);}function _(t,e,n){var r,i,o=t._activeNodes,s=[],a=e.length?e[e.length-1]:null;if(o)for(i=0;i<o.length;++i)r=o[i],a&&r!==a&&r.parentNode===a.parentNode?y(r,n,"mouseleave"):e.indexOf(r)>-1?(s.push(r),y(r,n,"mousemove")):y(r,n,"mouseleave");t._activeNodes=o=s,o.indexOf(a)===-1&&(o.push(a),y(a,n,"mouseenter"))}function y(t,e,n){var r=t.events[n||e.type];if(r){for(var i=0;i<r.length;++i)r[i].call(t,e);return t}}function m(t,e){var n,r={},i="";Object.defineProperties(this,{context:{get:function(){return e}},deque:{get:function(){return n||(n=u()),n}},events:{get:function(){return r}},tagName:{get:function(){return t}},childNodes:{get:function(){return n?n.list():[]}},firstChild:{get:function(){return n?n._head:null}},lastChild:{get:function(){return n?n._tail:null}},parentNode:{get:function(){return this._parent}},previousSibling:{get:function(){return this._prev}},nextSibling:{get:function(){return this._next}},namespaceURI:{get:function(){return L}},textContent:{get:function(){return i},set:function(t){i=""+t,f(this,1)}},clientLeft:{get:function(){return e.canvas.clientLeft}},clientTop:{get:function(){return e.canvas.clientTop}},clientWidth:{get:function(){return e.canvas.clientWidth}},clientHeight:{get:function(){return e.canvas.clientHeight}},rootNode:{get:function(){return this.context._rootElement}},countNodes:{get:function(){return n?n._length:0}},factor:{get:function(){return this.context._factor}}})}function b(t,e,n){for(var r,i,o,s,a,c=t.split(" "),u=new g(e),h=u.next(),f=0;f<c.length;++f)t=c[f],"*"===t?t={}:(t.indexOf("#")>-1?(i=t.split("#"),o=i[0],s=i[1]):t.indexOf(".")>-1?(i=t.split("."),o=i[0],r=i.splice(1).join(" ")):o=t,t={tag:o,id:s,classes:r}),c[f]=t;for(;h;){for(var l=0;l<c.length;++l)if(a=c[l],!(a.tag&&h.tagName!==a.tag||a.id&&h.id!==a.id||a.classes&&h.class!==a.classes)){if(n){n.push(h);break}return h}h=u.next()}return n}function P(t,e){return function(){t.apply(this,e)}}function w(t,n){var r=e.selection();return t?C(t)&&1===arguments.length?r.select(function(){return t}):"string"!=typeof t||(t=e.select(t).node())?(t.getContext&&(t=t.getContext("2d")),t._rootElement||(n||(n=T||z()),t._factor=n,t._rootElement=new m("canvas",t)),r.select(function(){return t._rootElement})):r:r}function N(t,e){if(arguments.length>1){var n,r=this._parents[0]||this.node();C(r)&&"function"==typeof e.context&&(n=e.pathObject,n||(e.context(r.context),n=G(e,r.factor),e.pathObject=n),arguments[1]=n)}return B.apply(this,arguments)}function C(t){return t instanceof m}function O(t){var e=this,n=e.node();if("CANVAS"!==n.tagName||C(n)||(e=w(n),n=e.node()),C(n)&&t){var r=n.context,i=n.factor,o=r.canvas.width,s=r.canvas.height;r.beginPath(),r.closePath(),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,o,s),i>1&&(r.canvas.style.width=o+"px",r.canvas.style.height=s+"px",r.canvas.width=o*i,r.canvas.height=s*i,r.scale(i,i))}return e}function j(t){return 1===arguments.length?(T=t,this):this.factor}function k(t,e){if(1===e)return t;var n,r=0,i="";for(t+="";n=H.exec(t);)i+=t.substring(r,n.index)+e*n[0],r=n.index+n[0].length;return i+t.substring(r)}function S(t){for(var e=[],n=0,r=void 0,i=void 0,o=void 0,s=0;s<X.length;++s)r=X[s],i=t.getValue("font-"+r),i&&("size"===r?(n=t.factor*V(i),i=n+"px"):"family"===r&&(o=i),e.push(i));return n&&(o||e.push("sans serif"),t.context.font=e.join(" ")),n}var V=function(t,e){if("string"==typeof t){if("px"===t.substring(t.length-2))return+t.substring(0,t.length-2);if("%"===t.substring(t.length-1))return.01*t.substring(0,t.length-1)*(e||1);if("em"===t.substring(t.length-2))return t.substring(0,t.length-2)*(e||1)}else if("number"==typeof t)return t},E={},A={linearGradient:function(t,e,n){var i,s=e.context,a=o(t),c=V(e.attrs.get("x1")||"0%",a.width),u=V(e.attrs.get("x2")||"100%",a.width),h=V(e.attrs.get("y1")||"0%",a.height),f=V(e.attrs.get("y2")||"0%",a.height),l=s.createLinearGradient(c,h,u,f);return e.each(function(t){i=r.color(t.attrs.get("stop-color")),(n||0===n)&&(i.opacity=n),l.addColorStop(V(t.attrs.get("offset")),""+i)}),l},radialGradient:function(t,e,n){var i,s=e.context,a=o(t),c=V(e.attrs.get("cx")||"50%",a.width),u=V(e.attrs.get("cy")||"50%",a.height),h=V(e.attrs.get("fx")||c,a.width),f=V(e.attrs.get("fy")||u,a.height),l=V(e.attrs.get("r")||"50%",Math.max(a.height,a.width)),d=s.createRadialGradient(a.x+h,a.y+f,0,a.x+c,a.y+u,l);return e.each(function(t){i=r.color(t.attrs.get("stop-color")),(n||0===n)&&(i.opacity=n),d.addColorStop(V(t.attrs.get("offset")),""+i)}),d}};a.prototype={getPropertyValue:function(t){var e=this.node.getValue(t);return void 0===e&&(e=window.getComputedStyle(this.node.context.canvas).getPropertyValue(t)),e}};var q=function(t,e,n){var r=t.attrs.get(e);return r!==n&&(t.attrs.set(e,n),!0)};h.prototype=u.prototype={prepend:function(t,e){this._length?e?(t._prev=e._prev,t._next=e,e._prev&&(e._prev._next=t),e._prev=t):(t._prev=this._tail,t._next=null,this._tail._next=t):(t._prev=null,t._next=null),t._prev||(this._head=t),t._next||(this._tail=t),this._length++},remove:function(t){t._prev&&(t._prev._next=t._next),t._next&&(t._next._prev=t._prev),this._head===t&&(this._head=t._next),this._tail===t&&(this._tail=t._prev),delete t._prev,delete t._next,this._length--},list:function t(){for(var e=this._head,t=[];e;)t.push(e),e=e._next;return t},each:function(t){for(var e=this._head;e;)t(e),e=e._next}};var I=function(t){var e,n,r=+(t.attrs.get("x")||0),i=+(t.attrs.get("y")||0),o=t.attrs.get("transform"),s=t.context;if("string"==typeof o){var a,c,u,h=o.indexOf("translate(");if(h>-1&&(c=o.substring(h+10),a=c.indexOf(")"),u=c.substring(0,a).split(","),r+=+u[0],2===u.length&&(i+=+u[1])),h=o.indexOf("rotate("),h>-1){c=o.substring(h+7);var f=+c.substring(0,c.indexOf(")"));f===f&&s.rotate(f*Math.PI/180)}h=o.indexOf("scale("),h>-1&&(c=o.substring(h+6),a=c.indexOf(")"),u=c.substring(0,a).split(","),e=+u[0],2===u.length&&(n=+u[1]))}else o&&(r+=o.x,i+=o.y,e=o.k);(r||i)&&s.translate(t.factor*r,t.factor*i),e&&(n=n||e,s.scale(e,n))},R=n.map();g.prototype={next:function(){var t=this.current;if(!t)return null;if(t.firstChild)t=t.firstChild;else for(;t;){if(t.nextSibling){t=t.nextSibling;break}t=t.parentNode,t===this.node&&(t=null)}return this.current=t,t}};var $={mouseenter:"mousemove",mouseleave:"mousemove"},L="canvas";m.prototype={querySelectorAll:function(t){return this.countNodes?b(t,this,[]):[]},querySelector:function(t){if(this.countNodes)return b(t,this)},createElementNS:function(t,e){return new m(e,this.context)},hasChildNodes:function(){return this.countNodes>0},contains:function(t){for(;t;){if(t._parent==this)return!0;t=t._parent}return!1},appendChild:function(t){return this.insertBefore(t)},insertBefore:function(t,e){if(t===this)throw Error("inserting self into children");if(!(t instanceof m))throw Error("Cannot insert a non canvas element into a canvas element");return t._parent&&t._parent.removeChild(t),this.deque.prepend(t,e),t._parent=this,f(this,1),t},removeChild:function(t){if(t._parent===this)return delete t._parent,this.deque.remove(t),f(this,1),t},setAttribute:function(t,e){"class"===t?this.class=e:"id"===t?this.id=e:(this.attrs||(this.attrs=n.map()),q(this,t,e)&&f(this,1))},removeAttribute:function(t){this.attrs&&(this.attrs.remove(t),f(this,1))},getAttribute:function(t){var e=this.attrs?this.attrs.get(t):void 0;return void 0!==e||this._parent||(e=this.context.canvas[t]),e},addEventListener:function(t,e){var n=this.context.canvas;this.rootNode===this?(arguments[1]=v,n.addEventListener.apply(n,arguments)):(arguments[0]=$[t]||t,arguments[1]=p,n.addEventListener.apply(n,arguments));var r=this.events[t];r||(this.events[t]=r=[]),r.indexOf(e)===-1&&r.push(e)},removeEventListener:function(t,e){var n=this.events[t];if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},getBoundingClientRect:function(){return this.context.canvas.getBoundingClientRect()},each:function(t){this.countNodes&&this.deque.each(t)},getValue:function(t){var e=this.getAttribute(t);return void 0===e&&this._parent?this._parent.getValue(t):e},removeProperty:function(t){this.removeAttribute(t)},setProperty:function(t,e){this.setAttribute(t,e)},getProperty:function(t){return this.getAttribute(t)},getPropertyValue:function(t){return this.getAttribute(t)},getComputedStyle:function(t){return new a(t)},get ownerDocument(){return this},get style(){return this},get defaultView(){return this},get document(){return this.rootNode}};var T,z=function(t){return t||window.devicePixelRatio||1},G=function(t,e){function n(){return P(t,arguments)}function r(t){return i*o(t)}var i=e*e,o=t.size();return t.size(r),n.size=function(t){return 0===arguments.length?r:(o=t,n)},n},B=e.selection.prototype.attr;e.selection.prototype.attr=N,e.selection.prototype.canvas=O,e.selection.prototype.canvasResolution=j;var M="0.3.1",W=function(t,e,n,r){var i=t.attrs,o=t.context,s=t.factor;o.beginPath(),o.arc(s*i.get("cx",0),s*i.get("cy",0),s*i.get("r",0),0,2*Math.PI),o.closePath(),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)};E.circle=function(t){var e=t.factor*(t.attrs.get("r")||0);return{x:t.factor*(t.attrs.get("cx")||0)-e,y:t.factor*(t.attrs.get("cy")||0)-e,width:2*e,height:2*e}};var D=function(t,e,n,r){var i=t.attrs,o=t.context;o.beginPath(),o.moveTo(t.factor*(i.get("x1")||0),t.factor*(i.get("y1")||0)),o.lineTo(t.factor*i.get("x2"),t.factor*i.get("y2")),e&&o.stroke(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)},H=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,J=function(t,e,n,r){var i=t.attrs.get("d"),o=t.context;if(i)if("function"==typeof i)o.beginPath(),i(t),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t);else if(window.Path2D){var s=window.Path2D,a=new s(k(i,t.factor));e&&o.stroke(a),n&&o.fill(a),r&&o.isPointInPath(a,r.x,r.y)&&r.nodes.push(t)}},U=function(t,e,n,r){var i=t.attrs,o=t.context,s=i.get("height")||0,a=i.get("width")||0;a&&s&&s!==a&&o.scale(1,s/a),o.beginPath(),o.rect(0,0,t.factor*a,t.factor*a),o.closePath(),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)};E.rect=function(t){var e=t.factor*(t.attrs.get("width")||0);return{x:0,y:0,height:e,width:e}};var X=["style","variant","weight","size","family"],Y="middle",F={start:"start",middle:"center",end:"end"},K=function(t){var e=t.factor,n=S(t)/e,r=t.context;r.textAlign=F[t.getValue("text-anchor")]||F.middle,r.textBaseline=t.getValue("text-baseline")||Y,r.fillText(t.textContent||"",e*V(t.attrs.get("dx")||0,n),e*(V(t.attrs.get("dy")||0,n)-2))};R.set("circle",W),R.set("line",D),R.set("path",J),R.set("rect",U),R.set("text",K),R.set("linearGradient",!1),R.set("radialGradient",!1),t.selectCanvas=w,t.resolution=z,t.getSize=V,t.canvasVersion=M,Object.defineProperty(t,"__esModule",{value:!0})});