// https://github.com/quantmind/d3-canvas-transition Version 0.3.3. Copyright 2017 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-collection"),require("d3-color"),require("d3-timer")):"function"==typeof define&&define.amd?define("d3-canvas-transition",["exports","d3-selection","d3-collection","d3-color","d3-timer"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,i,r){"use strict";function o(t){var e=I[t.tagName];return e?e(t):{x:0,y:0,width:t.context.canvas.width,height:t.context.canvas.height}}function s(t,e,n){if(e&&"none"!==e){if("string"==typeof e&&"url("===e.substring(0,4)){var r=e.substring(4,e.length-1),o=w(t.rootNode).select(r).node();return o?c(t,o,n):null}if(!n&&0!==n)return e;var s=i.color(e);if(s)return s.opacity=n,""+s}}function a(t){this.node=t}function c(t,e,n){var i=R[e.tagName];if(i)return i(t,e,n)}function u(){return new h}function h(){this._head=null,this._tail=null,this._length=0,Object.defineProperty(this,"length",{get:function(){return this._length}})}function f(t,e){var n=t.rootNode;n._touches||(n._touches=0),n._touches+=e,n._touches&&!n._scheduled&&(n._scheduled=r.timeout(d(n)))}function l(t,e){var n=t.countNodes,i=B.get(t.tagName),r=t.factor,o=t.attrs;if(i!==!1)if(t.attrs){var a,c,u,h=t.context;h.save(),void 0!==o.$opacity&&(h.globalAlpha=+o.$opacity),o["$stroke-linecap"]&&(h.lineCap=o["$stroke-linecap"]),o["$stroke-linejoin"]&&(h.lineJoin=o["$stroke-linejoin"]),G(t),a=s(t,t.getValue("stroke"),t.getValue("stroke-opacity")),a&&(h.strokeStyle=a),void 0!==o["$stroke-width"]&&(u=E(t.attrs["$stroke-width"]),u&&(h.lineWidth=r*u)),a=0!==u,c=s(t,t.getValue("fill"),t.getValue("fill-opacity")),c&&(h.fillStyle=c),i&&i(t,a,c,e),n&&t.each(function(t){return l(t,e)}),h.restore()}else n&&t.each(function(t){return l(t,e)})}function d(t,e,n){return function(){if(t._scheduled||n){var i=t.context;return t._touches=0,i.beginPath(),i.closePath(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,i.canvas.width,i.canvas.height),e&&(e.nodes=[]),l(t,e),t._scheduled=!1,f(t,0),e?e.nodes:null}}}function g(t){this.node=t,this.context=t.context,this.current=t}function v(t){var e=this.getContext("2d"),n=e._rootElement;n&&y(n,t)}function p(t){var e=this.getContext("2d"),n=e._rootElement;if(n){t.canvasPoint={x:n.factor*t.offsetX,y:n.factor*t.offsetY};var i=d(n,t.canvasPoint,!0)(),r="mousemove"===t.type?_:x;r(e,i,t)}}function x(t,e,n){for(var i=e.length-1;i>=0&&!y(e[i],n);--i);}function _(t,e,n){var i,r,o=t._activeNodes,s=[],a=e.length?e[e.length-1]:null;if(o)for(r=0;r<o.length;++r)i=o[r],a&&i!==a&&i.parentNode===a.parentNode?y(i,n,"mouseleave"):e.indexOf(i)>-1?(s.push(i),y(i,n,"mousemove")):y(i,n,"mouseleave");t._activeNodes=o=s,o.indexOf(a)===-1&&(o.push(a),y(a,n,"mouseenter"))}function y(t,e,n){var i=t.events[n||e.type];if(i){for(var r=0;r<i.length;++r)i[r].call(t,e);return t}}function m(t,e){var n,i={},r="";Object.defineProperties(this,{context:{get:function(){return e}},deque:{get:function(){return n||(n=u()),n}},events:{get:function(){return i}},tagName:{get:function(){return t}},childNodes:{get:function(){return n?n.list():[]}},firstChild:{get:function(){return n?n._head:null}},lastChild:{get:function(){return n?n._tail:null}},parentNode:{get:function(){return this._parent}},previousSibling:{get:function(){return this._prev}},nextSibling:{get:function(){return this._next}},namespaceURI:{get:function(){return W}},textContent:{get:function(){return r},set:function(t){r=""+t,f(this,1)}},clientLeft:{get:function(){return e.canvas.clientLeft}},clientTop:{get:function(){return e.canvas.clientTop}},clientWidth:{get:function(){return e.canvas.clientWidth}},clientHeight:{get:function(){return e.canvas.clientHeight}},rootNode:{get:function(){return this.context._rootElement}},countNodes:{get:function(){return n?n._length:0}},factor:{get:function(){return this.context._factor}}})}function b(t,e,n){for(var i,r,o,s,a,c=t.split(" "),u=new g(e),h=u.next(),f=0;f<c.length;++f)t=c[f],"*"===t?t={}:(t.indexOf("#")>-1?(r=t.split("#"),o=r[0],s=r[1]):t.indexOf(".")>-1?(r=t.split("."),o=r[0],i=r.splice(1).join(" ")):o=t,t={tag:o,id:s,classes:i}),c[f]=t;for(;h;){for(var l=0;l<c.length;++l)if(a=c[l],!(a.tag&&h.tagName!==a.tag||a.id&&h.id!==a.id||a.classes&&h.class!==a.classes)){if(n){n.push(h);break}return h}h=u.next()}return n}function P(t,e){return function(){t.apply(this,e)}}function w(t,n){var i=e.selection();return t?C(t)&&1===arguments.length?i.select(function(){return t}):"string"!=typeof t||(t=e.select(t).node())?(t.getContext&&(t=t.getContext("2d")),t._rootElement||(n||(n=D||H()),t._factor=n,t._rootElement=new m("canvas",t)),i.select(function(){return t._rootElement})):i:i}function N(t,e){if(arguments.length>1){var n,i=this._parents[0]||this.node();C(i)&&"function"==typeof e.context&&(n=e.pathObject,n||(e.context(T(i.context,i.factor)),n=J(e,i.factor),e.pathObject=n),arguments[1]=n)}return U.apply(this,arguments)}function C(t){return t instanceof m}function O(t){var e=this,n=e.node();if("CANVAS"!==n.tagName||C(n)||(e=w(n),n=e.node()),C(n)&&t){var i=n.context,r=n.factor,o=i.canvas.width,s=i.canvas.height;i.beginPath(),i.closePath(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,o,s),r>1&&(i.canvas.style.width=o+"px",i.canvas.style.height=s+"px",i.canvas.width=o*r,i.canvas.height=s*r,i.scale(r,r))}return e}function j(t){return 1===arguments.length?(D=t,this):this.factor}function k(){var t=this.node();if(C(t)){var e=t.rootNode;e===t?d(t)():(e._scheduled&&(e._scheduled=null,e._touches=0),l(t))}return this}function T(t,e){return 1===e?t:new S(t,e)}function S(t,e){this._context=t,this._factor=1,this._f=e}function V(t,e){var n,i,r,o,s,a,c,u,h=t.length,f=new Array(h);for(i=0;i<h;i++)n=i-1,r=i+1,n<0&&(n=h-1),r===h&&(r=0),o=t[n],s=t[i],a=t[r],c=$(o[0],o[1],s[0],s[1],e,!1),u=$(s[0],s[1],a[0],a[1],e,!0),f[i]=[c[0],c[1],s[0],s[1],u[0],u[1]];return f}function $(t,e,n,i,r,o){var s=Math.sqrt(Math.pow(n-t,2)+Math.pow(i-e,2)),a=o?r/s:(s-r)/s;return[t+a*(n-t),e+a*(i-e)]}function q(t,e){if(1===e)return t;var n,i=0,r="";for(t+="";n=Z.exec(t);)r+=t.substring(i,n.index)+e*n[0],i=n.index+n[0].length;return r+t.substring(i)}function A(t){for(var e=[],n=0,i=void 0,r=void 0,o=void 0,s=0;s<nt.length;++s)i=nt[s],r=t.getValue("font-"+i),r&&("size"===i?(n=t.factor*E(r),r=n+"px"):"family"===i&&(o=r),e.push(r));return n&&(o||e.push("sans serif"),t.context.font=e.join(" ")),n}var E=function(t,e){if("string"==typeof t){if("px"===t.substring(t.length-2))return+t.substring(0,t.length-2);if("%"===t.substring(t.length-1))return.01*t.substring(0,t.length-1)*(e||1);if("em"===t.substring(t.length-2))return t.substring(0,t.length-2)*(e||1)}else if("number"==typeof t)return t},I={},R={linearGradient:function(t,e,n){var r,s=e.context,a=o(t),c=E(e.attrs.get("x1")||"0%",a.width),u=E(e.attrs.get("x2")||"100%",a.width),h=E(e.attrs.get("y1")||"0%",a.height),f=E(e.attrs.get("y2")||"0%",a.height),l=s.createLinearGradient(c,h,u,f);return e.each(function(t){r=i.color(t.attrs.get("stop-color")),(n||0===n)&&(r.opacity=n),l.addColorStop(E(t.attrs.get("offset")),""+r)}),l},radialGradient:function(t,e,n){var r,s=e.context,a=o(t),c=E(e.attrs.get("cx")||"50%",a.width),u=E(e.attrs.get("cy")||"50%",a.height),h=E(e.attrs.get("fx")||c,a.width),f=E(e.attrs.get("fy")||u,a.height),l=E(e.attrs.get("r")||"50%",Math.max(a.height,a.width)),d=s.createRadialGradient(a.x+h,a.y+f,0,a.x+c,a.y+u,l);return e.each(function(t){r=i.color(t.attrs.get("stop-color")),(n||0===n)&&(r.opacity=n),d.addColorStop(E(t.attrs.get("offset")),""+r)}),d}};a.prototype={getPropertyValue:function(t){var e=this.node.getValue(t);return void 0===e&&(e=window.getComputedStyle(this.node.context.canvas).getPropertyValue(t)),e}};var L=function(t,e,n){var i=t.attrs.get(e);return i!==n&&(t.attrs.set(e,n),!0)};h.prototype=u.prototype={prepend:function(t,e){this._length?e?(t._prev=e._prev,t._next=e,e._prev&&(e._prev._next=t),e._prev=t):(t._prev=this._tail,t._next=null,this._tail._next=t):(t._prev=null,t._next=null),t._prev||(this._head=t),t._next||(this._tail=t),this._length++},remove:function(t){t._prev&&(t._prev._next=t._next),t._next&&(t._next._prev=t._prev),this._head===t&&(this._head=t._next),this._tail===t&&(this._tail=t._prev),delete t._prev,delete t._next,this._length--},list:function t(){for(var e=this._head,t=[];e;)t.push(e),e=e._next;return t},each:function(t){for(var e=this._head;e;)t(e),e=e._next}};var M=Math.PI/180,G=function(t){var e,n,i,r=+(t.attrs.get("x")||0),o=+(t.attrs.get("y")||0),s=t.attrs.get("transform"),a=t.context;if("string"==typeof s){var c,u,h,f=s.indexOf("translate(");f>-1&&(u=s.substring(f+10),c=u.indexOf(")"),h=u.substring(0,c).split(","),r+=+h[0],2===h.length&&(o+=+h[1])),f=s.indexOf("rotate("),f>-1&&(u=s.substring(f+7),i=+u.substring(0,u.indexOf(")"))),f=s.indexOf("scale("),f>-1&&(u=s.substring(f+6),c=u.indexOf(")"),h=u.substring(0,c).split(","),e=+h[0],2===h.length&&(n=+h[1]))}else s&&(r+=s.x,o+=s.y,e=s.k);e&&(n=n||e,a.scale(e,n)),(r||o)&&a.translate(a._factor*r,a._factor*o),i&&i===i&&a.rotate(M*i)},B=n.map();g.prototype={next:function(){var t=this.current;if(!t)return null;if(t.firstChild)t=t.firstChild;else for(;t;){if(t.nextSibling){t=t.nextSibling;break}t=t.parentNode,t===this.node&&(t=null)}return this.current=t,t}};var z={mouseenter:"mousemove",mouseleave:"mousemove"},W="canvas";m.prototype={querySelectorAll:function(t){return this.countNodes?b(t,this,[]):[]},querySelector:function(t){if(this.countNodes)return b(t,this)},createElementNS:function(t,e){return new m(e,this.context)},hasChildNodes:function(){return this.countNodes>0},contains:function(t){for(;t;){if(t._parent==this)return!0;t=t._parent}return!1},appendChild:function(t){return this.insertBefore(t)},insertBefore:function(t,e){if(t===this)throw Error("inserting self into children");if(!(t instanceof m))throw Error("Cannot insert a non canvas element into a canvas element");return t._parent&&t._parent.removeChild(t),this.deque.prepend(t,e),t._parent=this,f(this,1),t},removeChild:function(t){if(t._parent===this)return delete t._parent,this.deque.remove(t),f(this,1),t},setAttribute:function(t,e){"class"===t?this.class=e:"id"===t?this.id=e:(this.attrs||(this.attrs=n.map()),L(this,t,e)&&f(this,1))},removeAttribute:function(t){this.attrs&&(this.attrs.remove(t),f(this,1))},getAttribute:function(t){var e=this.attrs?this.attrs.get(t):void 0;return void 0!==e||this._parent||(e=this.context.canvas[t]),e},addEventListener:function(t,e){var n=this.context.canvas;this.rootNode===this?(arguments[1]=v,n.addEventListener.apply(n,arguments)):(arguments[0]=z[t]||t,arguments[1]=p,n.addEventListener.apply(n,arguments));var i=this.events[t];i||(this.events[t]=i=[]),i.indexOf(e)===-1&&i.push(e)},removeEventListener:function(t,e){var n=this.events[t];if(n){var i=n.indexOf(e);i>-1&&n.splice(i,1)}},getBoundingClientRect:function(){return this.context.canvas.getBoundingClientRect()},each:function(t){this.countNodes&&this.deque.each(t)},getValue:function(t){var e=this.getAttribute(t);return void 0===e&&this._parent?this._parent.getValue(t):e},removeProperty:function(t){this.removeAttribute(t)},setProperty:function(t,e){this.setAttribute(t,e)},getProperty:function(t){return this.getAttribute(t)},getPropertyValue:function(t){return this.getAttribute(t)},getComputedStyle:function(t){return new a(t)},get ownerDocument(){return this},get style(){return this},get defaultView(){return this},get document(){return this.rootNode}};var D,H=function(t){return t||window.devicePixelRatio||1},J=function(t){function e(){return P(t,arguments)}return e},U=e.selection.prototype.attr;e.selection.prototype.attr=N,e.selection.prototype.canvas=O,e.selection.prototype.canvasResolution=j,e.selection.prototype.draw=k,S.prototype={beginPath:function(){this._context.beginPath()},closePath:function(){this._context.closePath()},moveTo:function(t,e){this._context.moveTo(this._f*t,this._f*e)},lineTo:function(t,e){this._context.lineTo(this._f*t,this._f*e)},arc:function(){arguments[0]=this._f*arguments[0],arguments[1]=this._f*arguments[1],arguments[2]=this._f*arguments[2],this._context.arc.apply(this._context,arguments)},rect:function(t,e,n,i){this._context.rect(this._f*t,this._f*e,this._f*n,this._f*i)},quadraticCurveTo:function(t,e,n,i){this._context.quadraticCurveTo(this._f*t,this._f*e,this._f*n,this._f*i)}};var X=function(t,e,n){n>0&&(e=V(e,n));var i,r,o=e.length;for(t.beginPath(),i=0;i<o;i++)r=e[i],0===i?t.moveTo(r[0],r[1]):t.lineTo(r[0],r[1]),n>0&&t.quadraticCurveTo(r[2],r[3],r[4],r[5]);t.closePath()},Y="0.3.3",F=2*Math.PI,K=function(t,e,n,i){var r=t.attrs,o=t.context,s=t.factor;o.beginPath(),o.arc(s*(r.$cx||0),s*(r.$cy||0),s*(r.$r||0),0,F),o.closePath(),e&&o.stroke(),n&&o.fill(),i&&o.isPointInPath(i.x,i.y)&&i.nodes.push(t)};I.circle=function(t){var e=t.factor*(t.attrs.get("r")||0);return{x:t.factor*(t.attrs.get("cx")||0)-e,y:t.factor*(t.attrs.get("cy")||0)-e,width:2*e,height:2*e}};var Q=function(t,e,n,i){var r=t.attrs,o=t.factor,s=t.context;s.beginPath(),s.moveTo(o*(r.$x1||0),o*(r.$y1||0)),s.lineTo(o*r.$x2,o*r.$y2),e&&s.stroke(),i&&s.isPointInPath(i.x,i.y)&&i.nodes.push(t)},Z=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,tt=function(t,e,n,i){var r=t.attrs.get("d"),o=t.context;if(r)if("function"==typeof r)o.beginPath(),r(t),e&&o.stroke(),n&&o.fill(),i&&o.isPointInPath(i.x,i.y)&&i.nodes.push(t);else if(window.Path2D){var s=window.Path2D,a=new s(q(r,t.factor));e&&o.stroke(a),n&&o.fill(a),i&&o.isPointInPath(a,i.x,i.y)&&i.nodes.push(t)}},et=function(t,e,n,i){var r=t.attrs,o=t.context,s=o._factor,a=r.get("rx")||0,c=r.get("height")||0,u=r.get("width")||0;u&&c&&c!==u&&o.scale(1,c/u),a?X(o,[[0,0],[s*u,0],[s*u,s*u],[0,s*u]],s*a):(o.beginPath(),o.rect(0,0,s*u,s*u),o.closePath()),e&&o.stroke(),n&&o.fill(),i&&o.isPointInPath(i.x,i.y)&&i.nodes.push(t)};I.rect=function(t){var e=t.factor*(t.attrs.get("width")||0);return{x:0,y:0,height:e,width:e}};var nt=["style","variant","weight","size","family"],it="middle",rt={start:"start",middle:"center",end:"end"},ot=function(t){var e=t.factor,n=A(t)/e,i=t.context;i.textAlign=rt[t.getValue("text-anchor")]||rt.middle,i.textBaseline=t.getValue("text-baseline")||it,i.fillText(t.textContent||"",e*E(t.attrs.get("dx")||0,n),e*(E(t.attrs.get("dy")||0,n)-2))};B.set("circle",K),B.set("line",Q),B.set("path",tt),B.set("rect",et),B.set("text",ot),B.set("linearGradient",!1),B.set("radialGradient",!1),t.selectCanvas=w,t.resolution=H,t.getSize=E,t.canvasPolygon=X,t.canvasVersion=Y,Object.defineProperty(t,"__esModule",{value:!0})});