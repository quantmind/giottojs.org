// https://github.com/quantmind/d3-canvas-transition Version 0.2.7. Copyright 2016 quantmind.com.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-collection"),require("d3-color"),require("d3-timer")):"function"==typeof define&&define.amd?define("d3-canvas-transition",["exports","d3-selection","d3-collection","d3-color","d3-timer"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,r,i){"use strict";function o(t){var e=t.context,n=a(t,t.attrs.get("stroke"),t.getValue("stroke-opacity")),r=k(t.attrs.get("stroke-width"));return r&&(e.lineWidth=2*t.factor*r),n&&(e.strokeStyle=n),0!==r}function s(t){var e=t.context,n=a(t,t.attrs.get("fill"),t.getValue("fill-opacity"));return n&&(e.fillStyle=n),n}function a(t,e,n){if(e&&"none"!==e){if("string"==typeof e&&"url("===e.substring(0,4)){var i=e.substring(4,e.length-1);return t=P(t.rootNode).select(i).node(),t?u(t,n):null}var o=r.color(e);if(o)return(n||0===n)&&(o.opacity=n),""+o}}function c(t){this.node=t}function u(t,e){var n=S[t.tagName];if(n)return n(t,e)}function f(){return new l}function l(){this._head=null,this._tail=null,this._length=0,Object.defineProperty(this,"length",{get:function(){return this._length}})}function h(t,e){var n=t.rootNode;n._touches||(n._touches=0),n._touches+=e,n._touches&&!n._scheduled&&(n._scheduled=i.timeout(g(n)))}function d(t,e){var n=t.countNodes,r=E.get(t.tagName);if(r!==!1)if(t.attrs){var i,a,c=t.context;c.save(),V.each(function(e){return e(t)}),i=o(t),a=s(t),r&&r(t,i,a,e),n&&t.each(function(t){return d(t,e)}),c.restore()}else n&&t.each(function(t){return d(t,e)})}function g(t,e){return function(){var n=t.context;return t._touches=0,n.beginPath(),n.closePath(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,n.canvas.width,n.canvas.height),e&&(e.nodes=[]),d(t,e),t._scheduled=!1,h(t,0),e?e.nodes:null}}function v(t){this.node=t,this.current=t}function p(t,e,n){for(var r=e.length-1;r>=0&&!_(e[r],n);--r);}function x(t,e,n){var r,i,o=t._activeNodes,s=[],a=e.length?e[e.length-1]:null;if(o)for(i=0;i<o.length;++i)r=o[i],a&&r!==a&&r.parentNode===a.parentNode?_(r,n,"mouseleave"):e.indexOf(r)>-1?s.push(r):_(r,n,"mouseleave");for(t._activeNodes=o=s,i=0;i<e.length;++i)r=e[i],o.indexOf(r)>-1?_(r,n,"mouseover"):r!==a&&r.parentNode===a.parentNode||(o.push(r),_(r,n,"mouseenter"))}function _(t,e,n){var r=t.events[n||e.type];if(r){for(var i=0;i<r.length;++i)r[i].call(t,e);return t}}function y(t,e){var n,r={},i="";Object.defineProperties(this,{context:{get:function(){return e}},deque:{get:function(){return n||(n=f()),n}},events:{get:function(){return r}},tagName:{get:function(){return t}},childNodes:{get:function(){return n?n.list():[]}},firstChild:{get:function(){return n?n._head:null}},lastChild:{get:function(){return n?n._tail:null}},parentNode:{get:function(){return this._parent}},previousSibling:{get:function(){return this._prev}},nextSibling:{get:function(){return this._next}},namespaceURI:{get:function(){return R}},textContent:{get:function(){return i},set:function(t){i=""+t,h(this,1)}},clientLeft:{get:function(){return e.canvas.clientLeft}},clientTop:{get:function(){return e.canvas.clientTop}},clientWidth:{get:function(){return e.canvas.clientWidth}},clientHeight:{get:function(){return e.canvas.clientHeight}},rootNode:{get:function(){return this.context._rootElement}},countNodes:{get:function(){return n?n._length:0}},factor:{get:function(){return this.context._factor}}})}function m(t,e,n){for(var r,i,o,s,a,c=t.split(" "),u=new v(e),f=u.next(),l=0;l<c.length;++l)t=c[l],"*"===t?t={}:(t.indexOf("#")>-1?(i=t.split("#"),o=i[0],s=i[1]):t.indexOf(".")>-1?(i=t.split("."),o=i[0],r=i.splice(1).join(" ")):o=t,t={tag:o,id:s,classes:r}),c[l]=t;for(;f;){for(var h=0;h<c.length;++h)if(a=c[h],!(a.tag&&f.tagName!==a.tag||a.id&&f.id!==a.id||a.classes&&f.class!==a.classes)){if(n){n.push(f);break}return f}f=u.next()}return n}function b(t,e){return function(){t.apply(this,e)}}function P(t,n){var r=e.selection();return t?w(t)&&1===arguments.length?r.select(function(){return t}):"string"!=typeof t||(t=e.select(t).node())?(t.getContext&&(t=t.getContext("2d")),t._rootElement||(n||(n=T||z()),t._factor=n,t._rootElement=new y("canvas",t)),r.select(function(){return t._rootElement})):r:r}function N(t,e){if(arguments.length>1){var n,r=this._parents[0]||this.node();w(r)&&"function"==typeof e.context&&(n=e.pathObject,n||(e.context(r.context),n=L(e,r.factor),e.pathObject=n),arguments[1]=n)}return B.apply(this,arguments)}function w(t){return t instanceof y}function C(t){var e=this,n=e.node();if("CANVAS"!==n.tagName||w(n)||(e=P(n),n=e.node()),w(n)&&t){var r=n.context,i=n.factor,o=r.canvas.width,s=r.canvas.height;r.beginPath(),r.closePath(),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,o,s),i>1&&(r.canvas.style.width=o+"px",r.canvas.style.height=s+"px",r.canvas.width=o*i,r.canvas.height=s*i,r.scale(i,i))}return e}function O(t){return 1===arguments.length?(T=t,this):this.factor}function j(t){for(var e=[],n=0,r=void 0,i=void 0,o=void 0,s=0;s<J.length;++s)r=J[s],i=t.getValue("font-"+r),i&&("size"===r?(n=t.factor*k(i),i=n+"px"):"family"===r&&(o=i),e.push(i));return n&&(o||e.push("sans serif"),t.context.font=e.join(" ")),n}var k=function(t,e){if("string"==typeof t){if("px"===t.substring(t.length-2))return+t.substring(0,t.length-2);if("%"===t.substring(t.length-1))return.01*t.substring(0,t.length-1)*(e||1);if("em"===t.substring(t.length-2))return t.substring(0,t.length-2)*(e||1)}else if("number"==typeof t)return t},S={linearGradient:function(t,e){var n,i=t.context,o=i.canvas,s=k(t.attrs.get("x1","0%"),o.width),a=k(t.attrs.get("x2","100%"),o.width),c=k(t.attrs.get("y1","0%"),o.height),u=k(t.attrs.get("y2","0%"),o.height),f=i.createLinearGradient(s,c,a,u);return t.each(function(t){n=r.color(t.attrs.get("stop-color")),(e||0===e)&&(n.opacity=e),f.addColorStop(k(t.attrs.get("offset")),""+n)}),f},radialGradient:function(){}};c.prototype={getPropertyValue:function(t){var e=this.node.getValue(t);return void 0===e&&(e=window.getComputedStyle(this.node.context.canvas).getPropertyValue(t)),e}};var A=function(t,e,n){var r=t.attrs.get(e);return r!==n&&(t.attrs.set(e,n),!0)};l.prototype=f.prototype={prepend:function(t,e){this._length?e?(t._prev=e._prev,t._next=e,e._prev&&(e._prev.next=t),e._prev=t):(t._prev=this._tail,t._next=null,this._tail._next=t):(t._prev=null,t._next=null),t._prev||(this._head=t),t._next||(this._tail=t),this._length++},remove:function(t){t._prev&&(t._prev._next=t._next),t._next&&(t._next._prev=t._prev),this._head===t&&(this._head=t._next),this._tail===t&&(this._tail=t._prev),delete t._prev,delete t._next,this._length--},list:function t(){for(var e=this._head,t=[];e;)t.push(e),e=e._next;return t},each:function(t){for(var e=this._head;e;)t(e),e=e._next}};var E=n.map(),V=n.map();v.prototype={next:function(){var t=this.current;if(!t)return null;if(t.firstChild)t=t.firstChild;else for(;t;){if(t.nextSibling){t=t.nextSibling;break}t=t.parentNode,t===this.node&&(t=null)}return this.current=t,t}};var q={mouseenter:"mousemove",mouseleave:"mousemove"},I=function(t){var e=this.getContext("2d"),n=e._rootElement;if(n){t.canvasPoint={x:n.factor*t.offsetX,y:n.factor*t.offsetY};var r=g(n,t.canvasPoint)(),i="mousemove"===t.type?x:p;i(e,r,t)}},R="canvas";y.prototype={querySelectorAll:function(t){return this.countNodes?m(t,this,[]):[]},querySelector:function(t){if(this.countNodes)return m(t,this)},createElementNS:function(t,e){return new y(e,this.context)},hasChildNodes:function(){return this.countNodes>0},contains:function(t){for(;t;){if(t._parent==this)return!0;t=t._parent}return!1},appendChild:function(t){return this.insertBefore(t)},insertBefore:function(t,e){if(t===this)throw Error("inserting self into children");if(!(t instanceof y))throw Error("Cannot insert a non canvas element into a canvas element");return t._parent&&t._parent.removeChild(t),this.deque.prepend(t,e),t._parent=this,h(this,1),t},removeChild:function(t){if(t._parent===this)return delete t._parent,this.deque.remove(t),h(this,1),t},setAttribute:function(t,e){"class"===t?this.class=e:"id"===t?this.id=e:(this.attrs||(this.attrs=n.map()),A(this,t,e)&&h(this,1))},removeAttribute:function(t){this.attrs&&(this.attrs.remove(t),h(this,1))},getAttribute:function(t){var e=this.attrs?this.attrs.get(t):void 0;return void 0!==e||this._parent||(e=this.context.canvas[t]),e},addEventListener:function(t,e){var n=this.context.canvas;arguments[0]=q[t]||t,arguments[1]=I,n.addEventListener.apply(n,arguments);var r=this.events[t];r||(this.events[t]=r=[]),r.indexOf(e)===-1&&r.push(e)},removeEventListener:function(t,e){var n=this.events[t];if(n){var r=n.indexOf(e);r>-1&&n.splice(r,1)}},getBoundingClientRect:function(){return this.context.canvas.getBoundingClientRect()},each:function(t){this.countNodes&&this.deque.each(t)},getValue:function(t){var e=this.getAttribute(t);return void 0===e&&this._parent?this._parent.getValue(t):e},removeProperty:function(t){this.removeAttribute(t)},setProperty:function(t,e){this.setAttribute(t,e)},getProperty:function(t){return this.getAttribute(t)},getPropertyValue:function(t){return this.getAttribute(t)},getComputedStyle:function(t){return new c(t)},get ownerDocument(){return this},get style(){return this},get defaultView(){return this},get document(){return this.rootNode}};var T,z=function(t){return t||window.devicePixelRatio||1},L=function(t,e){function n(){return b(t,arguments)}function r(t){return i*o(t)}var i=e*e,o=t.size();return t.size(r),n.size=function(t){return 0===arguments.length?r:(o=t,n)},n},B=e.selection.prototype.attr;e.selection.prototype.attr=N,e.selection.prototype.canvas=C,e.selection.prototype.canvasResolution=O;var G="0.2.7",M=function(t,e,n,r){var i=t.attrs,o=t.context,s=t.factor;o.beginPath(),o.arc(s*i.get("cx",0),s*i.get("cy",0),s*i.get("r",0),0,2*Math.PI),o.closePath(),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)},W=function(t,e,n,r){var i=t.attrs,o=t.context;o.moveTo(t.factor*(i.get("x1")||0),t.factor*(i.get("y1")||0)),o.beginPath(),o.lineTo(t.factor*i.get("x2"),t.factor*i.get("y2")),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)},D=function(t,e,n,r){var i=t.attrs.get("d"),o=t.context;if(i){var s;if("function"==typeof i)o.beginPath(),i(t),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t);else if(window.Path2D){var a=window.Path2D;s=new a(i),e&&o.stroke(s),n&&o.fill(s),r&&o.isPointInPath(s,r.x,r.y)&&r.nodes.push(t)}}},H=function(t,e,n,r){var i=t.attrs,o=t.context;o.beginPath(),o.rect(0,0,t.factor*(i.get("width")||0),t.factor*(i.get("height")||0)),o.closePath(),e&&o.stroke(),n&&o.fill(),r&&o.isPointInPath(r.x,r.y)&&r.nodes.push(t)},J=["style","variant","weight","size","family"],U="middle",X={start:"start",middle:"center",end:"end"},Y=function(t){var e=t.factor,n=j(t)/e,r=t.context;r.textAlign=X[t.getValue("text-anchor")]||X.middle,r.textBaseline=t.getValue("text-baseline")||U,r.fillText(t.textContent||"",e*k(t.attrs.get("dx")||0,n),e*k(t.attrs.get("dy")||0,n))},F=function(t){var e=t.attrs.get("opacity");void 0!==e&&(t.context.globalAlpha=+e),e=t.attrs.get("shape-rendering"),"crispEdges"===e&&(t.context.imageSmoothingEnabled=!1)},K=function(t){var e,n,r=+(t.attrs.get("x")||0),i=+(t.attrs.get("y")||0),o=t.attrs.get("transform"),s=t.context;if("string"==typeof o){var a,c,u,f=o.indexOf("translate(");if(f>-1&&(c=o.substring(f+10),a=c.indexOf(")"),u=c.substring(0,a).split(","),r+=+u[0],2===u.length&&(i+=+u[1])),f=o.indexOf("rotate("),f>-1){c=o.substring(f+7);var l=+c.substring(0,c.indexOf(")"));l===l&&s.rotate(l*Math.PI/180)}}else o&&(r+=o.x,i+=o.y,e=o.k);(r||i)&&s.translate(t.factor*r,t.factor*i),e&&(n=n||e,s.scale(e,n))},Q=function(t){var e=t.attrs.get("stroke-linecap");e&&(t.context.lineCap=e)},Z=function(t){var e=t.attrs.get("stroke-linejoin");e&&(t.context.lineJoin=e)};E.set("circle",M),E.set("line",W),E.set("path",D),E.set("rect",H),E.set("text",Y),E.set("linearGradient",!1),E.set("radialGradient",!1),V.set("opacity",F),V.set("stroke-linecap",Q),V.set("stroke-linejoin",Z),V.set("transform",K),t.selectCanvas=P,t.resolution=z,t.getSize=k,t.canvasVersion=G,Object.defineProperty(t,"__esModule",{value:!0})});